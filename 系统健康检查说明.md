# 系统健康检查说明

## 快速检查

运行系统健康检查脚本：

```bash
cd /var/www/yuantong
./check_system_health.sh
```

或者直接运行Python脚本（需要先激活虚拟环境）：

```bash
cd /var/www/yuantong
source venv/bin/activate
python3 check_system_health.py
```

## 检查内容

脚本会检查以下内容：

### 1. Django服务检查
- ✅ Django服务状态（systemd）
- ✅ 端口8000监听状态
- ✅ Gunicorn进程运行状态
- ✅ HTTP响应测试

### 2. Celery服务检查
- ✅ Celery Beat进程状态
- ✅ Celery Worker进程状态
- ✅ 定时任务配置情况

### 3. 数据库检查
- ✅ 数据库连接状态
- ✅ 数据库名称和引擎信息

### 4. 环境变量检查
- ✅ 企业微信相关配置
- ✅ Django密钥配置

### 5. 日志文件检查
- ✅ 日志文件是否存在
- ✅ 日志文件大小
- ✅ 日志文件最后修改时间

### 6. 磁盘空间检查
- ✅ 磁盘使用率
- ✅ 可用空间

### 7. 最近错误检查
- ✅ 检查最近的错误日志
- ✅ 显示最近的错误信息

## 检查结果说明

### ✅ 正常状态
所有关键服务运行正常，系统可以正常使用。

### ⚠️ 警告状态
部分服务存在问题，但不影响基本功能。建议：
- 查看详细的错误信息
- 检查相关服务的日志
- 根据提示进行修复

### ❌ 错误状态
关键服务存在问题，需要立即处理：
- 根据错误信息进行修复
- 重启相关服务
- 检查配置文件

## 常见问题处理

### Django服务未运行
```bash
sudo systemctl start yuantong-django
sudo systemctl status yuantong-django
```

### Celery Beat未运行
```bash
cd /var/www/yuantong
source venv/bin/activate
celery -A yuantong beat -l info --logfile=logs/celery_beat.log --pidfile=logs/celery_beat.pid --detach
```

### Celery Worker未运行
```bash
cd /var/www/yuantong
source venv/bin/activate
celery -A yuantong worker -l info --logfile=logs/celery_worker.log --pidfile=logs/celery_worker.pid --concurrency=3 -Q default
```

### 数据库连接失败
- 检查数据库服务是否运行
- 检查数据库配置是否正确
- 检查网络连接

### 环境变量未设置
检查 `.env` 文件或环境变量配置，确保所有必需的环境变量都已设置。

## 定期检查

建议定期运行健康检查：
- 每天检查一次
- 部署新代码后检查
- 发现问题时检查

可以添加到crontab中自动检查：

```bash
# 每天上午9点检查系统健康
0 9 * * * cd /var/www/yuantong && ./check_system_health.sh >> logs/health_check.log 2>&1
```

## 日志位置

检查脚本的输出会显示在终端，也可以重定向到文件：

```bash
./check_system_health.sh > logs/health_check_$(date +%Y%m%d).log 2>&1
```


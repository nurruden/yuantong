{% extends 'base.html' %}

{% block head_extra %}
<style>
#permission-modal.hidden {
    all: initial;
    display: none !important;
}
#permission-modal {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: fixed !important;
    left: 0 !important;
    top: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    min-height: 100vh !important;
    z-index: 9999 !important;
    background: rgba(0,0,0,0.3) !important;
    margin: 0 !important;
    padding: 0 !important;
}

.permission-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.permission-table th, .permission-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
.permission-table th { background: #f4f4f4; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>权限配置</h2>
    <div id="permission-app">
    <table class="permission-table">
        <thead>
            <tr>
                <th>菜单路径</th>
                <th>有权限用户</th>
            </tr>
        </thead>
        <tbody id="permission-tbody">
            {% for menu in menu_items %}
                <tr style="background:#f7f7f7;font-weight:bold;">
                    <td>{{ menu.name }}</td>
                    <td>
    <div class="perm-display" data-menu="{{ menu.name }}">
        <span class="perm-users"></span>
        <button class="btn btn-sm btn-secondary edit-btn" data-menu="{{ menu.name }}">编辑</button>
    </div>
</td>
                </tr>
                {% for item in menu.children %}
                    <tr>
                        <td style="padding-left:2em;">{{ menu.name }} / {{ item.name }}</td>
<td>
    <div class="perm-display" data-menu="{{ menu.name }}" data-submenu="{{ item.name }}">
        <span class="perm-users"></span>
        <button class="btn btn-sm btn-secondary edit-btn" data-menu="{{ menu.name }}" data-submenu="{{ item.name }}">编辑</button>
    </div>
</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="savePermissions()">保存配置</button>
</div>
</div>
<!-- 权限弹窗放在页面底部，确保在body内 -->
<div id="permission-modal" class="permission-modal hidden">
    <div class="modal-content">
        <div class="modal-header"><b>编辑菜单权限</b></div>
        <div class="modal-body">
            <div class="user-listbox">
                <div class="user-listbox-title">未有权限用户</div>
                <ul id="modal-user-list-left"></ul>
            </div>
            <div style="display:flex; flex-direction:column; justify-content:center; gap:12px;">
                <button class="btn btn-sm btn-outline-primary" onclick="moveSelected('left')">&gt;&gt;</button>
                <button class="btn btn-sm btn-outline-primary" onclick="moveSelected('right')">&lt;&lt;</button>
            </div>
            <div class="user-listbox">
                <div class="user-listbox-title">有权限用户</div>
                <ul id="modal-user-list-right"></ul>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveModalPermission()">保存</button>
            <button class="btn btn-light" onclick="closePermissionModal()">取消</button>
        </div>
    </div>
</div>
{% endblock %}

<!-- 权限弹窗和脚本放在block content之后，确保模板结构正确 -->
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
.permission-modal {
    display: flex;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    min-height: 100vh;
    height: 100vh !important;
    box-sizing: border-box;
    background: rgba(0,0,0,0.3);
    align-items: center;
    justify-content: center;
    margin: 0 !important;
    padding: 0 !important;
}
/* 一定要放在 .permission-modal 后面，保证覆盖 */
.permission-modal.hidden,
.permission-modal.hidden * {
    display: none !important;
}

#permission-modal.hidden {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    z-index: -1 !important;
}
#permission-modal.hidden * {
    display: none !important;
}
body .permission-modal .modal-content,
body .permission-modal .modal-content:before,
body .permission-modal .modal-content:after {
    margin: 0 !important;
}
.permission-modal .modal-content {
    background: #fff;
    width: 600px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    padding: 24px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}
.permission-modal .modal-body { display: flex; gap: 24px; }
.permission-modal .user-listbox { width: 220px; min-height: 240px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; overflow-y: auto; }
.permission-modal .user-listbox ul { list-style: none; margin: 0; padding: 0; }
.permission-modal .user-listbox li { margin: 2px 0; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
.permission-modal .user-listbox li.selected { background: #e6f7ff; }
.permission-modal .modal-actions { text-align: right; margin-top: 20px; }
.permission-modal .user-listbox-title { font-weight: bold; margin-bottom: 8px; }
</style>

<!-- 权限弹窗和脚本移到block content外部，避免endblock错误 -->




{% block scripts %}
<script>
// 页面初始化强制隐藏弹窗，防止初始显示
window.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('permission-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
        console.log('[调试] 页面初始化强制隐藏弹窗');
    }
});
console.log('[调试] 页面加载时 permission-app:', document.getElementById('permission-app'));
console.log('[调试] 页面加载时 permission-modal:', document.getElementById('permission-modal'));
function ensurePermissionModalReady(cb) {
    let tryCount = 0;
    function check() {
        if (
            document.getElementById('permission-app') &&
            document.getElementById('permission-modal') &&
            document.getElementById('modal-user-list-left') &&
            document.getElementById('modal-user-list-right')
        ) {
            console.log('[调试] ensurePermissionModalReady: 所有DOM已就绪');
            cb();
        } else {
            tryCount++;
            if (tryCount > 100) {
                console.error('[调试] ensurePermissionModalReady: DOM等待超时, 检查HTML结构');
                alert('权限页面JS初始化失败，请检查HTML结构和ID命名');
                return;
            }
            setTimeout(check, 50);
        }
    }
    check();
}

console.log('[调试] 权限设置脚本开始加载');
ensurePermissionModalReady(function() {
    console.log('[调试] 权限JS初始化完成');
    // 事件委托绑定所有编辑按钮
    const permApp = document.getElementById('permission-app');
    if (permApp) {
        console.log('[调试] 找到 permission-app 元素，准备绑定事件');
        permApp.addEventListener('click', function(e) {
            console.log('[调试] 捕获 click 事件', e.target);
            if (e.target && e.target.classList && e.target.classList.contains('edit-btn')) {
                const menu = e.target.getAttribute('data-menu');
                const submenu = e.target.getAttribute('data-submenu');
                console.log('[调试] 点击了编辑按钮', menu, submenu);
                editPermission(e.target, menu, submenu);
            }
        });
        console.log('[调试] 已绑定事件委托');
    } else {
        console.error('[调试] 未找到 permission-app 元素，事件委托失败');
    }

// 全局错误捕获
window.onerror = function(msg, url, line, col, error) {
    alert('JS错误: ' + msg + ' @' + line + ':' + col);
    console.error('JS错误:', msg, url, line, col, error);
};
let permissions = [];
let wechatUsers = [];
let modalMenu = null, modalSubmenu = null, modalPage = null;
let modalLeftUsers = [], modalRightUsers = [], modalSelectedLeft = [], modalSelectedRight = [];
console.log('[调试] 权限JS变量已初始化');

function showPermissionModal() {
    console.log('调用 showPermissionModal');
    document.getElementById('permission-modal').classList.remove('hidden');
}

function hidePermissionModal() {
    document.getElementById('permission-modal').style.display = 'none';
}

function fetchPermissions() {
    fetch('/api/permissions/').then(res => res.json()).then(data => {
        permissions = data.permissions || [];
        renderPermissionUsers();
    });
}

function fetchWeChatUsers() {
    fetch('/api/wechat_users/').then(res => res.json()).then(data => {
        console.log('[调试] 拉取到企业微信用户', data);
        wechatUsers = data.users || [];
        renderPermissionUsers();
    });
}

function renderPermissionUsers() {
    document.querySelectorAll('.perm-display').forEach(div => {
        const menu = div.getAttribute('data-menu');
        const submenu = div.getAttribute('data-submenu');
        const page = submenu ? (menu + ' / ' + submenu) : menu;
        const perm = permissions.find(p => p.page === page);
        const span = div.querySelector('.perm-users');
        if (perm && perm.users.length) {
            span.textContent = perm.users.map(uid => {
                const u = wechatUsers.find(wu => wu.userid === uid);
                return u ? (u.name || u.userid) : uid;
            }).join(', ');
        } else {
            span.textContent = '无';
        }
    });
}

function editPermission(btn, menu, submenu) {
    console.log('[调试] 调用 editPermission', btn, menu, submenu);
    modalMenu = menu; modalSubmenu = submenu || null;
    modalPage = modalSubmenu ? (modalMenu + ' / ' + modalSubmenu) : modalMenu;
    let perm = permissions.find(p => p.page === modalPage);
    const rightUsers = perm ? perm.users.slice() : [];
    const leftUsers = wechatUsers.map(u => u.userid).filter(uid => !rightUsers.includes(uid));
    modalLeftUsers = leftUsers;
    modalRightUsers = rightUsers;
    modalSelectedLeft = [];
    modalSelectedRight = [];
    renderModalUserLists();
    showPermissionModal();
}
window.editPermission = editPermission;

function renderModalUserLists() {
    console.log('[调试] modalLeftUsers', modalLeftUsers);
    console.log('[调试] wechatUsers', wechatUsers);
    // 健壮性判断
    const ulLeft = document.getElementById('modal-user-list-left');
    const ulRight = document.getElementById('modal-user-list-right');
    if (!ulLeft || !ulRight) {
        console.warn('未找到弹窗用户列表DOM元素，可能弹窗HTML未正确渲染');
        return;
    }
    ulLeft.innerHTML = '';
    modalLeftUsers.forEach(uid => {
        const u = wechatUsers.find(wu => wu.userid === uid);
        const li = document.createElement('li');
        if (u && u.avatar) {
            li.innerHTML = `<img src="${u.avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:8px;object-fit:cover;">` +
                `<span>${u.name || u.userid}</span>`;
        } else if (u) {
            li.innerHTML = `<span>${u.name || u.userid}</span>`;
        } else {
            li.textContent = uid;
        }
        li.onclick = () => {
            if (modalSelectedLeft.includes(uid)) {
                modalSelectedLeft = modalSelectedLeft.filter(x => x !== uid);
                li.classList.remove('selected');
            } else {
                modalSelectedLeft.push(uid);
                li.classList.add('selected');
            }
        };
        if (modalSelectedLeft.includes(uid)) li.classList.add('selected');
        ulLeft.appendChild(li);
    });
    // 右侧
    ulRight.innerHTML = '';
    modalRightUsers.forEach(uid => {
        const u = wechatUsers.find(wu => wu.userid === uid);
        const li = document.createElement('li');
        li.textContent = u ? (u.name || u.userid) : uid;
        li.onclick = () => {
            if (modalSelectedRight.includes(uid)) {
                modalSelectedRight = modalSelectedRight.filter(x => x !== uid);
                li.classList.remove('selected');
            } else {
                modalSelectedRight.push(uid);
                li.classList.add('selected');
            }
        };
        if (modalSelectedRight.includes(uid)) li.classList.add('selected');
        ulRight.appendChild(li);
    });
}

function moveSelected(direction) {
    if (direction === 'left') {
        // 左->右
        modalRightUsers = modalRightUsers.concat(modalSelectedLeft);
        modalLeftUsers = modalLeftUsers.filter(uid => !modalSelectedLeft.includes(uid));
        modalSelectedLeft = [];
    } else {
        // 右->左
        modalLeftUsers = modalLeftUsers.concat(modalSelectedRight);
        modalRightUsers = modalRightUsers.filter(uid => !modalSelectedRight.includes(uid));
        modalSelectedRight = [];
    }
    renderModalUserLists();
}

function saveModalPermission() {
    let perm = permissions.find(p => p.page === modalPage);
    if (!perm) {
        perm = { page: modalPage, users: [] };
        permissions.push(perm);
    }
    perm.users = modalRightUsers.slice();
    closePermissionModal();
    renderPermissionUsers();
}

function closePermissionModal() {
    console.log('调用 closePermissionModal');
    document.getElementById('permission-modal').classList.add('hidden');
}

function savePermissions() {
    // 收集所有权限到permissions已同步，无需重新遍历
    fetch('/api/permissions/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ permissions })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            alert('保存成功');
        } else {
            alert('保存失败: ' + (data.error || '未知错误'));
        }
    });
}

// 立即挂载到 window，确保 HTML onclick 可访问
// 立即挂载到 window，确保 HTML onclick 可访问
window.editPermission = editPermission;
window.moveSelected = moveSelected;
window.saveModalPermission = saveModalPermission;
window.closePermissionModal = closePermissionModal;
window.savePermissions = savePermissions;

// 页面加载后立即拉取数据，确保 DOM 已渲染
fetchWeChatUsers();
fetchPermissions();
});
</script>
{% endblock %}

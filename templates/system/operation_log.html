{% extends 'home.html' %}
{% load static %}

{% block head_extra %}
<style>
    .operation-log-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .page-title h1 {
        margin: 0;
        font-size: 24px;
        color: #333;
    }
    
    .user-info-display {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 16px;
        background: #f8f9fa;
        border-radius: 20px;
        border: 1px solid #e9ecef;
        font-size: 14px;
    }
    
    .user-status {
        color: #6c757d;
    }
    
    .user-info-display.logged-in {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .user-info-display.logged-in .user-status {
        color: #155724;
    }
    
    .user-info-display.not-logged-in {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .user-info-display.not-logged-in .user-status {
        color: #721c24;
    }
    
    .filter-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
    }
    
    .filter-control {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .filter-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    .filter-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(90deg, #81d4fa 0%, #a5d6a7 100%);
        color: white;
    }
    
    .btn-primary:hover {
        background: linear-gradient(90deg, #4fc3f7 0%, #66bb6a 100%);
    }
    
    .btn-secondary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
    }
    
    .btn-secondary:hover {
        background: #e0e0e0;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #4CAF50;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .logs-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .logs-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .logs-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }
    
    .logs-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        color: #555;
    }
    
    .logs-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .operation-type {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .operation-type.CREATE {
        background: #d4edda;
        color: #155724;
    }
    
    .operation-type.UPDATE {
        background: #fff3cd;
        color: #856404;
    }
    
    .operation-type.DELETE {
        background: #f8d7da;
        color: #721c24;
    }
    
    .operation-type.VIEW {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .operation-type.EXPORT {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .operation-type.LOGIN {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .operation-type.LOGOUT {
        background: #ffebee;
        color: #c62828;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        gap: 10px;
    }
    
    .pagination-info {
        color: #666;
        font-size: 14px;
    }
    
    .pagination-button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.3s ease;
    }
    
    .pagination-button:hover {
        background: #f5f5f5;
    }
    
    .pagination-button.active {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }
    
    .pagination-button:disabled {
        background: #f5f5f5;
        color: #ccc;
        cursor: not-allowed;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
    }
    
    .modal-header h3 {
        margin: 0;
        color: #333;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-controls {
        display: flex;
        align-items: center;
    }
    
    .modal-controls .btn {
        font-size: 12px;
        padding: 4px 8px;
    }
    
    .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }
    
    /* æ ‡ç­¾é¡µæ ·å¼ */
    .detail-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }
    
    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .tab-button:hover {
        background: #f5f5f5;
    }
    
    .tab-button.active {
        border-bottom-color: #4CAF50;
        color: #4CAF50;
        font-weight: bold;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* è¯¦æƒ…å†…å®¹æ ·å¼ */
    .detail-section {
        margin-bottom: 20px;
    }
    
    .detail-section h4 {
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    
    .detail-item {
        display: flex;
        margin-bottom: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .detail-label {
        font-weight: bold;
        min-width: 120px;
        color: #555;
    }
    
    .detail-value {
        flex: 1;
        color: #333;
        word-break: break-word;
    }
    
    .json-viewer {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .json-viewer.empty {
        color: #999;
        font-style: italic;
    }
    
    /* æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®æ ·å¼ */
    .view-details-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s ease;
    }
    
    .view-details-btn:hover {
        background: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    <div class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <span class="material-icons" data-icon="menu">menu</span>
            </button>
            <div class="user-info">
                <span class="material-icons" data-icon="person">person</span>
                <span class="username">{{ user.first_name }}</span>
                {% if user.last_name %}
                    <span class="department">({{ user.last_name }})</span>
                {% endif %}
            </div>
        </div>
        <a href="{% url 'logout' %}" class="logout-btn">
            <span class="material-icons" data-icon="logout">logout</span>
            <span class="logout-text">é€€å‡ºç™»å½•</span>
        </a>
    </div>
    <div class="main-container">
        <div class="mobile-overlay" id="mobileOverlay"></div>
        <div id="sideMenu" class="side-menu">
            {% include 'shared/sidebar.html' %}
        </div>
        <div class="main-content" id="mainContentArea">
            <div class="admin-panel-container">
                <div class="operation-log-container">
                    <div class="page-title">
                        <h1>ğŸ“Š ç”¨æˆ·æ“ä½œæ—¥å¿—</h1>
                        <div class="user-info-display" id="userInfo">
                            <span class="user-status">æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...</span>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary" onclick="refreshLogs()">ğŸ”„ åˆ·æ–°</button>
                        </div>
                    </div>
                    
                    <!-- ç­›é€‰æ¡ä»¶ -->
                    <div class="filter-container">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="username">ç”¨æˆ·å</label>
                                <input type="text" id="username" class="filter-control" placeholder="è¾“å…¥ç”¨æˆ·å">
                            </div>
                            <div class="filter-group">
                                <label for="operation_type">æ“ä½œç±»å‹</label>
                                <select id="operation_type" class="filter-control">
                                    <option value="">å…¨éƒ¨æ“ä½œç±»å‹</option>
                                    <option value="CREATE">åˆ›å»º</option>
                                    <option value="UPDATE">æ›´æ–°</option>
                                    <option value="DELETE">åˆ é™¤</option>
                                    <option value="VIEW">æŸ¥çœ‹</option>
                                    <option value="EXPORT">å¯¼å‡º</option>
                                    <option value="LOGIN">ç™»å½•</option>
                                    <option value="LOGOUT">ç™»å‡º</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="report_type">æŠ¥è¡¨ç±»å‹</label>
                                <select id="report_type" class="filter-control">
                                    <option value="">å…¨éƒ¨æŠ¥è¡¨ç±»å‹</option>
                                    <option value="dongtai">ä¸œæ³°QCæŠ¥è¡¨</option>
                                    <option value="yuantong">è¿œé€šQCæŠ¥è¡¨</option>
                                    <option value="yuantong2">è¿œé€š2å·QCæŠ¥è¡¨</option>
                                    <option value="dayuan">å¤§å¡¬QCæŠ¥è¡¨</option>
                                    <option value="changfu">é•¿å¯ŒQCæŠ¥è¡¨</option>
                                    <option value="xinghui">å…´è¾‰QCæŠ¥è¡¨</option>
                                    <option value="xinghui2">å…´è¾‰2å·QCæŠ¥è¡¨</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="start_date">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="start_date" class="filter-control">
                            </div>
                            <div class="filter-group">
                                <label for="end_date">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="end_date" class="filter-control">
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                            <button class="btn btn-primary" onclick="searchLogs()">ğŸ” æœç´¢</button>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-number" id="totalLogs">0</div>
                            <div class="stat-label">æ€»æ“ä½œæ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="todayLogs">0</div>
                            <div class="stat-label">ä»Šæ—¥æ“ä½œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="uniqueUsers">0</div>
                            <div class="stat-label">æ“ä½œç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportOperations">0</div>
                            <div class="stat-label">æŠ¥è¡¨æ“ä½œæ•°</div>
                        </div>
                    </div>
                    
                    <!-- æ—¥å¿—åˆ—è¡¨ -->
                    <div class="logs-container">
                        <div id="logsTable">
                            <div class="loading">æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...</div>
                        </div>
                    </div>
                    
                    <!-- è¯¦ç»†æ•°æ®æ¨¡æ€æ¡† -->
                    <div id="detailModal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="modalTitle">æ“ä½œè¯¦æƒ…</h3>
                                <div class="modal-controls">
                                    <button class="btn btn-secondary" onclick="closeModal()" style="margin-right: 10px;">å…³é—­</button>
                                    <span class="close" onclick="closeModal()">&times;</span>
                                </div>
                            </div>
                            <div class="modal-body">
                                <div class="detail-tabs">
                                    <button class="tab-button active" onclick="showTab('basic')">åŸºæœ¬ä¿¡æ¯</button>
                                    <button class="tab-button" onclick="showTab('newData')">æ–°æ•°æ®</button>
                                    <button class="tab-button" onclick="showTab('oldData')">æ—§æ•°æ®</button>
                                    <button class="tab-button" onclick="showTab('context')">æ“ä½œä¸Šä¸‹æ–‡</button>
                                </div>
                                
                                <div id="basicTab" class="tab-content active">
                                    <div class="detail-section">
                                        <h4>æ“ä½œåŸºæœ¬ä¿¡æ¯</h4>
                                        <div id="basicInfo"></div>
                                    </div>
                                </div>
                                
                                <div id="newDataTab" class="tab-content">
                                    <div class="detail-section">
                                        <h4>æ–°æ•°æ®å†…å®¹</h4>
                                        <div id="newDataContent"></div>
                                    </div>
                                </div>
                                
                                <div id="oldDataTab" class="tab-content">
                                    <div class="detail-section">
                                        <h4>æ—§æ•°æ®å†…å®¹</h4>
                                        <div id="oldDataContent"></div>
                                    </div>
                                </div>
                                
                                <div id="contextTab" class="tab-content">
                                    <div class="detail-section">
                                        <h4>æ“ä½œä¸Šä¸‹æ–‡</h4>
                                        <div id="contextInfo"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="pagination-button" id="prevPage" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                        <span class="pagination-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                        <button class="pagination-button" id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ—¥å¿—
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = weekAgo.toISOString().split('T')[0];
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    getUserInfo();
    
    // åŠ è½½æ—¥å¿—
    loadLogs();
});

// è·å–ç”¨æˆ·ä¿¡æ¯
function getUserInfo() {
    const userInfoDiv = document.getElementById('userInfo');
    
    // å°è¯•ä»é¡µé¢è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœDjangoæ¨¡æ¿ä¸­æœ‰çš„è¯ï¼‰
    const usernameElement = document.querySelector('[data-username]');
    if (usernameElement) {
        const username = usernameElement.getAttribute('data-username');
        userInfoDiv.innerHTML = `<span class="user-status">ğŸ‘¤ å½“å‰ç”¨æˆ·: ${username}</span>`;
        userInfoDiv.className = 'user-info-display logged-in';
        return;
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•è°ƒç”¨APIè·å–
    fetch('/api/user-info/')
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 401) {
                throw new Error('æœªç™»å½•');
            } else {
                throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        })
        .then(data => {
            if (data.status === 'success' && data.user) {
                userInfoDiv.innerHTML = `<span class="user-status">ğŸ‘¤ å½“å‰ç”¨æˆ·: ${data.user.username}</span>`;
                userInfoDiv.className = 'user-info-display logged-in';
            } else {
                throw new Error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆ');
            }
        })
        .catch(error => {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            if (error.message === 'æœªç™»å½•') {
                userInfoDiv.innerHTML = `<span class="user-status">âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ</span>`;
                userInfoDiv.className = 'user-info-display not-logged-in';
            } else {
                userInfoDiv.innerHTML = `<span class="user-status">â“ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯</span>`;
                userInfoDiv.className = 'user-info-display not-logged-in';
            }
        });
}

// åŠ è½½æ—¥å¿—æ•°æ®
function loadLogs(page = 1) {
    const loadingDiv = document.getElementById('logsTable');
    loadingDiv.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...</div>';
    
    // è·å–ç­›é€‰æ¡ä»¶
    const filters = {
        username: document.getElementById('username').value,
        operation_type: document.getElementById('operation_type').value,
        report_type: document.getElementById('report_type').value,
        start_date: document.getElementById('start_date').value,
        end_date: document.getElementById('end_date').value,
        page: page,
        page_size: 50
    };
    
    currentFilters = filters;
    
    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    const queryString = Object.keys(filters)
        .filter(key => filters[key] !== undefined && filters[key] !== '')
        .map(key => `${key}=${encodeURIComponent(filters[key])}`)
        .join('&');
    
    // å‘é€APIè¯·æ±‚
    fetch(`/api/operation-log/?${queryString}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²ç™»å½•æˆ–è”ç³»ç®¡ç†å‘˜');
                } else if (response.status === 401) {
                    throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
                } else {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                displayLogs(data.data);
                updatePagination(data.data.pagination);
                updateStats(data.data.pagination.total_count);
            } else {
                loadingDiv.innerHTML = `<div class="no-data">åŠ è½½å¤±è´¥: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            loadingDiv.innerHTML = `<div class="no-data">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        });
}

// æ˜¾ç¤ºæ—¥å¿—æ•°æ®
function displayLogs(data) {
    const logsTable = document.getElementById('logsTable');
    const logs = data.logs;
    
    if (logs.length === 0) {
        logsTable.innerHTML = '<div class="no-data">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•</div>';
        return;
    }
    
    let html = `
        <table class="logs-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·</th>
                    <th>æ“ä½œç±»å‹</th>
                    <th>æŠ¥è¡¨ç±»å‹</th>
                    <th>æ“ä½œè¯¦æƒ…</th>
                    <th>IPåœ°å€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    logs.forEach(log => {
        html += `
            <tr>
                <td>${log.created_at}</td>
                <td>${log.username}</td>
                <td><span class="operation-type ${log.operation_type}">${log.operation_type_display}</span></td>
                <td>${log.report_type_display}</td>
                <td>${log.operation_detail || '-'}</td>
                <td>${log.ip_address || '-'}</td>
                <td>
                    <button class="view-details-btn" onclick="viewLogDetails(${JSON.stringify(log).replace(/"/g, '&quot;')})">
                        æŸ¥çœ‹è¯¦æƒ…
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    logsTable.innerHTML = html;
}

// æ›´æ–°åˆ†é¡µä¿¡æ¯
function updatePagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
    
    prevButton.disabled = currentPage <= 1;
    nextButton.disabled = currentPage >= totalPages;
    
    paginationDiv.style.display = 'block';
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(totalCount) {
    document.getElementById('totalLogs').textContent = totalCount;
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šç»Ÿè®¡ä¿¡æ¯çš„è®¡ç®—
    // æš‚æ—¶ä½¿ç”¨ç®€å•çš„æ–¹å¼
    const today = new Date().toISOString().split('T')[0];
    if (currentFilters.start_date === today) {
        document.getElementById('todayLogs').textContent = totalCount;
    }
}

// åˆ‡æ¢é¡µé¢
function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        loadLogs(newPage);
    }
}

// æœç´¢æ—¥å¿—
function searchLogs() {
    loadLogs(1);
}

// æ¸…é™¤ç­›é€‰æ¡ä»¶
function clearFilters() {
    document.getElementById('username').value = '';
    document.getElementById('operation_type').value = '';
    document.getElementById('report_type').value = '';
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = weekAgo.toISOString().split('T')[0];
    
    loadLogs(1);
}

// åˆ·æ–°æ—¥å¿—
function refreshLogs() {
    loadLogs(currentPage);
}

// æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…
function viewLogDetails(log) {
    // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
    document.getElementById('modalTitle').textContent = `æ“ä½œè¯¦æƒ… - ${log.operation_type_display} ${log.report_type_display || 'ç³»ç»Ÿæ“ä½œ'}`;
    
    // å¡«å……åŸºæœ¬ä¿¡æ¯
    const basicInfo = document.getElementById('basicInfo');
    basicInfo.innerHTML = `
        <div class="detail-item">
            <span class="detail-label">æ“ä½œID:</span>
            <span class="detail-value">${log.id}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ“ä½œç”¨æˆ·:</span>
            <span class="detail-value">${log.username}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ“ä½œç±»å‹:</span>
            <span class="detail-value">${log.operation_type_display} (${log.operation_type})</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æŠ¥è¡¨ç±»å‹:</span>
            <span class="detail-value">${log.report_type_display || 'ç³»ç»Ÿæ“ä½œ'}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æŠ¥è¡¨ID:</span>
            <span class="detail-value">${log.report_id || 'æ— '}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ“ä½œæ—¶é—´:</span>
            <span class="detail-value">${log.created_at}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">IPåœ°å€:</span>
            <span class="detail-value">${log.ip_address || 'æ— '}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">è¯·æ±‚è·¯å¾„:</span>
            <span class="detail-value">${log.request_path || 'æ— '}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">è¯·æ±‚æ–¹æ³•:</span>
            <span class="detail-value">${log.request_method || 'æ— '}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ“ä½œè¯¦æƒ…:</span>
            <span class="detail-value">${log.operation_detail || 'æ— '}</span>
        </div>
    `;
    
    // å¡«å……æ–°æ•°æ®å†…å®¹
    const newDataContent = document.getElementById('newDataContent');
    if (log.new_data && Object.keys(log.new_data).length > 0) {
        newDataContent.innerHTML = `<div class="json-viewer">${JSON.stringify(log.new_data, null, 2)}</div>`;
    } else {
        newDataContent.innerHTML = '<div class="json-viewer empty">æš‚æ— æ–°æ•°æ®</div>';
    }
    
    // å¡«å……æ—§æ•°æ®å†…å®¹
    const oldDataContent = document.getElementById('oldDataContent');
    if (log.old_data && Object.keys(log.old_data).length > 0) {
        oldDataContent.innerHTML = `<div class="json-viewer">${JSON.stringify(log.old_data, null, 2)}</div>`;
    } else {
        oldDataContent.innerHTML = '<div class="json-viewer empty">æš‚æ— æ—§æ•°æ®</div>';
    }
    
    // å¡«å……æ“ä½œä¸Šä¸‹æ–‡
    const contextInfo = document.getElementById('contextInfo');
    contextInfo.innerHTML = `
        <div class="detail-item">
            <span class="detail-label">æ“ä½œç¯å¢ƒ:</span>
            <span class="detail-value">Webç³»ç»Ÿ</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ•°æ®æ¥æº:</span>
            <span class="detail-value">${log.report_type ? 'QCæŠ¥è¡¨ç³»ç»Ÿ' : 'ç³»ç»Ÿæ“ä½œ'}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">æ“ä½œå½±å“:</span>
            <span class="detail-value">${getOperationImpact(log.operation_type)}</span>
        </div>
    `;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('detailModal').style.display = 'block';
}

// è·å–æ“ä½œå½±å“æè¿°
function getOperationImpact(operationType) {
    const impacts = {
        'CREATE': 'åˆ›å»ºæ–°è®°å½•ï¼Œå¢åŠ æ•°æ®',
        'UPDATE': 'ä¿®æ”¹ç°æœ‰è®°å½•ï¼Œæ›´æ–°æ•°æ®',
        'DELETE': 'åˆ é™¤è®°å½•ï¼Œå‡å°‘æ•°æ®',
        'VIEW': 'æŸ¥çœ‹æ•°æ®ï¼Œä¸å½±å“æ•°æ®',
        'EXPORT': 'å¯¼å‡ºæ•°æ®ï¼Œä¸å½±å“æ•°æ®',
        'LOGIN': 'ç”¨æˆ·ç™»å½•ï¼Œç³»ç»Ÿè®¿é—®',
        'LOGOUT': 'ç”¨æˆ·ç™»å‡ºï¼Œç³»ç»Ÿè®¿é—®'
    };
    return impacts[operationType] || 'æœªçŸ¥æ“ä½œ';
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    console.log('closeModalå‡½æ•°è¢«è°ƒç”¨');
    const modal = document.getElementById('detailModal');
    if (modal) {
        modal.style.display = 'none';
        console.log('æ¨¡æ€æ¡†å·²å…³é—­');
    } else {
        console.error('æœªæ‰¾åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
    }
}

// æ˜¾ç¤ºæŒ‡å®šæ ‡ç­¾é¡µ
function showTab(tabName) {
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => tab.classList.remove('active'));
    
    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µæŒ‰é’®çš„activeçŠ¶æ€
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(btn => btn.classList.remove('active'));
    
    // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µæŒ‰é’®
    event.target.classList.add('active');
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const modal = document.getElementById('detailModal');
    if (event.target === modal) {
        console.log('ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­æ¨¡æ€æ¡†');
        modal.style.display = 'none';
    }
}

// æ·»åŠ é”®ç›˜ESCé”®å…³é—­æ¨¡æ€æ¡†åŠŸèƒ½
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('detailModal');
        if (modal && modal.style.display === 'block') {
            console.log('æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†');
            modal.style.display = 'none';
        }
    }
});

// ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåå‡½æ•°å¯ç”¨
document.addEventListener('DOMContentLoaded', function() {
    // æµ‹è¯•closeModalå‡½æ•°æ˜¯å¦å¯ç”¨
    window.testCloseModal = function() {
        console.log('æµ‹è¯•closeModalå‡½æ•°');
        closeModal();
    };
    
    console.log('æ“ä½œæ—¥å¿—é¡µé¢JavaScriptå·²åŠ è½½å®Œæˆ');
    console.log('closeModalå‡½æ•°:', typeof closeModal);
});
</script>
{% endblock %}

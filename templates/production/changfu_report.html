{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/icon-alignment-fix.css' %}">
<!-- 添加Flatpickr CSS -->
<link rel="stylesheet" href="/static/libs/flatpickr/flatpickr.min.css">
<link rel="stylesheet" href="/static/libs/flatpickr/material_blue.css">
<script src="/static/libs/flatpickr/flatpickr.min.js"></script>
<script src="/static/libs/flatpickr/zh.js"></script>
<style>
    .page-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .page-title h1 {
        margin: 0;
        font-size: 24px;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .form-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        -webkit-appearance: none;
        appearance: none;
    }
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    input[type="number"].form-control {
        -moz-appearance: textfield;
    }
    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        min-height: 44px;
        white-space: nowrap;
    }
    .btn-primary {
        background: linear-gradient(90deg, #81d4fa 0%, #a5d6a7 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #4fc3f7 0%, #66bb6a 100%);
        transform: translateY(-1px);
    }
    .btn-secondary {
        background: #e3f2fd;
        color: #1976d2;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-secondary:hover {
        background: #b3e5fc;
        transform: translateY(-1px);
    }
    .material-icons {
        vertical-align: middle;
        font-size: 20px;
        margin-right: 8px;
    }
    .submit-btn {
        width: 100%;
        margin-top: 20px;
        height: 48px;
        font-size: 18px;
    }
    .table-container {
        margin-top: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
        font-size: 14px;
    }
    th {
        background: #f5f5f5;
        font-weight: 500;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    tr:hover {
        background: #f9f9f9;
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
        .page-container {
            padding: 10px;
        }
        .page-title {
            flex-direction: column;
            align-items: stretch;
        }
        .page-title h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        .action-buttons {
            justify-content: center;
        }
        .form-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .form-group label {
            font-size: 16px;
        }
        .form-control {
            font-size: 16px;
            padding: 12px;
        }
        .btn {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
        }
        .table-container {
            margin: 10px -10px;
            border-radius: 0;
        }
        table {
            font-size: 14px;
        }
        th, td {
            padding: 10px;
        }
    }

    /* 暗色模式支持 */
    @media (prefers-color-scheme: dark) {
        body {
            background: #121212;
            color: #fff;
        }
        .form-container, .table-container {
            background: #1e1e1e;
        }
        .form-control {
            background: #2d2d2d;
            border-color: #404040;
            color: #fff;
        }
        .form-group label {
            color: #e0e0e0;
        }
        th {
            background: #2d2d2d;
            color: #fff;
        }
        tr:hover {
            background: #2d2d2d;
        }
        td {
            border-bottom-color: #404040;
        }
    }

    /* 触摸屏优化 */
    @media (hover: none) {
        .btn:hover {
            transform: none;
        }
        .form-control:focus {
            font-size: 16px;
        }
    }

    .section-title {
        font-size: 18px;
        font-weight: 500;
        color: #1976d2;
        margin: 30px 0 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e3f2fd;
    }
    
    /* 暗色模式支持 */
    @media (prefers-color-scheme: dark) {
        .section-title {
            color: #81d4fa;
            border-bottom-color: #404040;
        }
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
        .section-title {
            font-size: 16px;
            margin: 20px 0 10px;
            text-align: center;
        }
    }

    /* Flatpickr自定义样式 */
    .flatpickr-calendar {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        box-shadow: 0 3px 13px rgba(0,0,0,0.08);
        border-radius: 8px;
    }

    .flatpickr-time {
        height: 50px;
        font-size: 16px;
    }

    .flatpickr-time input {
        font-size: 16px;
        height: 50px;
    }

    .numInputWrapper:hover {
        background: rgba(0,0,0,0.05);
    }

    .flatpickr-current-month {
        font-size: 16px;
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
        .flatpickr-calendar {
            width: 100%;
            max-width: 320px;
        }
        
        .flatpickr-time {
            height: 60px;
        }
        
        .flatpickr-time input {
            height: 60px;
            font-size: 18px;
        }
    }

    .autocomplete-suggestions {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #eee;
        max-height: 200px;
        overflow-y: auto;
        z-index: 9999;
        width: 100%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-radius: 0 0 6px 6px;
    }
    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 15px;
    }
    .autocomplete-suggestion:hover, .autocomplete-suggestion.active {
        background: #f5f5f5;
    }

    /* 导入模态框样式 */
    #importModal {
        display: none;
        position: fixed !important;
        z-index: 999999 !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        backdrop-filter: blur(6px);
        overflow-y: auto;
    }
    #importModal .modal-content {
        position: relative !important;
        z-index: 1000000 !important;
        background-color: #fff !important;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
        animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    #importModal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e3f2fd;
    }
    #importModal .modal-header h2 {
        margin: 0;
        font-size: 24px;
        color: #1976d2;
    }
    #importModal .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: color 0.3s;
        position: relative;
        z-index: 1000001;
        pointer-events: auto;
        user-select: none;
        -webkit-user-select: none;
    }
    #importModal .close:hover {
        color: #1976d2;
    }
    #importModal .close:active {
        color: #0d47a1;
    }
    .file-upload-area {
        border: 2px dashed #81d4fa;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: #f8fbff;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        pointer-events: auto;
        user-select: none;
        -webkit-user-select: none;
    }
    .file-upload-area:hover {
        border-color: #4fc3f7;
        background: #e3f2fd;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(129, 212, 250, 0.3);
    }
    .file-upload-area.dragover {
        border-color: #1976d2;
        background: #bbdefb;
        border-width: 3px;
    }
    .file-upload-area .file-upload-icon,
    .file-upload-area .file-upload-text,
    .file-upload-area .file-upload-hint {
        pointer-events: none;
    }
    .file-upload-icon {
        font-size: 48px;
        color: #81d4fa;
        margin-bottom: 10px;
    }
    .file-upload-text {
        color: #666;
        font-size: 16px;
        margin-bottom: 10px;
    }
    .file-upload-hint {
        color: #999;
        font-size: 14px;
    }
    .file-name {
        margin-top: 15px;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 6px;
        color: #1976d2;
        font-size: 14px;
        display: none;
    }
    .file-name.show {
        display: block;
    }
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    .import-progress {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 6px;
        text-align: center;
    }
    .import-progress.show {
        display: block;
    }
    .progress-text {
        color: #1976d2;
        font-size: 14px;
        margin-top: 10px;
    }
    .error-messages {
        margin-top: 15px;
        padding: 15px;
        background: #ffebee;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .error-messages.show {
        display: block;
    }
    .error-message {
        color: #c62828;
        font-size: 13px;
        margin-bottom: 5px;
        padding: 5px;
    }
    /* 导入提示区域样式 */
    .import-tip-section {
        padding: 24px 32px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-bottom: 1px solid #fcd34d;
        margin: 0;
    }
    .tip-header {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
    }
    .tip-icon-wrapper {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }
    .tip-icon {
        color: white;
        font-size: 28px;
    }
    .tip-content {
        flex: 1;
    }
    .tip-title {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 600;
        color: #92400e;
    }
    .tip-text {
        margin: 0;
        font-size: 14px;
        color: #78350f;
        line-height: 1.6;
    }
    .download-button-wrapper {
        position: relative;
        display: inline-block;
    }
    .download-template-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .download-template-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    .download-template-btn:active:not(:disabled) {
        transform: translateY(0);
    }
    .download-template-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
    }
    .download-template-btn .material-icons {
        font-size: 20px;
    }
    .download-progress-tooltip {
        display: none;
        position: absolute;
        top: calc(100% + 12px);
        left: 0;
        padding: 12px 18px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 8px;
        font-size: 14px;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        z-index: 1000;
    }
    .download-progress-tooltip .progress-icon {
        font-size: 18px;
        margin-right: 8px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-title">
        <h1>长富QC报表</h1>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='{% url 'qc_report' %}'">
                <span class="material-icons">arrow_back</span> 返回
            </button>
            <button id="favoriteBtn" class="btn btn-secondary" type="button">
                <span class="material-icons" id="favoriteIcon">star_border</span> <span id="favoriteText">收藏</span>
            </button>
            <button class="btn btn-secondary" onclick="showImportModal()">
                <span class="material-icons">upload_file</span> 导入Excel
            </button>
            <button class="btn btn-primary" onclick="window.location.href='{% url 'changfu_report_history' %}'">
                <span class="material-icons">history</span> 查看历史记录
            </button>
        </div>
    </div>

    <div class="form-container">
        <form id="qcForm" method="post">
            {% csrf_token %}
            <!-- 基本信息 -->
            <h3 class="section-title">基本信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="date">日期<span style="color:red">*</span></label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="time">时间<span style="color:red">*</span></label>
                    <input type="time" id="time" name="time" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="moisture_after_drying">烘干后原土水分(%)</label>
                    <input type="number" id="moisture_after_drying" name="moisture_after_drying" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="alkali_content">入窑前碱含量(%)</label>
                    <input type="number" id="alkali_content" name="alkali_content" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="flux">助溶剂添加比例</label>
                    <input type="text" id="flux" name="flux" class="form-control">
                </div>
                <div class="form-group">
                    <label for="product_name">产品型号<span style="color:red">*</span></label>
                    <input type="text" id="product_name" name="product_name" class="form-control" required autocomplete="off">
                </div>
            </div>

            <!-- 渗透测试 -->
            <h3 class="section-title">渗透测试</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="permeability">远通渗透率(Darcy)</label>
                    <input type="number" id="permeability" name="permeability" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="permeability_long">长富渗透率(Darcy)</label>
                    <input type="number" id="permeability_long" name="permeability_long" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="wet_cake_density">饼密度(g/cm3)</label>
                    <input type="number" id="wet_cake_density" name="wet_cake_density" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="bulk_density">振实密度(g/cm3)</label>
                    <input type="number" id="bulk_density" name="bulk_density" class="form-control" step="0.001">
                </div>
            </div>

            <!-- 筛分数据 -->
            <h3 class="section-title">筛分数据</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_14m">+14M (%)</label>
                    <input type="number" id="sieving_14m" name="sieving_14m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_30m">+30M (%)</label>
                    <input type="number" id="sieving_30m" name="sieving_30m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_40m">+40M</label>
                    <input type="number" id="sieving_40m" name="sieving_40m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_80m">+80M</label>
                    <input type="number" id="sieving_80m" name="sieving_80m" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_100m">+100M</label>
                    <input type="text" id="sieving_100m" name="sieving_100m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_150m">+150M</label>
                    <input type="text" id="sieving_150m" name="sieving_150m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_200m">+200M</label>
                    <input type="text" id="sieving_200m" name="sieving_200m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_325m">+325M</label>
                    <input type="text" id="sieving_325m" name="sieving_325m" class="form-control">
                </div>
            </div>
            <!-- 可溶性金属 -->
            <h3 class="section-title">可溶性金属</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="fe_ion">铁离子(mg/kg)</label>
                    <input type="number" id="fe_ion" name="fe_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="ca_ion">钙离子(mg/kg)</label>
                    <input type="number" id="ca_ion" name="ca_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="al_ion">铝离子(mg/kg)</label>
                    <input type="number" id="al_ion" name="al_ion" class="form-control" step="0.01">
                </div>
            </div>

            <!-- 其他信息 -->
            <h3 class="section-title">其他信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="brightness">白度</label>
                    <input type="number" id="brightness" name="brightness" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="swirl">涡值(cm)</label>
                    <input type="number" id="swirl" name="swirl" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="odor">气味</label>
                    <input type="number" id="odor" name="odor" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="conductance">⚡电导值(ms/cm)</label>
                    <input type="number" id="conductance" name="conductance" class="form-control" step="0.01">
                </div>
                
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="ph">pH</label>
                    <input type="number" id="ph" name="ph" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="oil_absorption">吸油率(%)</label>
                    <input type="number" id="oil_absorption" name="oil_absorption" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="water_absorption">吸水率(%)</label>
                    <input type="number" id="water_absorption" name="water_absorption" class="form-control" step="0.01">
                </div>

                <div class="form-group">
                    <label for="moisture">水分(%)</label>
                    <input type="number" id="moisture" name="moisture" class="form-control" step="0.01">
                </div>
                
                
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bags">袋数<span style="color:red">*</span></label>
                    <input type="number" id="bags" name="bags" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="packaging">包装类型<span style="color:red">*</span></label>
                    <input type="text" id="packaging" name="packaging" class="form-control" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="tons">吨</label>
                    <input type="number" id="tons" name="tons" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="batch_number">LOT批号</label>
                    <input type="text" id="batch_number" name="batch_number" class="form-control">
                </div>
              
            </div>
            <div class="form-row">
                
               
                <div class="form-group" style="grid-column: span 2;">
                    <label for="remarks">备注</label>
                    <input type="text" id="remarks" name="remarks" class="form-control">
                </div>
                <div class="form-group">
                    <label for="shift">班组<span style="color:red">*</span></label>
                    <select id="shift" name="shift" class="form-control" required>
                        <option value="">请选择班组</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary submit-btn">
                <span class="material-icons">save</span> 保存数据
            </button>
        </form>
    </div>
</div>

<!-- 导入Excel模态框 -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>导入Excel报表</h2>
            <span class="close" id="closeImportModalBtn">&times;</span>
        </div>
        <div class="import-tip-section">
            <div class="tip-header">
                <div class="tip-icon-wrapper">
                    <span class="material-icons tip-icon">lightbulb</span>
                </div>
                <div class="tip-content">
                    <h3 class="tip-title">重要提示</h3>
                    <p class="tip-text">
                        请先下载模板文件，按照模板格式填写数据。表头必须与模板完全一致，不能修改或删除任何列。
                    </p>
                </div>
            </div>
            <div class="download-button-wrapper">
                <button type="button" id="downloadTemplateBtn" class="download-template-btn" onclick="downloadChangfuTemplate()">
                    <span class="material-icons" id="downloadIcon">download</span>
                    <span id="downloadBtnText">下载导入模板</span>
                </button>
                <!-- 下载进度提示 -->
                <div id="downloadProgress" class="download-progress-tooltip">
                    <span class="material-icons progress-icon">hourglass_empty</span>
                    <span class="progress-text">正在下载模板，请稍候...</span>
                </div>
            </div>
        </div>
        <form id="importForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="file-upload-area" id="fileUploadArea">
                <div class="file-upload-icon">
                    <span class="material-icons" style="font-size: 48px;">cloud_upload</span>
                </div>
                <div class="file-upload-text">点击选择Excel文件或拖拽文件到此处</div>
                <div class="file-upload-hint">支持格式: .xlsx, .xls（必须使用模板文件）</div>
                <div class="file-name" id="fileName"></div>
            </div>
            <input type="file" id="excelFileInput" name="excel_file" accept=".xlsx,.xls" style="display: none;">
            <div class="import-progress" id="importProgress">
                <div class="progress-text">正在导入，请稍候...</div>
            </div>
            <div class="error-messages" id="errorMessages"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button type="submit" class="btn btn-primary" id="importSubmitBtn">
                    <span class="material-icons">upload</span> 开始导入
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// 下载模板功能 - 全局函数，供onclick调用
function downloadChangfuTemplate() {
    // 获取按钮和进度提示元素
    const downloadBtn = document.getElementById('downloadTemplateBtn');
    const downloadBtnText = document.getElementById('downloadBtnText');
    const downloadIcon = document.getElementById('downloadIcon');
    const downloadProgress = document.getElementById('downloadProgress');
    
    // 如果按钮已禁用，说明正在下载，直接返回
    if (downloadBtn && downloadBtn.disabled) {
        return;
    }
    
    const url = '{% url "changfu_report_download_template" %}';
    const startTime = Date.now(); // 记录开始时间，用于日志
    
    // 更新UI：禁用按钮，显示进度提示
    if (downloadBtn) {
        downloadBtn.disabled = true;
    }
    if (downloadBtnText) {
        downloadBtnText.textContent = '正在下载...';
    }
    if (downloadIcon) {
        downloadIcon.textContent = 'hourglass_empty';
    }
    if (downloadProgress) {
        downloadProgress.style.display = 'block';
        const progressText = downloadProgress.querySelector('.progress-text');
        if (progressText) {
            progressText.textContent = '正在下载模板，请稍候...';
        }
        downloadProgress.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
    }
    
    // 记录下载开始日志
    console.log('[下载模板] 开始下载长富QC报表导入模板', {
        url: url,
        timestamp: new Date().toISOString()
    });
    
    // 恢复UI状态的辅助函数
    function restoreUI() {
        if (downloadBtn) {
            downloadBtn.disabled = false;
        }
        if (downloadBtnText) {
            downloadBtnText.textContent = '下载导入模板';
        }
        if (downloadIcon) {
            downloadIcon.textContent = 'download';
        }
        if (downloadProgress) {
            downloadProgress.style.display = 'none';
        }
    }
    
    // 显示成功提示的辅助函数
    function showSuccessMessage(message) {
        if (downloadProgress) {
            downloadProgress.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            downloadProgress.innerHTML = '<span class="material-icons progress-icon">check_circle</span><span class="progress-text">' + message + '</span>';
            downloadProgress.style.display = 'block';
            setTimeout(() => {
                downloadProgress.style.display = 'none';
                downloadProgress.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                downloadProgress.innerHTML = '<span class="material-icons progress-icon">hourglass_empty</span><span class="progress-text">正在下载模板，请稍候...</span>';
            }, 3000);
        }
    }
    
    // 检测是否在企业微信环境中
    const isWeChatWork = /wxwork/i.test(navigator.userAgent) || window.wx || window.WeixinJSBridge;
    
    // 方法1：优先使用 File System Access API（现代浏览器支持，可以直接弹出保存对话框）
    if ('showSaveFilePicker' in window && !isWeChatWork) {
        // 先获取文件数据
        fetch(url, {
            method: 'GET',
            credentials: 'same-origin',
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('下载失败：' + response.statusText + ' (状态码: ' + response.status + ')');
            }
            return response.blob();
        })
        .then(async blob => {
            const downloadDuration = Date.now() - startTime;
            const fileSize = (blob.size / 1024).toFixed(2); // KB
            
            // 在弹出文件保存对话框之前，先完全隐藏所有可能遮挡的UI元素
            restoreUI();
            
            // 确保导入模态框完全隐藏
            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.style.display = 'none';
                importModal.style.opacity = '0';
                importModal.style.visibility = 'hidden';
                importModal.style.zIndex = '-1';
            }
            
            // 使用 setTimeout 确保在下一个事件循环中弹出对话框
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                // 使用 File System Access API 弹出保存对话框
                // 这会弹出系统的"另存为"对话框，让用户选择保存位置
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: '长富QC报表导入模板.xlsx',
                    types: [{
                        description: 'Excel文件',
                        accept: {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                        }
                    }]
                });
                
                // 用户选择了保存位置，写入文件
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                // 记录下载成功日志
                console.log('[下载模板] 下载成功（用户选择路径）', {
                    filename: '长富QC报表导入模板.xlsx',
                    fileSize: fileSize + ' KB',
                    duration: downloadDuration + ' ms',
                    timestamp: new Date().toISOString()
                });
                
                // 恢复UI状态（包括模态框状态）
                restoreUI();
                if (importModal) {
                    importModal.style.zIndex = '99999';
                    importModal.style.opacity = '';
                    importModal.style.visibility = '';
                }
                
                // 显示成功提示
                showSuccessMessage('下载成功！文件已保存到您选择的位置');
                
            } catch (saveError) {
                // 处理错误
                if (saveError.name === 'AbortError') {
                    // 用户取消了保存对话框
                    console.log('[下载模板] 用户取消了保存对话框');
                    restoreUI();
                    if (importModal) {
                        importModal.style.zIndex = '99999';
                        importModal.style.opacity = '';
                        importModal.style.visibility = '';
                    }
                } else {
                    // 其他错误，使用备用方法
                    console.warn('[下载模板] File System Access API失败，使用备用方法:', saveError);
                    restoreUI();
                    if (importModal) {
                        importModal.style.zIndex = '99999';
                        importModal.style.opacity = '';
                        importModal.style.visibility = '';
                    }
                    
                    // 使用传统下载方式
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = '长富QC报表导入模板.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showSuccessMessage('下载成功！');
                }
            }
        })
        .catch(error => {
            console.error('[下载模板] 下载失败:', error);
            restoreUI();
            alert('下载失败：' + error.message);
        });
    } else {
        // 方法2：传统下载方式（浏览器会自动弹出保存对话框）
        // 先关闭模态框，避免遮挡
        const importModal = document.getElementById('importModal');
        if (importModal) {
            importModal.style.display = 'none';
            importModal.style.opacity = '0';
            importModal.style.visibility = 'hidden';
            importModal.style.zIndex = '-1';
        }
        
        // 等待一下，确保模态框已隐藏
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = url;
            link.download = '长富QC报表导入模板.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 恢复UI状态
            restoreUI();
            if (importModal) {
                importModal.style.zIndex = '99999';
                importModal.style.opacity = '';
                importModal.style.visibility = '';
            }
            
            showSuccessMessage('下载成功！');
        }, 300);
    }
}

// 导入Excel功能 - 全局函数，供onclick调用
function showImportModal() {
    const importModal = document.getElementById('importModal');
    if (importModal) {
        // 确保模态框的所有样式都正确设置
        importModal.style.display = 'block';
        importModal.style.opacity = '';
        importModal.style.visibility = '';
        importModal.style.zIndex = '99999';
        
        // 重置表单和UI状态
        const importForm = document.getElementById('importForm');
        if (importForm) {
            importForm.reset();
        }
        
        const fileName = document.getElementById('fileName');
        if (fileName) {
            fileName.classList.remove('show');
            fileName.textContent = '';
        }
        
        const importProgress = document.getElementById('importProgress');
        if (importProgress) {
            importProgress.classList.remove('show');
        }
        
        const errorMessages = document.getElementById('errorMessages');
        if (errorMessages) {
            errorMessages.classList.remove('show');
            errorMessages.innerHTML = '';
        }
        
        // 重置文件输入
        const excelFileInput = document.getElementById('excelFileInput');
        if (excelFileInput) {
            excelFileInput.value = '';
        }
        
        // 恢复提交按钮状态
        const importSubmitBtn = document.getElementById('importSubmitBtn');
        if (importSubmitBtn) {
            importSubmitBtn.disabled = false;
        }
        
        // 确保下载按钮状态正常
        const downloadBtn = document.getElementById('downloadTemplateBtn');
        if (downloadBtn) {
            downloadBtn.disabled = false;
        }
        
        // 重新绑定文件上传事件和关闭按钮（确保在企业微信中正常工作）
        setTimeout(function() {
            if (typeof bindFileUploadEvents === 'function') {
                bindFileUploadEvents();
            }
            if (typeof bindCloseButton === 'function') {
                bindCloseButton();
            }
        }, 100);
    }
}

function closeImportModal() {
    const importModal = document.getElementById('importModal');
    if (importModal) {
        // 确保模态框完全关闭
        importModal.style.display = 'none';
        importModal.style.opacity = '';
        importModal.style.visibility = '';
        importModal.style.zIndex = '99999';
    }
    
    // 重置表单和UI状态
    const importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.reset();
    }
    
    const fileName = document.getElementById('fileName');
    if (fileName) {
        fileName.classList.remove('show');
        fileName.textContent = '';
    }
    
    const importProgress = document.getElementById('importProgress');
    if (importProgress) {
        importProgress.classList.remove('show');
    }
    
    const errorMessages = document.getElementById('errorMessages');
    if (errorMessages) {
        errorMessages.classList.remove('show');
        errorMessages.innerHTML = '';
    }
    
    // 重置文件输入
    const excelFileInput = document.getElementById('excelFileInput');
    if (excelFileInput) {
        excelFileInput.value = '';
    }
    
    // 恢复提交按钮状态
    const importSubmitBtn = document.getElementById('importSubmitBtn');
    if (importSubmitBtn) {
        importSubmitBtn.disabled = false;
    }
    
    // 恢复下载按钮状态
    const downloadBtn = document.getElementById('downloadTemplateBtn');
    if (downloadBtn) {
        downloadBtn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 初始化日期选择器
    flatpickr("#date", {
        locale: window.flatpickr.l10ns.zh,
        dateFormat: "Y-m-d",
        defaultDate: new Date()
    });

    // 初始化时间字段
    function initializeTimeField() {
        const now = new Date();
        const minutes = now.getMinutes();
        // 将分钟数调整为5的倍数
        const roundedMinutes = Math.round(minutes / 5) * 5;
        now.setMinutes(roundedMinutes);
        now.setSeconds(0);
        
        flatpickr("#time", {
            locale: window.flatpickr.l10ns.zh,
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            defaultDate: now,
            minuteIncrement: 5  // 设置分钟增量为5
        });
    }
    
    // 初始化时间字段
    initializeTimeField();
    
    // 每10分钟自动刷新页面 - 已禁用
    // setInterval(function() {
    //     console.log('自动刷新页面...');
    //     window.location.reload();
    // }, 10 * 60 * 1000); // 10分钟 = 10 * 60 * 1000 毫秒

    // 获取CSRF Token的函数
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 表单提交处理
    document.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // 定义允许的字段列表
        const allowedFields = [
            'date', 'time', 'shift', 'product_name', 'packaging',
            'moisture_after_drying', 'alkali_content', 'flux',
            'permeability', 'permeability_long', 'wet_cake_density', 'bulk_density',
            'brightness', 'swirl', 'odor', 'conductance', 'ph', 'moisture',
            'bags', 'tons', 'sieving_14m', 'sieving_30m',
            'sieving_40m', 'sieving_80m', 'sieving_100m', 'sieving_150m', 'sieving_200m',
            'sieving_325m', 'fe_ion', 'ca_ion', 'al_ion',
            'oil_absorption', 'water_absorption', 'remarks',
            'batch_number'  // 使用batch_number字段
        ];

        for (let [key, value] of formData.entries()) {
            // 跳过CSRF token和不在允许列表中的字段
            if (key === 'csrfmiddlewaretoken' || !allowedFields.includes(key)) {
                continue;
            }
            
            if (value === '') continue;  // 跳过空值
            
            // 对数字类型的字段进行转换
            if ([
                'moisture_after_drying', 'alkali_content', 'permeability', 
                'permeability_long', 'wet_cake_density', 'bulk_density', 'brightness', 'conductance', 
                'ph', 'moisture', 'bags', 'tons', 'sieving_14m', 'sieving_30m', 
                'sieving_40m', 'sieving_80m',
                'fe_ion', 'ca_ion', 'al_ion', 'oil_absorption', 'water_absorption'
            ].includes(key)) {
                data[key] = parseFloat(value);
            } else {
                data[key] = value;
            }
        }

        try {
            const response = await fetch('/api/changfu-report/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                alert('保存成功');
                
                // 重新加载表格数据，但不重置表单
                await loadTableData();
                
                // 不重置表单，保留所有字段信息
                // 用户可以继续基于当前数据进行修改和保存
                
            } else {
                alert('保存失败: ' + result.message);
            }
        } catch (error) {
            alert('提交失败: ' + error.message);
        }
    });
    
    // 加载表格数据
    async function loadTableData() {
        try {
            const response = await fetch('/api/changfu-report/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.ok) {
                const data = await response.json();
                const tbody = document.querySelector('table tbody');
                if (!tbody) return; // 防止报错
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                        <td>${item.moisture_after_drying || '-'}</td>
                        <td>${item.alkali_content || '-'}</td>
                        <td>${item.flux || '-'}</td>
                        <td>${item.product_name || '-'}</td>
                        <td>${item.permeability || '-'}</td>
                        <td>${item.permeability_long || '-'}</td>
                        <td>${item.wet_cake_density || '-'}</td>
                        <td>${item.bulk_density || '-'}</td>
                        <td>${item.brightness || '-'}</td>
                        <td>${item.swirl || '-'}</td>
                        <td>${item.odor || '-'}</td>
                        <td>${item.conductance || '-'}</td>
                        <td>${item.ph || '-'}</td>
                        <td>${item.moisture || '-'}</td>
                        <td>${item.bags || '-'}</td>
                        <td>${item.packaging || '-'}</td>
                        <td>${item.tons || '-'}</td>
                        <td>${item.fe_ion || '-'}</td>
                        <td>${item.ca_ion || '-'}</td>
                        <td>${item.al_ion || '-'}</td>
                        <td>${item.oil_absorption || '-'}</td>
                        <td>${item.water_absorption || '-'}</td>
                        <td>${item.remarks || '-'}</td>
                        <td>${item.batch_number || '-'}</td>
                        <td>${item.shift || '-'}</td>
                        <td>${item.sieving_14m || '-'}</td>
                        <td>${item.sieving_30m || '-'}</td>
                        <td>${item.sieving_40m || '-'}</td>
                        <td>${item.sieving_80m || '-'}</td>
                        <td>${item.sieving_150m || '-'}</td>
                        <td>${item.sieving_200m || '-'}</td>
                        <td>${item.sieving_325m || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const result = await response.json();
                console.error('加载数据失败:', result.message);
            }
        } catch (error) {
            console.error('加载数据失败:', error);
        }
    }

    // 初始加载表格数据
    loadTableData();

    // 产品型号自动补全（脱离父容器，body下绝对定位）
    (function() {
        const input = document.getElementById('product_name');
        let suggestionsBox = document.getElementById('productNameSuggestions');
        if (!suggestionsBox) {
            suggestionsBox = document.createElement('div');
            suggestionsBox.id = 'productNameSuggestions';
            suggestionsBox.className = 'autocomplete-suggestions';
            suggestionsBox.style.display = 'none';
            document.body.appendChild(suggestionsBox);
        }
        let lastQuery = '';
        let activeIndex = -1;
        let suggestions = [];
        let debounceTimer = null;

        function positionBox() {
            const rect = input.getBoundingClientRect();
            suggestionsBox.style.position = 'fixed';
            suggestionsBox.style.left = rect.left + 'px';
            suggestionsBox.style.top = rect.bottom + 'px';
            suggestionsBox.style.width = rect.width + 'px';
            suggestionsBox.style.zIndex = 99999;
        }

        function fetchSuggestions(query) {
            fetch(`/api/product-models/suggest/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.data.length > 0) {
                        suggestions = data.data;
                        suggestionsBox.innerHTML = data.data.map((item, idx) =>
                            `<div class="autocomplete-suggestion${idx===0?' active':''}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestionsBox.style.display = 'block';
                        activeIndex = 0;
                        positionBox();
                    } else {
                        suggestions = [];
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }
                });
        }

        input.addEventListener('input', function() {
            const query = this.value.trim();
            lastQuery = query;
            if (debounceTimer) clearTimeout(debounceTimer);
            if (!query) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        input.addEventListener('focus', positionBox);
        window.addEventListener('resize', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        });
        window.addEventListener('scroll', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        }, true);

        suggestionsBox.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                input.value = e.target.getAttribute('data-name');
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });

        // 键盘上下键选择
        input.addEventListener('keydown', function(e) {
            if (!suggestions.length || suggestionsBox.style.display === 'none') return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
                updateActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
                updateActive();
            } else if (e.key === 'Enter') {
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    input.value = suggestions[activeIndex].name;
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    e.preventDefault();
                }
            }
        });
        function updateActive() {
            const items = suggestionsBox.querySelectorAll('.autocomplete-suggestion');
            items.forEach((el, idx) => {
                if (idx === activeIndex) {
                    el.classList.add('active');
                    el.scrollIntoView({block:'nearest'});
                } else {
                    el.classList.remove('active');
                }
            });
        }
        // 点击外部关闭建议
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });
    })();

    // 包装类型自动补全（脱离父容器，body下绝对定位）
    (function() {
        const input = document.getElementById('packaging');
        let suggestionsBox = document.getElementById('packagingSuggestions');
        if (!suggestionsBox) {
            suggestionsBox = document.createElement('div');
            suggestionsBox.id = 'packagingSuggestions';
            suggestionsBox.className = 'autocomplete-suggestions';
            suggestionsBox.style.display = 'none';
            document.body.appendChild(suggestionsBox);
        }
        let lastQuery = '';
        let activeIndex = -1;
        let suggestions = [];
        let debounceTimer = null;

        function positionBox() {
            const rect = input.getBoundingClientRect();
            suggestionsBox.style.position = 'fixed';
            suggestionsBox.style.left = rect.left + 'px';
            suggestionsBox.style.top = rect.bottom + 'px';
            suggestionsBox.style.width = rect.width + 'px';
            suggestionsBox.style.zIndex = 99999;
        }

        function fetchSuggestions(query) {
            fetch(`/api/packagings/suggest/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.data.length > 0) {
                        suggestions = data.data;
                        suggestionsBox.innerHTML = data.data.map((item, idx) =>
                            `<div class="autocomplete-suggestion${idx===0?' active':''}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestionsBox.style.display = 'block';
                        activeIndex = 0;
                        positionBox();
                    } else {
                        suggestions = [];
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('包装类型自动完成错误:', error);
                    suggestions = [];
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                });
        }

        input.addEventListener('input', function() {
            const query = this.value.trim();
            lastQuery = query;
            if (debounceTimer) clearTimeout(debounceTimer);
            if (!query) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        input.addEventListener('focus', positionBox);
        window.addEventListener('resize', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        });
        window.addEventListener('scroll', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        }, true);

        suggestionsBox.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                input.value = e.target.getAttribute('data-name');
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });

        // 键盘上下键选择
        input.addEventListener('keydown', function(e) {
            if (!suggestions.length || suggestionsBox.style.display === 'none') return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
                updateActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
                updateActive();
            } else if (e.key === 'Enter') {
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    input.value = suggestions[activeIndex].name;
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    e.preventDefault();
                }
            }
        });
        function updateActive() {
            const items = suggestionsBox.querySelectorAll('.autocomplete-suggestion');
            items.forEach((el, idx) => {
                if (idx === activeIndex) {
                    el.classList.add('active');
                    el.scrollIntoView({block:'nearest'});
                } else {
                    el.classList.remove('active');
                }
            });
        }
        // 点击外部关闭建议
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });
    })();

    // 收藏功能（与后端同步）
    (function() {
        const btn = document.getElementById('favoriteBtn');
        const icon = document.getElementById('favoriteIcon');
        const text = document.getElementById('favoriteText');
        const pageKey = 'changfu_report';
        let isFav = false;
        function setState(fav) {
            if (fav) {
                icon.textContent = 'star';
                text.textContent = '取消收藏';
            } else {
                icon.textContent = 'star_border';
                text.textContent = '收藏';
            }
        }
        // 初始化状态
        fetch(`/api/user-favorite/?page=${pageKey}`)
            .then(res => res.json())
            .then(data => {
                isFav = !!data.favorite;
                setState(isFav);
            });
        btn.addEventListener('click', function() {
            if (isFav) {
                fetch(`/api/user-favorite/?page=${pageKey}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin'
                })
                    .then(res => res.json())
                    .then(data => {
                        isFav = false;
                        setState(false);
                        window.dispatchEvent(new Event('favoriteChanged'));
                    });
            } else {
                fetch(`/api/user-favorite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({page: pageKey}),
                    credentials: 'same-origin'
                })
                    .then(res => res.json())
                    .then(data => {
                        isFav = true;
                        setState(true);
                        window.dispatchEvent(new Event('favoriteChanged'));
                    });
            }
        });
    })();

    // 拖拽上传和点击上传 - 完全参照大塬的实现
    function bindFileUploadEvents() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const excelFileInput = document.getElementById('excelFileInput');
        
        if (!fileUploadArea || !excelFileInput) {
            return;
        }
        
        // 使用cloneNode重新绑定事件，避免事件冲突（特别是在企业微信环境中）
        const newFileUploadArea = fileUploadArea.cloneNode(true);
        fileUploadArea.parentNode.replaceChild(newFileUploadArea, fileUploadArea);
        
        newFileUploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            excelFileInput.click();
        });
        
        newFileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.add('dragover');
        });

        newFileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.remove('dragover');
        });

        newFileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // 使用DataTransfer来设置文件（兼容性更好）
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    excelFileInput.files = dataTransfer.files;
                    
                    const fileNameDiv = document.getElementById('fileName');
                    if (fileNameDiv) {
                        fileNameDiv.textContent = '已选择: ' + file.name;
                        fileNameDiv.classList.add('show');
                    }
                } else {
                    alert('请选择Excel文件格式(.xlsx 或 .xls)');
                }
            }
        });
    }

    // 文件选择处理 - 完全参照大塬的实现
    const excelFileInput = document.getElementById('excelFileInput');
    if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
            const fileNameDiv = document.getElementById('fileName');
            if (this.files && this.files.length > 0) {
                // 直接显示文件名，accept属性已经限制了文件类型
                fileNameDiv.textContent = '已选择: ' + this.files[0].name;
                fileNameDiv.classList.add('show');
                console.log('[文件选择] 文件已选择:', this.files[0].name);
            } else {
                fileNameDiv.classList.remove('show');
                console.log('[文件选择] 文件选择已取消');
            }
        });
    }
    
    // 绑定文件上传事件
    bindFileUploadEvents();

    // 表单提交处理 - 完全参照大塬的实现
    const importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('excelFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('请选择要导入的Excel文件');
                console.warn('[导入] 未选择文件');
                return;
            }

            console.log('[导入] 开始导入文件:', fileInput.files[0].name);

            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', getCSRFToken());

            document.getElementById('importProgress').classList.add('show');
            document.getElementById('importSubmitBtn').disabled = true;
            document.getElementById('errorMessages').classList.remove('show');
            document.getElementById('errorMessages').innerHTML = '';

            try {
                const response = await fetch('{% url "changfu_report_import_excel" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const result = await response.json();
                
                console.log('[导入] 服务器响应:', result);
                
                document.getElementById('importProgress').classList.remove('show');
                document.getElementById('importSubmitBtn').disabled = false;

                if (result.status === 'success') {
                    alert(`导入成功！\n成功导入: ${result.imported_count} 条数据${result.error_count > 0 ? '\n失败: ' + result.error_count + ' 条' : ''}`);
                    
                    if (result.error_messages && result.error_messages.length > 0) {
                        const errorDiv = document.getElementById('errorMessages');
                        errorDiv.innerHTML = '<strong>部分数据导入失败：</strong><br>' + 
                            result.error_messages.map(msg => `<div class="error-message">${msg}</div>`).join('');
                        errorDiv.classList.add('show');
                    } else {
                        closeImportModal();
                        if (typeof loadTableData === 'function') {
                            await loadTableData();
                        } else {
                            window.location.reload();
                        }
                    }
                } else {
                    alert('导入失败: ' + (result.message || '未知错误'));
                    console.error('[导入] 导入失败:', result);
                    if (result.error_messages && result.error_messages.length > 0) {
                        const errorDiv = document.getElementById('errorMessages');
                        errorDiv.innerHTML = '<strong>错误信息：</strong><br>' + 
                            result.error_messages.map(msg => `<div class="error-message">${msg}</div>`).join('');
                        errorDiv.classList.add('show');
                    }
                }
            } catch (error) {
                document.getElementById('importProgress').classList.remove('show');
                document.getElementById('importSubmitBtn').disabled = false;
                alert('导入失败: ' + error.message);
                console.error('[导入] 网络错误:', error);
            }
        });
    }

    // 绑定关闭按钮事件 - 兼容企业微信（使用多种方式确保能工作）
    function bindCloseButton() {
        const closeBtn = document.getElementById('closeImportModalBtn');
        if (closeBtn) {
            // 先移除所有可能存在的旧事件监听器
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            
            // 方法1：使用onclick属性（最兼容）
            newCloseBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('[关闭按钮] onclick事件触发');
                closeImportModal();
                return false;
            };
            
            // 方法2：使用addEventListener click事件（捕获阶段）
            newCloseBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('[关闭按钮] addEventListener click事件触发');
                closeImportModal();
                return false;
            }, true); // 使用捕获阶段
            
            // 方法3：使用addEventListener click事件（冒泡阶段）
            newCloseBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('[关闭按钮] addEventListener click事件触发（冒泡）');
                closeImportModal();
                return false;
            }, false);
            
            // 方法4：触摸事件（移动端/企业微信）
            newCloseBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('[关闭按钮] 触摸事件触发');
                closeImportModal();
                return false;
            }, true);
            
            // 方法5：mousedown事件（备用）
            newCloseBtn.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[关闭按钮] mousedown事件触发');
                closeImportModal();
                return false;
            }, true);
            
            console.log('[关闭按钮] 事件绑定完成');
        } else {
            console.warn('[关闭按钮] 未找到关闭按钮元素');
        }
    }
    
    // 立即绑定
    bindCloseButton();
    
    // 在模态框显示时重新绑定（确保事件正常）
    const originalShowImportModal = window.showImportModal;
    window.showImportModal = function() {
        if (originalShowImportModal) {
            originalShowImportModal();
        }
        // 延迟绑定，确保DOM已更新
        setTimeout(function() {
            bindCloseButton();
            if (typeof bindFileUploadEvents === 'function') {
                bindFileUploadEvents();
            }
        }, 100);
    };
    
    // 点击模态框外部关闭
    const importModal = document.getElementById('importModal');
    if (importModal) {
        importModal.addEventListener('click', function(event) {
            // 如果点击的是模态框背景（不是modal-content），则关闭
            if (event.target === importModal) {
                closeImportModal();
            }
        }, false);
    }
});
</script>
{% endblock %} 
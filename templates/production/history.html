{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/icon-alignment-fix.css' %}">
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* å¼ºåˆ¶ç§»åŠ¨ç«¯å‹å¥½å¡ç‰‡æ¨¡å¼ï¼Œä»»ä½•å±å¹•éƒ½åªæ˜¾ç¤ºå¡ç‰‡ */
    .table-container { display: none !important; }
    .history-card-list { display: flex !important; }

    .page-container {
        padding: 12px;
        max-width: 100%;
        min-height: 100vh;
        box-sizing: border-box;
    }
    
    /* é¡µé¢å¤´éƒ¨ä¼˜åŒ– */
    .page-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 16px;
    }
    
    .back-btn {
        margin-bottom: 12px;
        display: inline-flex;
        align-items: center;
        padding: 10px 16px;
        background: rgba(255, 255, 255, 0.9);
        color: #1976d2;
        border: 1px solid rgba(25, 118, 210, 0.2);
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        backdrop-filter: blur(10px);
        min-height: 44px;
        box-sizing: border-box;
    }
    
    .back-btn:hover, .back-btn:active {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-1px);
    }
    
    .page-title {
        margin-bottom: 0;
    }
    
    .page-title h1 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        color: #1976d2;
    }
    
    .special-user-info {
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #2e7d32;
    }
    
    .special-user-info .material-icons {
        font-size: 18px;
        color: #4caf50;
    }
    
    .pagination-info {
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(25, 118, 210, 0.1);
        border: 1px solid rgba(25, 118, 210, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #1976d2;
    }
    
    .pagination-info .material-icons {
        font-size: 18px;
        color: #1976d2;
    }
    
    /* å†å²è®°å½•å¡ç‰‡åˆ—è¡¨ä¼˜åŒ– */
    .history-card-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin: 0 auto;
        padding: 0;
        max-width: 500px;
        width: 100%;
    }
    
    .history-card-sectioned {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .history-card-sectioned:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    /* å¡ç‰‡å¤´éƒ¨ä¼˜åŒ– */
    .history-card-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding: 16px;
        border-bottom: 1px solid rgba(25, 118, 210, 0.1);
    }
    
    .header-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .document-number {
        font-weight: 700;
        color: #1976d2;
        font-size: 16px;
        flex: 1;
        min-width: 0;
        display: flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
    }
    
    .status-badge {
        background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 8px;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        min-height: 40px;
        box-sizing: border-box;
        text-align: center;
        line-height: 1;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }
    
    .btn-edit:hover, .btn-edit:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        color: white;
        text-decoration: none;
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.25);
    }
    
    .btn-delete:hover, .btn-delete:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.35);
    }
    
    /* å›¾æ ‡æ ·å¼å·²ç§»è‡³å¤–éƒ¨CSSæ–‡ä»¶ */
    
    /* å¡ç‰‡å†…å®¹åŒºåŸŸä¼˜åŒ– */
    .history-card-section {
        padding: 16px;
    }
    
    .section-title {
        font-size: 14px;
        color: #1976d2;
        font-weight: 700;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        padding-left: 12px;
    }
    
    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 2px;
        width: 3px;
        height: 12px;
        background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
        border-radius: 2px;
    }
    
    .section-rows {
        display: grid;
        gap: 8px;
    }
    
    .history-card-row {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: rgba(249, 249, 249, 0.6);
        border-radius: 8px;
        transition: background 0.2s ease;
    }
    
    .history-card-row:hover {
        background: rgba(240, 240, 240, 0.8);
    }
    
    .history-card-label {
        color: #666;
        font-size: 13px;
        font-weight: 600;
        min-width: 80px;
        margin-right: 12px;
        flex-shrink: 0;
        line-height: 1;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .history-card-value {
        color: #333;
        font-weight: 500;
        font-size: 14px;
        flex: 1;
        word-break: break-word;
        line-height: 1;
        display: flex;
        align-items: center;
    }
    
    .history-card-divider {
        border: none;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(25, 118, 210, 0.2) 50%, transparent 100%);
        margin: 0;
    }
    
    /* ç©ºçŠ¶æ€ä¼˜åŒ– */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }
    
    .empty-state .material-icons {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 16px;
        display: block;
    }
    
    /* ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ */
    @media (max-width: 480px) {
        .page-container {
            padding: 8px;
        }
        
        .page-header {
            padding: 12px;
            border-radius: 12px;
        }
        
        .page-title h1 {
            font-size: 20px;
        }
        
        .history-card-header {
            padding: 12px;
        }
        
        .history-card-section {
            padding: 12px;
        }
        
        .document-number {
            font-size: 15px;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 12px;
            min-height: 44px;
            font-size: 14px;
        }
    }
    
    /* åŠ è½½å’Œåˆ é™¤çŠ¶æ€ */
    .btn-delete.loading {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
    }
    
    .btn-delete.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* è§¦æ‘¸åé¦ˆ */
    .btn:active {
        transform: scale(0.98);
    }
    
    /* åˆ†é¡µæ§ä»¶æ ·å¼ */
    .pagination-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 16px;
        margin-top: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .pagination-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        min-height: 36px;
        box-sizing: border-box;
    }
    
    .pagination-btn:hover:not(.disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        color: white;
        text-decoration: none;
    }
    
    .pagination-btn.disabled {
        background: #e0e0e0;
        color: #999;
        cursor: not-allowed;
        transform: none;
    }
    
    .page-numbers {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .page-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .page-number:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
        color: #667eea;
        text-decoration: none;
    }
    
    .page-number.current {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .page-ellipsis {
        color: #999;
        font-size: 14px;
        padding: 0 4px;
    }
    
    .page-size-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        color: #666;
    }
    
    .page-size-selector select {
        padding: 6px 8px;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 6px;
        background: white;
        font-size: 14px;
        color: #333;
        cursor: pointer;
    }
    
    .page-size-selector select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    /* æœç´¢åŒºåŸŸæ ·å¼ */
    .search-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .search-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .search-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1976d2;
    }
    
    .search-header .material-icons {
        color: #667eea;
        font-size: 20px;
    }
    
    .search-fields {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .search-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .search-field label {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
    }
    
    .search-input {
        padding: 12px 16px;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 12px;
        font-size: 14px;
        background: white;
        transition: all 0.3s ease;
        min-height: 44px;
        box-sizing: border-box;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    .search-input:focus::placeholder {
        color: #667eea;
    }
    
    .search-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }
    
    .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        min-height: 44px;
        box-sizing: border-box;
    }
    
    .search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    }
    
    .clear-btn {
        background: rgba(255, 255, 255, 0.9);
        color: #666;
        border: 1px solid rgba(102, 126, 234, 0.3);
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        min-height: 44px;
        box-sizing: border-box;
    }
    
    .clear-btn:hover {
        background: rgba(255, 255, 255, 1);
        border-color: #667eea;
        color: #667eea;
    }
    
    /* é‡é‡ç»Ÿè®¡æ ·å¼ */
    .weight-summary {
        margin-top: 12px;
        padding: 12px 16px;
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 12px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }
    
    .weight-summary .material-icons {
        color: #4caf50;
        font-size: 20px;
        margin-top: 2px;
    }
    
    .weight-info {
        flex: 1;
    }
    
    .weight-info h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
        color: #2e7d32;
    }
    
    .weight-items {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .weight-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 13px;
    }
    
    .material-name {
        color: #333;
        font-weight: 500;
        flex: 1;
        margin-right: 8px;
    }
    
    .weight-value {
        color: #2e7d32;
        font-weight: 600;
        background: rgba(76, 175, 80, 0.1);
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 12px;
    }
    
    /* ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ */
    @media (max-width: 480px) {
        .pagination-container {
            padding: 12px;
            border-radius: 12px;
        }
        
        .pagination-controls {
            flex-direction: column;
            gap: 8px;
        }
        
        .page-numbers {
            order: -1;
        }
        
        .page-size-selector {
            margin-top: 8px;
        }
        
        .search-container {
            padding: 12px;
            border-radius: 12px;
        }
        
        .search-actions {
            flex-direction: column;
        }
        
        .search-btn, .clear-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <button class="btn back-btn" onclick="window.location.href='{% url 'raw_soil_storage' %}'">
            <span class="material-icons">arrow_back</span> è¿”å›
        </button>
        <div class="page-title">
            <h1>ğŸ“‹ å…¥åº“å†å²è®°å½•</h1>
            {% if is_special_user %}
            <div class="special-user-info">
                <span class="material-icons">admin_panel_settings</span>
                <span>ç®¡ç†å‘˜è§†å›¾ - æ˜¾ç¤ºæ‰€æœ‰åº“å­˜ç»„ç»‡æ•°æ® (å…±{{ total_orgs }}ä¸ªç»„ç»‡)</span>
            </div>
            {% endif %}
            {% if pagination %}
            <div class="pagination-info">
                <span class="material-icons">info</span>
                <span>å…± {{ pagination.total_records }} æ¡è®°å½•ï¼Œç¬¬ {{ pagination.current_page }}/{{ pagination.total_pages }} é¡µ</span>
            </div>
            {% endif %}
            
            <!-- ç‰©æ–™æ€»é‡é‡ç»Ÿè®¡ -->
            {% if material_total_weight %}
            <div class="weight-summary">
                <span class="material-icons">scale</span>
                <div class="weight-info">
                    <h4>ğŸ“Š ç‰©æ–™æ€»é‡é‡ç»Ÿè®¡</h4>
                    <div class="weight-items">
                        {% for material_name, total_weight in material_total_weight.items %}
                        <div class="weight-item">
                            <span class="material-name">{{ material_name }}</span>
                            <span class="weight-value">{{ total_weight|floatformat:2 }} å¨</span>
        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-container">
        <form id="searchForm" method="GET" class="search-form">
            <!-- éšè—çš„CSRF token -->
            {% csrf_token %}
            
            <!-- æœç´¢æ ‡é¢˜ -->
            <div class="search-header">
                <span class="material-icons">search</span>
                <h3>ğŸ” æœç´¢ç­›é€‰</h3>
            </div>
            
            <!-- æœç´¢å­—æ®µ -->
            <div class="search-fields">
                <!-- ä»“åº“é€‰æ‹© -->
                <div class="search-field">
                    <label for="warehouse">ğŸª ä»“åº“</label>
                    <select id="warehouse" name="warehouse" class="search-input">
                        <option value="">å…¨éƒ¨ä»“åº“</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse.warehouse_code }}" {% if selected_warehouse == warehouse.warehouse_code %}selected{% endif %}>
                            {{ warehouse.warehouse_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- èµ·å§‹æ—¥æœŸ -->
                <div class="search-field">
                    <label for="start_date">ğŸ“… èµ·å§‹æ—¥æœŸ</label>
                    <input type="date" id="start_date" name="start_date" class="search-input" 
                           value="{{ start_date|default:default_start_date }}" placeholder="é€‰æ‹©èµ·å§‹æ—¥æœŸ">
                </div>
                
                <!-- æˆªæ­¢æ—¥æœŸ -->
                <div class="search-field">
                    <label for="end_date">ğŸ“… æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="end_date" name="end_date" class="search-input" 
                           value="{{ end_date|default:default_end_date }}" placeholder="é€‰æ‹©æˆªæ­¢æ—¥æœŸ">
                </div>
            </div>
            
            <!-- æœç´¢æŒ‰é’® -->
            <div class="search-actions">
                <button type="submit" class="btn search-btn">
                    <span class="material-icons">search</span>
                    æœç´¢
                </button>
                <button type="button" class="btn clear-btn" onclick="clearSearch()">
                    <span class="material-icons">clear</span>
                    æ¸…ç©º
                </button>
            </div>
        </form>
    </div>

    <!-- ç§»åŠ¨ç«¯å¡ç‰‡åˆ—è¡¨ -->
    <div class="history-card-list">
        {% for record in records %}
        <div class="history-card history-card-sectioned">
            <!-- å¡ç‰‡å¤´éƒ¨ -->
            <div class="history-card-header">
                <div class="header-content">
                    <div class="header-info">
                        <span class="document-number">ğŸ“„ {{ record.FNumber|default:'--' }}</span>
                        <span class="status-badge">{{ record.status|default:'æ­£å¸¸' }}</span>
                    </div>
                    <div class="action-buttons">
                        <a class="btn btn-edit" href="/production/raw-soil-storage/{{ record.FNumber }}/edit/">
                            <span class="material-icons">edit</span> ç¼–è¾‘
                        </a>
                        <button class="btn btn-delete" data-fnumber="{{ record.FNumber }}">
                            <span class="material-icons">delete</span> åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="history-card-section">
                <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                <div class="section-rows">
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ“… æ—¥æœŸ</span>
                        <span class="history-card-value">{{ record.FBizDate|slice:':10'|default:'--' }}</span>
                    </div>
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸª åº“ä½</span>
                        <span class="history-card-value">{{ record.warehouse_name }}</span>
                    </div>
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ¢ æˆæœ¬ä¸­å¿ƒ</span>
                        <span class="history-card-value">{{ record.cost_center }}</span>
                    </div>
                    {% if is_special_user and record.org_code %}
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ­ åº“å­˜ç»„ç»‡</span>
                        <span class="history-card-value">{{ record.org_code }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <hr class="history-card-divider">
            
            <!-- ç‰©æ–™ä¿¡æ¯ -->
            <div class="history-card-section">
                <div class="section-title">ç‰©æ–™ä¿¡æ¯</div>
                <div class="section-rows">
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ”¢ ç¼–ç </span>
                        <span class="history-card-value">{{ record.materialNumber|default:'--' }}</span>
                    </div>
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ“¦ åç§°</span>
                        <span class="history-card-value">{{ record.material_name }}</span>
                    </div>
                    <div class="history-card-row">
                        <span class="history-card-label">âš–ï¸ æ•°é‡</span>
                        <span class="history-card-value">{{ record.quantity }}</span>
                    </div>
                    <div class="history-card-row">
                        <span class="history-card-label">ğŸ·ï¸ æ‰¹æ¬¡</span>
                        <span class="history-card-value">{{ record.batch_number|default:'--' }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <span class="material-icons">inbox</span>
            <div>æš‚æ— å†å²è®°å½•</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- åˆ†é¡µæ§ä»¶ -->
    {% if pagination and pagination.total_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination-controls">
            <!-- ä¸Šä¸€é¡µ -->
            {% if pagination.has_previous %}
            <a href="?page={{ pagination.previous_page }}&page_size={{ pagination.page_size }}{% if selected_warehouse %}&warehouse={{ selected_warehouse }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="pagination-btn">
                <span class="material-icons">chevron_left</span>
                ä¸Šä¸€é¡µ
            </a>
            {% else %}
            <span class="pagination-btn disabled">
                <span class="material-icons">chevron_left</span>
                ä¸Šä¸€é¡µ
            </span>
            {% endif %}
            
            <!-- é¡µç  -->
            <div class="page-numbers">
                {% for page_num in pagination.page_range %}
                    {% if page_num == pagination.current_page %}
                    <span class="page-number current">{{ page_num }}</span>
                    {% elif page_num == 1 or page_num == pagination.total_pages or page_num >= pagination.current_page|add:"-2" and page_num <= pagination.current_page|add:"2" %}
                    <a href="?page={{ page_num }}&page_size={{ pagination.page_size }}{% if selected_warehouse %}&warehouse={{ selected_warehouse }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="page-number">{{ page_num }}</a>
                    {% elif page_num == pagination.current_page|add:"-3" or page_num == pagination.current_page|add:"3" %}
                    <span class="page-ellipsis">...</span>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- ä¸‹ä¸€é¡µ -->
            {% if pagination.has_next %}
            <a href="?page={{ pagination.next_page }}&page_size={{ pagination.page_size }}{% if selected_warehouse %}&warehouse={{ selected_warehouse }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="pagination-btn">
                ä¸‹ä¸€é¡µ
                <span class="material-icons">chevron_right</span>
            </a>
            {% else %}
            <span class="pagination-btn disabled">
                ä¸‹ä¸€é¡µ
                <span class="material-icons">chevron_right</span>
            </span>
            {% endif %}
        </div>

        <!-- æ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰æ‹© -->
        <div class="page-size-selector">
            <label for="page-size">æ¯é¡µæ˜¾ç¤ºï¼š</label>
            <select id="page-size" onchange="changePageSize(this.value)">
                <option value="10" {% if pagination.page_size == 10 or not pagination.page_size %}selected{% endif %}>10æ¡</option>
                <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>20æ¡</option>
                <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>50æ¡</option>
                <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>100æ¡</option>
            </select>
        </div>
    </div>
    {% endif %}
</div>

<!-- æ¡Œé¢ç«¯è¡¨æ ¼ï¼Œç§»åŠ¨ç«¯éšè— -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ä¸šåŠ¡æ—¥æœŸ</th>
                <th>æˆæœ¬ä¸­å¿ƒ</th>
                <th>åº“å­˜ç»„ç»‡</th>
                <th>ç‰©æ–™åç§°</th>
                <th>æ•°é‡</th>
                <th>æ‰¹æ¬¡</th>
                <th>ä»“åº“åç§°</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>{{ record.FAuditTime|date:"Y-m-d" }}</td>
                <td>{{ record.cost_center }}</td>
                <td>{{ record.storageOrgUnitName }}</td>
                <td>{{ record.material_name }}</td>
                <td>{{ record.quantity }}</td>
                <td>{{ record.batch_number }}</td>
                <td>{{ record.warehouse_name }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center;">æš‚æ— è®°å½•</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆ é™¤åŠŸèƒ½ä¼˜åŒ–
    document.querySelectorAll('.btn-delete').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ­¤è®°å½•å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) return;
            
            const fnumber = btn.getAttribute('data-fnumber');
            
            // æ·»åŠ åŠ è½½çŠ¶æ€
            btn.classList.add('loading');
            const originalText = btn.innerHTML;
            
            fetch(`/production/raw-soil-storage/${fnumber}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(res => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!res.ok) {
                    // å¦‚æœä¸æ˜¯ JSON å“åº”ï¼Œå°è¯•è¯»å–æ–‡æœ¬
                    return res.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch {
                            throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
                        }
                    });
                }
                return res.json();
            })
            .then(data => {
                console.log('åˆ é™¤å“åº”', data);
                if (data.success) {
                    // æˆåŠŸæç¤º
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                    
                    // åŠ¨ç”»ç§»é™¤å¡ç‰‡
                    const card = btn.closest('.history-card-sectioned');
                    card.style.transition = 'all 0.3s ease';
                    card.style.transform = 'translateX(-100%)';
                    card.style.opacity = '0';
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 300);
                } else {
                    btn.classList.remove('loading');
                    btn.innerHTML = originalText;
                    alert('âŒ ' + (data.message || 'åˆ é™¤å¤±è´¥'));
                }
            })
            .catch((err) => {
                console.error('åˆ é™¤è¯·æ±‚å¼‚å¸¸', err);
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
                alert('âš ï¸ ç½‘ç»œé”™è¯¯ï¼š' + (err.message || 'è¯·é‡è¯•'));
            });
        });
    });
    
    // CSRF helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
    
    // å¡ç‰‡äº¤äº’æ•ˆæœ
    document.querySelectorAll('.history-card-sectioned').forEach(card => {
        card.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        
        card.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // æ¯é¡µæ˜¾ç¤ºæ•°é‡å˜åŒ–å¤„ç†
    window.changePageSize = function(pageSize) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page_size', pageSize);
        urlParams.set('page', '1'); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        
        // ä¿æŒæœç´¢å‚æ•°
        const warehouse = document.getElementById('warehouse').value;
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (warehouse) urlParams.set('warehouse', warehouse);
        if (startDate) urlParams.set('start_date', startDate);
        if (endDate) urlParams.set('end_date', endDate);
        
        window.location.href = window.location.pathname + '?' + urlParams.toString();
    };
    
    // æ¸…ç©ºæœç´¢æ¡ä»¶
    window.clearSearch = function() {
        // æ¸…ç©ºè¡¨å•å­—æ®µ
        document.getElementById('warehouse').value = '';
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        
        // æäº¤è¡¨å•ï¼ˆä¼šé‡ç½®åˆ°ç¬¬ä¸€é¡µï¼‰
        const urlParams = new URLSearchParams();
        urlParams.set('page', '1');
        urlParams.set('page_size', '10');
        window.location.href = window.location.pathname + '?' + urlParams.toString();
    };
    
    // æœç´¢è¡¨å•æäº¤å¤„ç†
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const urlParams = new URLSearchParams();
        
        // æ·»åŠ æœç´¢å‚æ•°
        const warehouse = document.getElementById('warehouse').value;
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (warehouse) urlParams.set('warehouse', warehouse);
        if (startDate) urlParams.set('start_date', startDate);
        if (endDate) urlParams.set('end_date', endDate);
        
        // é‡ç½®åˆ†é¡µåˆ°ç¬¬ä¸€é¡µ
        urlParams.set('page', '1');
        urlParams.set('page_size', '10');
        
        // è·³è½¬åˆ°æœç´¢ç»“æœ
        window.location.href = window.location.pathname + '?' + urlParams.toString();
    });
});
</script>
{% endblock %}



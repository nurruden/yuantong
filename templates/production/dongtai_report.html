{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<!-- Ê∑ªÂä†Flatpickr CSS -->
<link rel="stylesheet" href="/static/libs/flatpickr/flatpickr.min.css">
<link rel="stylesheet" href="/static/libs/flatpickr/material_blue.css">
<link rel="stylesheet" href="{% static 'css/icon-alignment-fix.css' %}">
<script src="/static/libs/flatpickr/flatpickr.min.js"></script>
<script src="/static/libs/flatpickr/zh.js"></script>
<style>
    .page-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .page-title h1 {
        margin: 0;
        font-size: 24px;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .form-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        -webkit-appearance: none;
        appearance: none;
    }
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    input[type="number"].form-control {
        -moz-appearance: textfield;
    }
    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        min-height: 44px;
        white-space: nowrap;
    }
    .btn-primary {
        background: linear-gradient(90deg, #81d4fa 0%, #a5d6a7 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #4fc3f7 0%, #66bb6a 100%);
        transform: translateY(-1px);
    }
    .btn-secondary {
        background: #e3f2fd;
        color: #1976d2;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-secondary:hover {
        background: #b3e5fc;
        transform: translateY(-1px);
    }
    .material-icons {
        vertical-align: middle;
        font-size: 20px;
        margin-right: 8px;
    }
    .submit-btn {
        width: 100%;
        margin-top: 20px;
        height: 48px;
        font-size: 18px;
    }
    .table-container {
        margin-top: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
        font-size: 14px;
    }
    th {
        background: #f5f5f5;
        font-weight: 500;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    tr:hover {
        background: #f9f9f9;
    }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
        .page-container {
            padding: 10px;
        }
        .page-title {
            flex-direction: column;
            align-items: stretch;
        }
        .page-title h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        .action-buttons {
            justify-content: center;
        }
        .form-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .form-group label {
            font-size: 16px;
        }
        .form-control {
            font-size: 16px;
            padding: 12px;
        }
        .btn {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
        }
        .table-container {
            margin: 10px -10px;
            border-radius: 0;
        }
        table {
            font-size: 14px;
        }
        th, td {
            padding: 10px;
        }
    }

    /* ÊöóËâ≤Ê®°ÂºèÊîØÊåÅ */
    @media (prefers-color-scheme: dark) {
        body {
            background: #121212;
            color: #fff;
        }
        .form-container, .table-container {
            background: #1e1e1e;
        }
        .form-control {
            background: #2d2d2d;
            border-color: #404040;
            color: #fff;
        }
        .form-group label {
            color: #e0e0e0;
        }
        th {
            background: #2d2d2d;
            color: #fff;
        }
        tr:hover {
            background: #2d2d2d;
        }
        td {
            border-bottom-color: #404040;
        }
    }

    /* Ëß¶Êë∏Â±è‰ºòÂåñ */
    @media (hover: none) {
        .btn:hover {
            transform: none;
        }
        .form-control:focus {
            font-size: 16px;
        }
    }

    .section-title {
        font-size: 18px;
        font-weight: 500;
        color: #1976d2;
        margin: 30px 0 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e3f2fd;
    }

    /* ÊöóËâ≤Ê®°ÂºèÊîØÊåÅ */
    @media (prefers-color-scheme: dark) {
        .section-title {
            color: #81d4fa;
            border-bottom-color: #404040;
        }
    }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
        .section-title {
            font-size: 16px;
            margin: 20px 0 10px;
            text-align: center;
        }
    }

    /* FlatpickrËá™ÂÆö‰πâÊ†∑Âºè */
    .flatpickr-calendar {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        box-shadow: 0 3px 13px rgba(0,0,0,0.08);
        border-radius: 8px;
    }

    .flatpickr-time {
        height: 50px;
        font-size: 16px;
    }

    .flatpickr-time input {
        font-size: 16px;
        height: 50px;
    }

    .numInputWrapper:hover {
        background: rgba(0,0,0,0.05);
    }

    .flatpickr-current-month {
        font-size: 16px;
    }

    /* ÁßªÂä®Á´Ø‰ºòÂåñ */
    @media (max-width: 768px) {
        .flatpickr-calendar {
            width: 100%;
            max-width: 320px;
        }

        .flatpickr-time {
            height: 60px;
        }

        .flatpickr-time input {
            height: 60px;
            font-size: 18px;
        }
    }

    .autocomplete-suggestions {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #eee;
        max-height: 200px;
        overflow-y: auto;
        z-index: 9999;
        width: 100%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-radius: 0 0 6px 6px;
    }
    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 15px;
    }
    .autocomplete-suggestion:hover, .autocomplete-suggestion.active {
        background: #f5f5f5;
    }
    /* ÂØºÂÖ•ÂäüËÉΩÊ†∑Âºè */
    .floating-import-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 16px rgba(129, 212, 250, 0.4);
        cursor: pointer;
        z-index: 999998;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .floating-import-btn:hover {
        transform: scale(1.1) translateY(-2px);
        box-shadow: 0 6px 24px rgba(129, 212, 250, 0.6);
    }
    .floating-import-btn:active {
        transform: scale(0.95);
    }
    .floating-import-btn .material-icons {
        font-size: 32px;
        margin: 0;
    }
    #importModal.modal {
        display: none;
        position: fixed !important;
        z-index: 999999 !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(4px);
        overflow-y: auto;
        animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    #importModal .modal-content {
        position: relative !important;
        z-index: 1000000 !important;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%) !important;
        margin: 5% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 560px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05) !important;
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: visible !important;
        display: flex !important;
        flex-direction: column !important;
    }
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 28px 32px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin: 0;
    }
    .modal-header h2 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .modal-header h2::before {
        content: 'üìä';
        font-size: 28px;
    }
    .close {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 32px;
        font-weight: 300;
        cursor: pointer !important;
        line-height: 1;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        position: relative;
        z-index: 1001;
        pointer-events: auto !important;
    }
    .close:hover {
        color: white !important;
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    .file-upload-area {
        border: 2.5px dashed #cbd5e0;
        border-radius: 16px;
        padding: 48px 24px;
        text-align: center;
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        margin: 24px 0;
        position: relative;
        z-index: 1;
        pointer-events: auto;
        user-select: none;
        -webkit-user-select: none;
        overflow: hidden;
    }
    .file-upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s;
    }
    .file-upload-area:hover::before {
        left: 100%;
    }
    .file-upload-area:hover {
        border-color: #667eea;
        background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
    }
    .file-upload-area.dragover {
        border-color: #667eea;
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border-width: 3px;
        transform: scale(1.02);
        box-shadow: 0 16px 32px rgba(102, 126, 234, 0.25);
    }
    .file-upload-area .file-upload-icon,
    .file-upload-area .file-upload-text,
    .file-upload-area .file-upload-hint {
        pointer-events: none;
        position: relative;
        z-index: 1;
    }
    .file-upload-icon {
        font-size: 64px;
        color: #667eea;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.2));
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-8px); }
    }
    .file-upload-text {
        color: #2d3748;
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 8px;
        letter-spacing: -0.3px;
    }
    .file-upload-hint {
        color: #718096;
        font-size: 14px;
        font-weight: 400;
    }
    .file-name {
        margin-top: 20px;
        padding: 14px 18px;
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border-radius: 12px;
        color: #4c1d95;
        font-size: 14px;
        font-weight: 500;
        display: none;
        border: 1px solid rgba(102, 126, 234, 0.2);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    .file-name.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .modal-actions {
        display: flex !important;
        gap: 12px;
        justify-content: flex-end;
        padding: 24px 32px 32px !important;
        background: #f8f9fa !important;
        border-top: 1px solid #e2e8f0;
        margin: 0 !important;
        position: relative !important;
        z-index: 100 !important;
        flex-shrink: 0;
        width: 100%;
        box-sizing: border-box;
    }
    .import-tip-section {
        padding: 24px 32px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-bottom: 1px solid #fcd34d;
        margin: 0;
    }
    .tip-header {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
    }
    .tip-icon-wrapper {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    .tip-icon {
        color: white;
        font-size: 24px;
    }
    .tip-content {
        flex: 1;
    }
    .tip-title {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 600;
        color: #92400e;
        letter-spacing: -0.3px;
    }
    .tip-text {
        margin: 0;
        color: #78350f;
        font-size: 14px;
        line-height: 1.6;
    }
    .download-button-wrapper {
        position: relative;
        display: inline-block;
    }
    .download-template-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .download-template-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    .download-template-btn:active:not(:disabled) {
        transform: translateY(0);
    }
    .download-template-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
    }
    .download-template-btn .material-icons {
        font-size: 20px;
    }
    .download-progress-tooltip {
        display: none;
        position: absolute;
        top: calc(100% + 12px);
        left: 0;
        padding: 12px 18px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 10px;
        font-size: 14px;
        white-space: nowrap;
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        z-index: 1000;
        animation: tooltipFadeIn 0.3s ease-out;
    }
    @keyframes tooltipFadeIn {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .download-progress-tooltip .progress-icon {
        font-size: 18px;
        vertical-align: middle;
        margin-right: 6px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .import-form {
        padding: 0;
        margin: 0;
        display: flex !important;
        flex-direction: column !important;
        flex: 1;
        min-height: 0;
    }
    .import-progress {
        display: none;
        margin: 24px 0;
        padding: 20px;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 12px;
        text-align: center;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    .import-progress.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }
    .progress-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-top-color: #3b82f6;
        border-radius: 50%;
        margin: 0 auto 12px;
        animation: spin 0.8s linear infinite;
    }
    .progress-text {
        color: #1e40af;
        font-size: 15px;
        font-weight: 500;
    }
    .error-messages {
        margin: 0 0 24px 0;
        padding: 16px 20px;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-radius: 12px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        border: 1px solid rgba(220, 38, 38, 0.2);
    }
    .error-messages.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }
    .error-message {
        color: #991b1b;
        font-size: 13px;
        margin-bottom: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 8px;
        line-height: 1.5;
    }
    .error-message:last-child {
        margin-bottom: 0;
    }
    .btn-cancel {
        padding: 12px 24px;
        background: white !important;
        color: #64748b !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
    }
    .btn-cancel:hover {
        background: #f8f9fa;
        border-color: #cbd5e0;
        color: #475569;
    }
    .btn-submit {
        padding: 12px 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 12px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        display: inline-flex !important;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .btn-submit:hover:not(:disabled) {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    .btn-submit:active:not(:disabled) {
        transform: translateY(0);
    }
    .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
    }
    .btn-submit .material-icons {
        font-size: 20px;
    }
</style>
{% endblock %}

{% block content %}
<script>
// ÂØºÂÖ•ÂäüËÉΩÁõ∏ÂÖ≥ÂáΩÊï∞ - ÂøÖÈ°ªÂú®È°µÈù¢Âä†ËΩΩÂâçÂÆö‰πâÔºåÁ°Æ‰øùonclickÂèØ‰ª•ËÆøÈóÆ
// ‰ΩøÁî®ÁÆÄÂçïÁöÑÂáΩÊï∞Â£∞ÊòéÔºåÁ°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂèØÁî®
function showImportModal() {
    const modal = document.getElementById('importModal');
    if (modal) {
        // Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÁöÑz-indexÊÅ¢Â§çÊ≠£Â∏∏ÔºåÈÅøÂÖçË¢´ÈÅÆÊå°
        modal.style.zIndex = '999999';
        modal.style.display = 'block';
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';
        // Á°Æ‰øùÂÖ≥Èó≠ÊåâÈíÆÂèØÁÇπÂáª
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
            closeBtn.style.pointerEvents = 'auto';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeImportModal();
                return false;
            };
        }
    }
}

function closeImportModal() {
    const modal = document.getElementById('importModal');
    if (modal) {
        modal.style.display = 'none';
        modal.style.opacity = '0';
    }
    const importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.reset();
    }
    const fileName = document.getElementById('fileName');
    if (fileName) {
        fileName.classList.remove('show');
        fileName.textContent = '';
    }
    // ÈáçÁΩÆÈîôËØØÊ∂àÊÅØ
    const errorMessages = document.getElementById('errorMessages');
    if (errorMessages) {
        errorMessages.classList.remove('show');
        errorMessages.innerHTML = '';
    }
    // ÈáçÁΩÆËøõÂ∫¶ÊèêÁ§∫
    const importProgress = document.getElementById('importProgress');
    if (importProgress) {
        importProgress.classList.remove('show');
    }
}

// Á°Æ‰øùÂáΩÊï∞ÁªëÂÆöÂà∞ window ÂØπË±°ÔºàÂèåÈáç‰øùÈô©Ôºâ
if (typeof window !== 'undefined') {
    window.showImportModal = showImportModal;
    window.closeImportModal = closeImportModal;
}

    // ‰∏ãËΩΩÊ®°ÊùøÂáΩÊï∞ - ÂøÖÈ°ªÂú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰ª•‰æøonclickÂèØ‰ª•Ë∞ÉÁî®
    // ‰ºòÂÖà‰ΩøÁî® File System Access API ÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°Ü
    function downloadDongtaiTemplate() {
        // Ëé∑ÂèñÊåâÈíÆÂíåËøõÂ∫¶ÊèêÁ§∫ÂÖÉÁ¥†
        const downloadBtn = document.getElementById('downloadTemplateBtn');
        const downloadBtnText = document.getElementById('downloadBtnText');
        const downloadIcon = document.getElementById('downloadIcon');
        const downloadProgress = document.getElementById('downloadProgress');
        
        // Â¶ÇÊûúÊåâÈíÆÂ∑≤Á¶ÅÁî®ÔºåËØ¥ÊòéÊ≠£Âú®‰∏ãËΩΩÔºåÁõ¥Êé•ËøîÂõû
        if (downloadBtn && downloadBtn.disabled) {
            return;
        }
        
        // ÈáçË¶ÅÔºöÂú®‰∏ãËΩΩ‰πãÂâçÔºåÂÖàÂÆåÂÖ®ÂÖ≥Èó≠ÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÔºåÈÅøÂÖçÈÅÆÊå°ÊµèËßàÂô®ÁöÑÊñá‰ª∂‰øùÂ≠òÂØπËØùÊ°Ü
        const importModal = document.getElementById('importModal');
        if (importModal) {
            // Ê£ÄÊü•Ê®°ÊÄÅÊ°ÜÊòØÂê¶ÂèØËßÅÔºàÈÄöËøádisplay„ÄÅopacityÊàñvisibilityÔºâ
            const isVisible = importModal.style.display === 'block' || 
                             importModal.style.display === '' ||
                             window.getComputedStyle(importModal).display !== 'none' ||
                             window.getComputedStyle(importModal).opacity !== '0';
            
            if (isVisible) {
                // Â¶ÇÊûúÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÊòØÊâìÂºÄÁöÑÔºåÂÖàÂÆåÂÖ®ÂÖ≥Èó≠ÂÆÉ
                if (typeof closeImportModal === 'function') {
                    closeImportModal();
                }
                // Âº∫Âà∂ËÆæÁΩÆÊ†∑ÂºèÔºåÁ°Æ‰øùÊ®°ÊÄÅÊ°ÜÂÆåÂÖ®ÈöêËóè
                importModal.style.display = 'none';
                importModal.style.opacity = '0';
                importModal.style.visibility = 'hidden';
                // Â∞Üz-indexËÆæÁΩÆ‰∏∫Ë¥üÂÄºÔºåÁ°Æ‰øù‰∏ç‰ºöÈÅÆÊå°ÊµèËßàÂô®ÁöÑÂØπËØùÊ°Ü
                importModal.style.zIndex = '-1';
                
                // Á≠âÂæÖÊ®°ÊÄÅÊ°ÜÂÆåÂÖ®ÂÖ≥Èó≠ÔºàÂ¢ûÂä†Âª∂ËøüÊó∂Èó¥ÔºåÁ°Æ‰øùÂä®ÁîªÂÆåÊàêÔºâ
                setTimeout(() => {
                    startDownload();
                }, 500);
            } else {
                startDownload();
            }
        } else {
            startDownload();
        }
        
        function startDownload() {
            const url = '{% url "dongtai_report_download_template" %}';
            const startTime = Date.now(); // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥ÔºåÁî®‰∫éÊó•Âøó
            
            // Êõ¥Êñ∞UIÔºöÁ¶ÅÁî®ÊåâÈíÆÔºåÊòæÁ§∫ËøõÂ∫¶ÊèêÁ§∫
            if (downloadBtn) {
                downloadBtn.disabled = true;
            }
            if (downloadBtnText) {
                downloadBtnText.textContent = 'Ê≠£Âú®‰∏ãËΩΩ...';
            }
            if (downloadIcon) {
                downloadIcon.textContent = 'hourglass_empty';
            }
            if (downloadProgress) {
                downloadProgress.style.display = 'block';
                const progressText = downloadProgress.querySelector('.progress-text');
                if (progressText) {
                    progressText.textContent = 'Ê≠£Âú®‰∏ãËΩΩÊ®°ÊùøÔºåËØ∑Á®çÂÄô...';
                }
                downloadProgress.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
            }
            
            // ËÆ∞ÂΩï‰∏ãËΩΩÂºÄÂßãÊó•Âøó
            console.log('[‰∏ãËΩΩÊ®°Êùø] ÂºÄÂßã‰∏ãËΩΩ‰∏úÊ≥∞QCÊä•Ë°®ÂØºÂÖ•Ê®°Êùø', {
                url: url,
                timestamp: new Date().toISOString()
            });
            
            // ÊÅ¢Â§çUIÁä∂ÊÄÅÁöÑËæÖÂä©ÂáΩÊï∞
            function restoreUI() {
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                }
                if (downloadBtnText) {
                    downloadBtnText.textContent = '‰∏ãËΩΩÂØºÂÖ•Ê®°Êùø';
                }
                if (downloadIcon) {
                    downloadIcon.textContent = 'download';
                }
                if (downloadProgress) {
                    downloadProgress.style.display = 'none';
                }
            }
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫ÁöÑËæÖÂä©ÂáΩÊï∞
            function showSuccessMessage(message) {
                if (downloadProgress) {
                    downloadProgress.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    downloadProgress.innerHTML = '<span class="material-icons progress-icon">check_circle</span><span class="progress-text">' + message + '</span>';
                    downloadProgress.style.display = 'block';
                    setTimeout(() => {
                        downloadProgress.style.display = 'none';
                        downloadProgress.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                        downloadProgress.innerHTML = '<span class="material-icons progress-icon">hourglass_empty</span><span class="progress-text">Ê≠£Âú®‰∏ãËΩΩÊ®°ÊùøÔºåËØ∑Á®çÂÄô...</span>';
                    }, 3000);
                }
            }
            
            
            // ÊñπÊ≥ï1Ôºö‰ºòÂÖà‰ΩøÁî® File System Access APIÔºàÁé∞‰ª£ÊµèËßàÂô®ÊîØÊåÅÔºåÂèØ‰ª•Áõ¥Êé•ÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°ÜÔºâ
            // Ê≥®ÊÑèÔºöshowSaveFilePicker ÂøÖÈ°ªÂú®Áî®Êà∑ÊâãÂäøËß¶ÂèëÁöÑ‰∏ä‰∏ãÊñá‰∏≠Ë∞ÉÁî®ÔºàÂ¶ÇÁÇπÂáª‰∫ã‰ª∂Ôºâ
            if ('showSaveFilePicker' in window) {
                // ÂÖàËé∑ÂèñÊñá‰ª∂Êï∞ÊçÆ
                fetch(url, {
                    method: 'GET',
                    credentials: 'same-origin',
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('‰∏ãËΩΩÂ§±Ë¥•Ôºö' + response.statusText + ' (Áä∂ÊÄÅÁ†Å: ' + response.status + ')');
                    }
                    return response.blob();
                })
        .then(async blob => {
            const downloadDuration = Date.now() - startTime;
            const fileSize = (blob.size / 1024).toFixed(2); // KB
            
            // Âú®ÂºπÂá∫Êñá‰ª∂‰øùÂ≠òÂØπËØùÊ°Ü‰πãÂâçÔºåÂÖàÂÆåÂÖ®ÈöêËóèÊâÄÊúâÂèØËÉΩÈÅÆÊå°ÁöÑUIÂÖÉÁ¥†
            // Á°Æ‰øùÊµèËßàÂô®ÁöÑ‰øùÂ≠òÂØπËØùÊ°Ü‰∏ç‰ºöË¢´ÈÅÆÊå°
            restoreUI(); // ÂÖàÊÅ¢Â§çUIÁä∂ÊÄÅÔºåÈöêËóèÊâÄÊúâËøõÂ∫¶ÊèêÁ§∫
            
            // Á°Æ‰øùÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÂÆåÂÖ®ÈöêËóèÔºàÂèåÈáç‰øùÈô©Ôºâ
            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.style.display = 'none';
                importModal.style.opacity = '0';
                importModal.style.visibility = 'hidden';
                importModal.style.zIndex = '-1';
            }
            
            // ‰ΩøÁî® setTimeout Á°Æ‰øùÂú®‰∏ã‰∏Ä‰∏™‰∫ã‰ª∂Âæ™ÁéØ‰∏≠ÂºπÂá∫ÂØπËØùÊ°Ü
            // ËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùÊâÄÊúâUIÂÖÉÁ¥†ÈÉΩÂ∑≤ÁªèÂÆåÂÖ®ÈöêËóèÔºå‰∏ç‰ºöÈÅÆÊå°ÊµèËßàÂô®ÁöÑÂØπËØùÊ°Ü
            await new Promise(resolve => setTimeout(resolve, 100));
                    
                    try {
                        // ‰ΩøÁî® File System Access API ÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°Ü
                        // Ëøô‰ºöÁõ¥Êé•ÂºπÂá∫Á≥ªÁªüÁöÑ"Âè¶Â≠ò‰∏∫"ÂØπËØùÊ°ÜÔºåËÆ©Áî®Êà∑ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ
                        // Ê≥®ÊÑèÔºöÂøÖÈ°ªÂú®Áî®Êà∑ÊâãÂäøËß¶ÂèëÁöÑ‰∏ä‰∏ãÊñá‰∏≠Ë∞ÉÁî®Ôºå‰∏î‰∏çËÉΩÊúâÈÅÆÊå°ÁöÑUIÂÖÉÁ¥†
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: '‰∏úÊ≥∞QCÊä•Ë°®ÂØºÂÖ•Ê®°Êùø.xlsx',
                            types: [{
                                description: 'ExcelÊñá‰ª∂',
                                accept: {
                                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                                }
                            }]
                        });
                        
                        // Áî®Êà∑ÈÄâÊã©‰∫Ü‰øùÂ≠ò‰ΩçÁΩÆÔºåÂÜôÂÖ•Êñá‰ª∂
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        // ËÆ∞ÂΩï‰∏ãËΩΩÊàêÂäüÊó•Âøó
                        console.log('[‰∏ãËΩΩÊ®°Êùø] ‰∏ãËΩΩÊàêÂäüÔºàÁî®Êà∑ÈÄâÊã©Ë∑ØÂæÑÔºâ', {
                            filename: '‰∏úÊ≥∞QCÊä•Ë°®ÂØºÂÖ•Ê®°Êùø.xlsx',
                            fileSize: fileSize + ' KB',
                            duration: downloadDuration + ' ms',
                            timestamp: new Date().toISOString()
                        });
                        
                        // ÊÅ¢Â§çUIÁä∂ÊÄÅ
                        restoreUI();
                        
                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        showSuccessMessage('‰∏ãËΩΩÊàêÂäüÔºÅÊñá‰ª∂Â∑≤‰øùÂ≠òÂà∞ÊÇ®ÈÄâÊã©ÁöÑ‰ΩçÁΩÆ');
                        
                    } catch (saveError) {
                        // Â§ÑÁêÜÈîôËØØ
                        if (saveError.name === 'AbortError') {
                            // Áî®Êà∑ÂèñÊ∂à‰∫Ü‰øùÂ≠òÂØπËØùÊ°Ü
                            console.log('[‰∏ãËΩΩÊ®°Êùø] Áî®Êà∑ÂèñÊ∂à‰∫Ü‰øùÂ≠òÂØπËØùÊ°Ü');
                            restoreUI();
                        } else {
                            // ÂÖ∂‰ªñÈîôËØØÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï - Áõ¥Êé•‰ΩøÁî®ÊúçÂä°Âô®URL
                            console.warn('[‰∏ãËΩΩÊ®°Êùø] File System Access APIÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï:', saveError);
                            restoreUI();
                            
                            // Á°Æ‰øùÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÂÆåÂÖ®ÈöêËóè
                            const importModal = document.getElementById('importModal');
                            if (importModal) {
                                importModal.style.display = 'none';
                                importModal.style.opacity = '0';
                                importModal.style.visibility = 'hidden';
                                importModal.style.zIndex = '-1';
                            }
                            
                            // Á≠âÂæÖ‰∏Ä‰∏ãÔºåÁ°Æ‰øùÊâÄÊúâUIÂÖÉÁ¥†ÈÉΩÂ∑≤ÈöêËóè
                            setTimeout(() => {
                                // ÂàõÂª∫‰ºòÈõÖÁöÑ‰∏ãËΩΩÊèêÁ§∫Âç°Áâá
                                const downloadCard = document.createElement('div');
                                downloadCard.style.cssText = `
                                    position: fixed;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    background: #ffffff;
                                    border-radius: 20px;
                                    padding: 0;
                                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
                                    z-index: 2147483647;
                                    min-width: 420px;
                                    max-width: 500px;
                                    overflow: hidden;
                                    animation: fadeInScale 0.3s ease-out;
                                `;
                                
                                // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
                                if (!document.getElementById('downloadCardStyles')) {
                                    const style = document.createElement('style');
                                    style.id = 'downloadCardStyles';
                                    style.textContent = `
                                        @keyframes fadeInScale {
                                            from {
                                                opacity: 0;
                                                transform: translate(-50%, -50%) scale(0.9);
                                            }
                                            to {
                                                opacity: 1;
                                                transform: translate(-50%, -50%) scale(1);
                                            }
                                        }
                                    `;
                                    document.head.appendChild(style);
                                }
                                
                                // ÂàõÂª∫Âç°ÁâáÂ§¥ÈÉ®ÔºàÂ∏¶ÂõæÊ†áÔºâ
                                const cardHeader = document.createElement('div');
                                cardHeader.style.cssText = `
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    padding: 32px 32px 24px;
                                    text-align: center;
                                    color: white;
                                `;
                                const headerIcon = document.createElement('div');
                                headerIcon.innerHTML = '<span class="material-icons" style="font-size: 48px; opacity: 0.95;">cloud_download</span>';
                                headerIcon.style.cssText = 'margin-bottom: 12px;';
                                const headerTitle = document.createElement('div');
                                headerTitle.textContent = '‰∏ãËΩΩÊ®°ÊùøÊñá‰ª∂';
                                headerTitle.style.cssText = 'font-size: 22px; font-weight: 600; letter-spacing: -0.5px;';
                                cardHeader.appendChild(headerIcon);
                                cardHeader.appendChild(headerTitle);
                                
                                // ÂàõÂª∫Âç°ÁâáÂÜÖÂÆπ
                                const cardContent = document.createElement('div');
                                cardContent.style.cssText = `
                                    padding: 24px 32px 32px;
                                    text-align: center;
                                `;
                                const tipText = document.createElement('div');
                                tipText.innerHTML = 'ÁÇπÂáª‰∏ãÊñπÊåâÈíÆ‰∏ãËΩΩÊñá‰ª∂ÔºåÊµèËßàÂô®‰ºöÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°ÜÔºåÊÇ®ÂèØ‰ª•ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ';
                                tipText.style.cssText = `
                                    color: #6b7280;
                                    font-size: 15px;
                                    line-height: 1.6;
                                    margin-bottom: 24px;
                                `;
                                
                                // ÂàõÂª∫‰∏ãËΩΩÊåâÈíÆ
                                const downloadLink = document.createElement('a');
                                downloadLink.href = url;
                                downloadLink.download = '‰∏úÊ≥∞QCÊä•Ë°®ÂØºÂÖ•Ê®°Êùø.xlsx';
                                downloadLink.target = '_blank';
                                downloadLink.innerHTML = `
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 10px; font-size: 22px;">file_download</span>
                                    <span>‰∏ãËΩΩÊ®°ÊùøÊñá‰ª∂</span>
                                `;
                                downloadLink.style.cssText = `
                                    display: inline-flex;
                                    align-items: center;
                                    justify-content: center;
                                    padding: 14px 32px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    text-decoration: none;
                                    border-radius: 12px;
                                    font-weight: 600;
                                    font-size: 16px;
                                    cursor: pointer;
                                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                                    transition: all 0.2s ease;
                                    border: none;
                                    min-width: 200px;
                                `;
                                downloadLink.onmouseover = function() { 
                                    this.style.transform = 'translateY(-2px)';
                                    this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';
                                };
                                downloadLink.onmouseout = function() { 
                                    this.style.transform = 'translateY(0)';
                                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                                };
                                
                                // ÁªÑË£ÖÂç°Áâá
                                cardContent.appendChild(tipText);
                                cardContent.appendChild(downloadLink);
                                downloadCard.appendChild(cardHeader);
                                downloadCard.appendChild(cardContent);
                                
                                // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
                                const overlay = document.createElement('div');
                                overlay.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.4);
                                    backdrop-filter: blur(4px);
                                    z-index: 2147483646;
                                    animation: fadeIn 0.2s ease-out;
                                `;
                                
                                // Ê∑ªÂä†ÈÅÆÁΩ©Âä®Áîª
                                if (!document.getElementById('overlayStyles')) {
                                    const style = document.createElement('style');
                                    style.id = 'overlayStyles';
                                    style.textContent = `
                                        @keyframes fadeIn {
                                            from { opacity: 0; }
                                            to { opacity: 1; }
                                        }
                                    `;
                                    document.head.appendChild(style);
                                }
                                
                                // Ê∑ªÂä†Âà∞È°µÈù¢
                                document.body.appendChild(overlay);
                                document.body.appendChild(downloadCard);
                                
                                // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
                                overlay.addEventListener('click', function() {
                                    closeDownloadCard();
                                });
                                
                                // ÁÇπÂáª‰∏ãËΩΩÊåâÈíÆ
                                downloadLink.addEventListener('click', function() {
                                    // ÂÖàÂÖ≥Èó≠Âç°Áâá
                                    closeDownloadCard();
                                    // ÁÑ∂ÂêéÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                                    setTimeout(() => {
                                        showSuccessMessage('Êñá‰ª∂Â∑≤ÂºÄÂßã‰∏ãËΩΩÔºÅÊµèËßàÂô®‰ºöÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°Ü');
                                    }, 500);
                                });
                                
                                // ÂÖ≥Èó≠Âç°ÁâáÂáΩÊï∞
                                function closeDownloadCard() {
                                    downloadCard.style.animation = 'fadeInScale 0.2s ease-out reverse';
                                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                                    setTimeout(() => {
                                        if (downloadCard.parentNode) {
                                            downloadCard.parentNode.removeChild(downloadCard);
                                        }
                                        if (overlay.parentNode) {
                                            overlay.parentNode.removeChild(overlay);
                                        }
                                    }, 200);
                                }
                            }, 300);
                        }
                    }
                })
                .catch(error => {
                    // Ëé∑ÂèñÊñá‰ª∂Â§±Ë¥•
                    const downloadDuration = Date.now() - startTime;
                    console.error('[‰∏ãËΩΩÊ®°Êùø] Ëé∑ÂèñÊñá‰ª∂Â§±Ë¥•', {
                        error: error.message,
                        duration: downloadDuration + ' ms',
                        timestamp: new Date().toISOString()
                    });
                    restoreUI();
                    alert('‰∏ãËΩΩÊ®°ÊùøÂ§±Ë¥•Ôºö' + error.message + '\n\nÂ¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåËØ∑Ôºö\n1. Ê£ÄÊü•ÁΩëÁªúËøûÊé•\n2. Á°ÆËÆ§Â∑≤ÁôªÂΩïÁ≥ªÁªü\n3. ËÅîÁ≥ªÁÆ°ÁêÜÂëò');
                });
                
                // ‰ΩøÁî® File System Access APIÔºåÊèêÂâçËøîÂõû
                return;
            }
            
            // ÊñπÊ≥ï2ÔºöÂ§áÁî®ÊñπÊ≥ï - ÊµèËßàÂô®‰∏çÊîØÊåÅ File System Access API
            // Áõ¥Êé•‰ΩøÁî®ÊúçÂä°Âô®URLËß¶Âèë‰∏ãËΩΩÔºåËÆ©ÊµèËßàÂô®Â§ÑÁêÜ‰øùÂ≠òÂØπËØùÊ°Ü
            // ÂÖàÂÆåÂÖ®ÈöêËóèÊâÄÊúâÂèØËÉΩÈÅÆÊå°ÁöÑUIÂÖÉÁ¥†
            restoreUI();
            
            // Á°Æ‰øùÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÂÆåÂÖ®ÈöêËóè
            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.style.display = 'none';
                importModal.style.opacity = '0';
                importModal.style.visibility = 'hidden';
                importModal.style.zIndex = '-1';
            }
            
            // Á≠âÂæÖ‰∏Ä‰∏ãÔºåÁ°Æ‰øùÊâÄÊúâUIÂÖÉÁ¥†ÈÉΩÂ∑≤ÈöêËóè
            setTimeout(() => {
                // ÂàõÂª∫‰ºòÈõÖÁöÑ‰∏ãËΩΩÊèêÁ§∫Âç°ÁâáÔºà‰∏éFile System Access APIÂ§±Ë¥•Êó∂ÁöÑËÆæËÆ°‰∏ÄËá¥Ôºâ
                const downloadCard = document.createElement('div');
                downloadCard.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #ffffff;
                    border-radius: 20px;
                    padding: 0;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
                    z-index: 2147483647;
                    min-width: 420px;
                    max-width: 500px;
                    overflow: hidden;
                    animation: fadeInScale 0.3s ease-out;
                `;
                
                // Ê∑ªÂä†Âä®ÁîªÊ†∑ÂºèÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÔºâ
                if (!document.getElementById('downloadCardStyles')) {
                    const style = document.createElement('style');
                    style.id = 'downloadCardStyles';
                    style.textContent = `
                        @keyframes fadeInScale {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -50%) scale(0.9);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%) scale(1);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // ÂàõÂª∫Âç°ÁâáÂ§¥ÈÉ®ÔºàÂ∏¶ÂõæÊ†áÔºâ
                const cardHeader = document.createElement('div');
                cardHeader.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 32px 32px 24px;
                    text-align: center;
                    color: white;
                `;
                const headerIcon = document.createElement('div');
                headerIcon.innerHTML = '<span class="material-icons" style="font-size: 48px; opacity: 0.95;">cloud_download</span>';
                headerIcon.style.cssText = 'margin-bottom: 12px;';
                const headerTitle = document.createElement('div');
                headerTitle.textContent = '‰∏ãËΩΩÊ®°ÊùøÊñá‰ª∂';
                headerTitle.style.cssText = 'font-size: 22px; font-weight: 600; letter-spacing: -0.5px;';
                cardHeader.appendChild(headerIcon);
                cardHeader.appendChild(headerTitle);
                
                // ÂàõÂª∫Âç°ÁâáÂÜÖÂÆπ
                const cardContent = document.createElement('div');
                cardContent.style.cssText = `
                    padding: 24px 32px 32px;
                    text-align: center;
                `;
                const tipText = document.createElement('div');
                tipText.innerHTML = 'ÁÇπÂáª‰∏ãÊñπÊåâÈíÆ‰∏ãËΩΩÊñá‰ª∂ÔºåÊµèËßàÂô®‰ºöÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°ÜÔºåÊÇ®ÂèØ‰ª•ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ';
                tipText.style.cssText = `
                    color: #6b7280;
                    font-size: 15px;
                    line-height: 1.6;
                    margin-bottom: 24px;
                `;
                
                // ÂàõÂª∫‰∏ãËΩΩÊåâÈíÆ
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = '‰∏úÊ≥∞QCÊä•Ë°®ÂØºÂÖ•Ê®°Êùø.xlsx';
                downloadLink.target = '_blank';
                downloadLink.innerHTML = `
                    <span class="material-icons" style="vertical-align: middle; margin-right: 10px; font-size: 22px;">file_download</span>
                    <span>‰∏ãËΩΩÊ®°ÊùøÊñá‰ª∂</span>
                `;
                downloadLink.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    padding: 14px 32px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    text-decoration: none;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 16px;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    transition: all 0.2s ease;
                    border: none;
                    min-width: 200px;
                `;
                downloadLink.onmouseover = function() { 
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';
                };
                downloadLink.onmouseout = function() { 
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                };
                
                // ÁªÑË£ÖÂç°Áâá
                cardContent.appendChild(tipText);
                cardContent.appendChild(downloadLink);
                downloadCard.appendChild(cardHeader);
                downloadCard.appendChild(cardContent);
                
                // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(4px);
                    z-index: 2147483646;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                // Ê∑ªÂä†ÈÅÆÁΩ©Âä®ÁîªÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÔºâ
                if (!document.getElementById('overlayStyles')) {
                    const style = document.createElement('style');
                    style.id = 'overlayStyles';
                    style.textContent = `
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(overlay);
                document.body.appendChild(downloadCard);
                
                // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
                overlay.addEventListener('click', function() {
                    closeDownloadCard();
                });
                
                // ÁÇπÂáª‰∏ãËΩΩÊåâÈíÆ
                downloadLink.addEventListener('click', function() {
                    // ÂÖàÂÖ≥Èó≠Âç°Áâá
                    closeDownloadCard();
                    // ÁÑ∂ÂêéÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                    setTimeout(() => {
                        // Áõ¥Êé•‰ΩøÁî®downloadProgressÂÖÉÁ¥†ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        const downloadProgress = document.getElementById('downloadProgress');
                        if (downloadProgress) {
                            downloadProgress.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                            downloadProgress.innerHTML = '<span class="material-icons progress-icon">check_circle</span><span class="progress-text">Êñá‰ª∂Â∑≤ÂºÄÂßã‰∏ãËΩΩÔºÅÊµèËßàÂô®‰ºöÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°Ü</span>';
                            downloadProgress.style.display = 'block';
                            setTimeout(() => {
                                downloadProgress.style.display = 'none';
                                downloadProgress.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                                downloadProgress.innerHTML = '<span class="material-icons progress-icon">hourglass_empty</span><span class="progress-text">Ê≠£Âú®‰∏ãËΩΩÊ®°ÊùøÔºåËØ∑Á®çÂÄô...</span>';
                            }, 3000);
                        } else {
                            // Â¶ÇÊûúdownloadProgress‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®alert
                            alert('Êñá‰ª∂Â∑≤ÂºÄÂßã‰∏ãËΩΩÔºÅÊµèËßàÂô®‰ºöÂºπÂá∫‰øùÂ≠òÂØπËØùÊ°ÜËÆ©ÊÇ®ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ');
                        }
                    }, 500);
                });
                
                // ÂÖ≥Èó≠Âç°ÁâáÂáΩÊï∞
                function closeDownloadCard() {
                    downloadCard.style.animation = 'fadeInScale 0.2s ease-out reverse';
                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => {
                        if (downloadCard.parentNode) {
                            downloadCard.parentNode.removeChild(downloadCard);
                        }
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 200);
                }
                
                // ËÆ∞ÂΩï‰∏ãËΩΩÊó•Âøó
                console.log('[‰∏ãËΩΩÊ®°Êùø] ÊòæÁ§∫‰∏ãËΩΩÈìæÊé•ÔºàÂ§áÁî®ÊñπÊ≥ïÔºâ', {
                    url: url,
                    timestamp: new Date().toISOString(),
                    note: 'ÊòæÁ§∫‰ºòÈõÖÁöÑ‰∏ãËΩΩÂç°ÁâáÔºåËÆ©Áî®Êà∑ÊâãÂä®ÁÇπÂáª'
                });
            }, 300);
        } // ÁªìÊùü startDownload ÂáΩÊï∞
    
}

// Á°Æ‰øùÂáΩÊï∞ÁªëÂÆöÂà∞ window ÂØπË±°
if (typeof window !== 'undefined') {
    window.downloadDongtaiTemplate = downloadDongtaiTemplate;
}
</script>

<div class="page-container">
    <div class="page-title">
        <h1>‰∏úÊ≥∞QCÊä•Ë°®</h1>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='{% url 'qc_report' %}'">
                <span class="material-icons">arrow_back</span> ËøîÂõû
            </button>
            <button id="favoriteBtn" class="btn btn-secondary" type="button">
                <span class="material-icons" id="favoriteIcon">star_border</span> <span id="favoriteText">Êî∂Ëóè</span>
            </button>
            <button class="btn btn-secondary" onclick="showImportModal()">
                <span class="material-icons">upload_file</span> ÂØºÂÖ•Excel
            </button>
            <button class="btn btn-primary" onclick="window.location.href='{% url 'dongtai_report_history' %}'">
                <span class="material-icons">history</span> Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï
            </button>
        </div>
    </div>

    <div class="form-container">
        <form id="qcForm" method="post">
            {% csrf_token %}
            <!-- ÂøÖË¶Å‰ø°ÊÅØ -->
            <h3 class="section-title">ÂøÖË¶Å‰ø°ÊÅØ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="material_type">Áâ©ÊñôÁ±ªÂûã</label>
                    <select id="material_type" name="material_type" class="form-control">
                        <option value="Âä©ÁÜîÁÖÖÁÉßÂìÅ" selected>Âä©ÁÜîÁÖÖÁÉßÂìÅ</option>
                        <option value="ÁÖÖÁÉßÂìÅ">ÁÖÖÁÉßÂìÅ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dongtai_permeability_coefficient">‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞</label>
                    <input type="number" id="dongtai_permeability_coefficient" name="dongtai_permeability_coefficient" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="dongtai_sample_weight">‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáè</label>
                    <input type="number" id="dongtai_sample_weight" name="dongtai_sample_weight" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="dongtai_filter_area">‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØ</label>
                    <input type="number" id="dongtai_filter_area" name="dongtai_filter_area" class="form-control" step="0.01">
                </div>
            </div>

            <!-- Âü∫Êú¨‰ø°ÊÅØ -->
            <h3 class="section-title">Âü∫Êú¨‰ø°ÊÅØ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="date">Êó•Êúü<span style="color:red">*</span></label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="time">Êó∂Èó¥<span style="color:red">*</span></label>
                    <input type="time" id="time" name="time" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="moisture_after_drying">ÁÉòÂπ≤ÂêéÂéüÂúüÊ∞¥ÂàÜ(%)</label>
                    <input type="number" id="moisture_after_drying" name="moisture_after_drying" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="alkali_content">ÂÖ•Á™ëÂâçÁ¢±Âê´Èáè(%)</label>
                    <input type="number" id="alkali_content" name="alkali_content" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="flux">Âä©Ê∫∂ÂâÇÊ∑ªÂä†ÊØî‰æã</label>
                    <input type="text" id="flux" name="flux" class="form-control">
                </div>
                <div class="form-group">
                    <label for="product_name">‰∫ßÂìÅÂûãÂè∑<span style="color:red">*</span></label>
                    <input type="text" id="product_name" name="product_name" class="form-control" required autocomplete="off">
                </div>
            </div>

            <!-- Ê∏óÈÄèÊµãËØï -->
            <h3 class="section-title">Ê∏óÈÄèÊµãËØï</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="permeability">ËøúÈÄöÊ∏óÈÄèÁéá(Darcy)</label>
                    <input type="number" id="permeability" name="permeability" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="permeability_long">ÈïøÂØåÊ∏óÈÄèÁéá(Darcy)</label>
                    <input type="number" id="permeability_long" name="permeability_long" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="filter_time">ËøáÊª§Êó∂Èó¥(Áßí)</label>
                    <input type="number" id="filter_time" name="filter_time" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="water_viscosity">Ê∞¥ÈªèÂ∫¶(mPa.s)</label>
                    <input type="number" id="water_viscosity" name="water_viscosity" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="cake_thickness">È•ºÂéö(mm)</label>
                    <input type="number" id="cake_thickness" name="cake_thickness" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="wet_cake_density">È•ºÂØÜÂ∫¶(g/cm3)</label>
                    <input type="number" id="wet_cake_density" name="wet_cake_density" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="yuantong_cake_density">ËøúÈÄöÈ•ºÂØÜÂ∫¶(g/cm3)</label>
                    <input type="number" id="yuantong_cake_density" name="yuantong_cake_density" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="changfu_cake_density">ÈïøÂØåÈ•ºÂØÜÂ∫¶(g/cm3)</label>
                    <input type="number" id="changfu_cake_density" name="changfu_cake_density" class="form-control" step="0.001">
                </div>

                <div class="form-group">
                    <label for="bulk_density">ÊåØÂÆûÂØÜÂ∫¶(g/cm3)</label>
                    <input type="number" id="bulk_density" name="bulk_density" class="form-control" step="0.001">
                </div>
            </div>

            <!-- Á≠õÂàÜÊï∞ÊçÆ -->
            <h3 class="section-title">Á≠õÂàÜÊï∞ÊçÆ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_14m">+14M (%)</label>
                    <input type="number" id="sieving_14m" name="sieving_14m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_30m">+30M (%)</label>
                    <input type="number" id="sieving_30m" name="sieving_30m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_40m">+40M</label>
                    <input type="number" id="sieving_40m" name="sieving_40m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_80m">+80M</label>
                    <input type="number" id="sieving_80m" name="sieving_80m" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_100m">+100M</label>
                    <input type="text" id="sieving_100m" name="sieving_100m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_150m">+150M</label>
                    <input type="text" id="sieving_150m" name="sieving_150m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_200m">+200M</label>
                    <input type="text" id="sieving_200m" name="sieving_200m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_325m">+325M</label>
                    <input type="text" id="sieving_325m" name="sieving_325m" class="form-control">
                </div>
            </div>
            <!-- ÂèØÊ∫∂ÊÄßÈáëÂ±û -->
            <h3 class="section-title">ÂèØÊ∫∂ÊÄßÈáëÂ±û</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="fe_ion">ÈìÅÁ¶ªÂ≠ê(mg/kg)</label>
                    <input type="number" id="fe_ion" name="fe_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="ca_ion">ÈíôÁ¶ªÂ≠ê(mg/kg)</label>
                    <input type="number" id="ca_ion" name="ca_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="al_ion">ÈìùÁ¶ªÂ≠ê(mg/kg)</label>
                    <input type="number" id="al_ion" name="al_ion" class="form-control" step="0.01">
                </div>
            </div>

            <!-- ÂÖ∂‰ªñ‰ø°ÊÅØ -->
            <h3 class="section-title">ÂÖ∂‰ªñ‰ø°ÊÅØ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="brightness">ÁôΩÂ∫¶</label>
                    <input type="number" id="brightness" name="brightness" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="swirl">Ê∂°ÂÄº(cm)</label>
                    <input type="text" id="swirl" name="swirl" class="form-control">
                </div>
                <div class="form-group">
                    <label for="odor">Ê∞îÂë≥</label>
                    <input type="number" id="odor" name="odor" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="conductance">‚ö°ÁîµÂØºÂÄº(ms/cm)</label>
                    <input type="number" id="conductance" name="conductance" class="form-control" step="0.01">
                </div>

            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="ph">pH</label>
                    <input type="number" id="ph" name="ph" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="oil_absorption">Âê∏Ê≤πÁéá(%)</label>
                    <input type="number" id="oil_absorption" name="oil_absorption" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="water_absorption">Âê∏Ê∞¥Áéá(%)</label>
                    <input type="number" id="water_absorption" name="water_absorption" class="form-control" step="0.01">
                </div>

                <div class="form-group">
                    <label for="moisture">Ê∞¥ÂàÜ(%)</label>
                    <input type="number" id="moisture" name="moisture" class="form-control" step="0.01">
                </div>


            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bags">Ë¢ãÊï∞<span style="color:red">*</span></label>
                    <input type="number" id="bags" name="bags" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="packaging">ÂåÖË£ÖÁ±ªÂûã<span style="color:red">*</span></label>
                    <input type="text" id="packaging" name="packaging" class="form-control" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="tons">Âê®</label>
                    <input type="number" id="tons" name="tons" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="batch_number">LOTÊâπÂè∑</label>
                    <input type="text" id="batch_number" name="batch_number" class="form-control">
                </div>

            </div>
            <div class="form-row">


                <div class="form-group" style="grid-column: span 2;">
                    <label for="remarks">Â§áÊ≥®</label>
                    <input type="text" id="remarks" name="remarks" class="form-control">
                </div>
                <div class="form-group">
                    <label for="shift">Áè≠ÁªÑ<span style="color:red">*</span></label>
                    <select id="shift" name="shift" class="form-control" required>
                        <option value="">ËØ∑ÈÄâÊã©Áè≠ÁªÑ</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary submit-btn">
                <span class="material-icons">save</span> ‰øùÂ≠òÊï∞ÊçÆ
            </button>
        </form>
    </div>
</div>

<script>
// Ê≥®ÊÑèÔºöshowImportModal Âíå closeImportModal ÂáΩÊï∞Â∑≤Âú®È°µÈù¢ÂºÄÂ§¥ÂÆö‰πâ
// ËøôÈáåÂè™ÂåÖÂê´È°µÈù¢ÂàùÂßãÂåñ‰ª£Á†Å

document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñÊó•ÊúüÈÄâÊã©Âô®
    flatpickr("#date", {
        locale: window.flatpickr.l10ns.zh,
        dateFormat: "Y-m-d",
        defaultDate: new Date()
    });

    // ÂàùÂßãÂåñÊó∂Èó¥Â≠óÊÆµ
    function initializeTimeField() {
        const now = new Date();
        const minutes = now.getMinutes();
        // Â∞ÜÂàÜÈíüÊï∞Ë∞ÉÊï¥‰∏∫5ÁöÑÂÄçÊï∞
        const roundedMinutes = Math.round(minutes / 5) * 5;
        now.setMinutes(roundedMinutes);
        now.setSeconds(0);

        flatpickr("#time", {
            locale: window.flatpickr.l10ns.zh,
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            defaultDate: now,
            minuteIncrement: 5  // ËÆæÁΩÆÂàÜÈíüÂ¢ûÈáè‰∏∫5
        });
    }

    // ÂàùÂßãÂåñÊó∂Èó¥Â≠óÊÆµ
    initializeTimeField();

    // Â≠òÂÇ®Á≥ªÊï∞ÂèÇÊï∞
    let coefficients = {
        dongtai_permeability: 6.4,
        dongtai_sample_weight: 5,
        dongtai_filter_area: 3.14
    };

    // ‰ªéÊúçÂä°Âô®Âä†ËΩΩÁ≥ªÊï∞ÂèÇÊï∞
    async function loadCoefficients() {
        try {
            // Âä†ËΩΩ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response1 = await fetch('/api/report-parameters/dongtai_permeability_coefficient/');
            const result1 = await response1.json();
            if (result1.status === 'success') {
                coefficients.dongtai_permeability = parseFloat(result1.data.value);
                console.log('‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞Âä†ËΩΩÊàêÂäü:', coefficients.dongtai_permeability);
            } else {
                console.warn('‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞Âä†ËΩΩÂ§±Ë¥•:', result1.message);
            }
            
            // Âä†ËΩΩ‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáè - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response2 = await fetch('/api/report-parameters/dongtai_sample_weight/');
            const result2 = await response2.json();
            if (result2.status === 'success') {
                coefficients.dongtai_sample_weight = parseFloat(result2.data.value);
                console.log('‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáèÂä†ËΩΩÊàêÂäü:', coefficients.dongtai_sample_weight);
            } else {
                console.warn('‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáèÂä†ËΩΩÂ§±Ë¥•:', result2.message);
            }
            
            // Âä†ËΩΩ‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØ - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response3 = await fetch('/api/report-parameters/dongtai_filter_area/');
            const result3 = await response3.json();
            if (result3.status === 'success') {
                coefficients.dongtai_filter_area = parseFloat(result3.data.value);
                console.log('‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØÂä†ËΩΩÊàêÂäü:', coefficients.dongtai_filter_area);
            } else {
                console.warn('‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØÂä†ËΩΩÂ§±Ë¥•:', result3.message);
            }
            
            console.log('Á≥ªÊï∞ÂèÇÊï∞Â∑≤Âä†ËΩΩ:', coefficients);
        } catch (error) {
            console.warn('Âä†ËΩΩÁ≥ªÊï∞ÂèÇÊï∞Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº:', error);
        }
    }

    // Ê†πÊçÆÁâ©ÊñôÁ±ªÂûãËÆæÁΩÆÁ≥ªÊï∞ÂÄº
    function updateCoefficientsByMaterialType() {
        const materialType = document.getElementById('material_type').value;
        
        if (materialType === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ') {
            // ‰ªéÂêéÂè∞ÂèÇÊï∞ÁÆ°ÁêÜËØªÂèñÂÄº
            document.getElementById('dongtai_permeability_coefficient').value = coefficients.dongtai_permeability || '';
            document.getElementById('dongtai_sample_weight').value = coefficients.dongtai_sample_weight || '';
            document.getElementById('dongtai_filter_area').value = coefficients.dongtai_filter_area || '';
        } else if (materialType === 'ÁÖÖÁÉßÂìÅ') {
            // ‰ΩøÁî®Âõ∫ÂÆöÂÄº
            document.getElementById('dongtai_permeability_coefficient').value = '6.4';
            document.getElementById('dongtai_sample_weight').value = '5';
            document.getElementById('dongtai_filter_area').value = '3.14';
            // È•ºÂéöÂ≠óÊÆµ‰øùÊåÅ‰∏∫Á©∫Ôºå‰∏çËÆæÁΩÆÈªòËÆ§ÂÄº
        }
    }

    // Ëá™Âä®ËÆ°ÁÆóÂäüËÉΩ
    function calculateValues() {
        // Ëé∑ÂèñËæìÂÖ•Â≠óÊÆµ
        const cakeThickness = parseFloat(document.getElementById('cake_thickness').value) || 0;
        const waterViscosity = parseFloat(document.getElementById('water_viscosity').value) || 0;
        const filterTime = parseFloat(document.getElementById('filter_time').value) || 0;
        
        // ËÆ°ÁÆóËøúÈÄöÊ∏óÈÄèÁéá = Á≥ªÊï∞ * È•ºÂéö * Ê∞¥Á≤òÂ∫¶ / ËøáÊª§Êó∂Èó¥
        if (cakeThickness && waterViscosity && filterTime) {
            const permeability = (coefficients.dongtai_permeability * cakeThickness * waterViscosity / filterTime);
            document.getElementById('permeability').value = permeability.toFixed(4);
        } else {
            // Â¶ÇÊûúÁº∫Â∞ëÂøÖË¶ÅÊï∞ÊçÆÔºåÊ∏ÖÁ©∫ËÆ°ÁÆóÂ≠óÊÆµ
            document.getElementById('permeability').value = '';
        }
    }
    
    // ÂàùÂßãÂåñÁ≥ªÊï∞ÂèÇÊï∞
    loadCoefficients().then(() => {
        // ÂàùÂßãÂåñÂÆåÊàêÂêéËÆæÁΩÆÁ≥ªÊï∞ÂÄº
        updateCoefficientsByMaterialType();
    });

    // ‰∏∫Áâ©ÊñôÁ±ªÂûãÊ∑ªÂä†ÂèòÂåñÁõëÂê¨Âô®
    document.getElementById('material_type').addEventListener('change', updateCoefficientsByMaterialType);

    // ‰∏∫Áõ∏ÂÖ≥Â≠óÊÆµÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    const calculationFields = ['dongtai_permeability_coefficient', 'dongtai_sample_weight', 'dongtai_filter_area', 'cake_thickness', 'water_viscosity', 'filter_time'];
    calculationFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', () => calculateAllValues(false));
            field.addEventListener('change', () => calculateAllValues(false));
        }
    });

    // ÊØè10ÂàÜÈíüËá™Âä®Âà∑Êñ∞È°µÈù¢
    // setInterval(function() {
    //     console.log('Ëá™Âä®Âà∑Êñ∞È°µÈù¢...');
    //     window.location.reload();
    // }, 10 * 60 * 1000); // 10ÂàÜÈíü = 10 * 60 * 1000 ÊØ´Áßí

    // Ëé∑ÂèñCSRF TokenÁöÑÂáΩÊï∞
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
    document.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};

        // ÂÆö‰πâÂÖÅËÆ∏ÁöÑÂ≠óÊÆµÂàóË°®
        const allowedFields = [
            'date', 'time', 'material_type', 'shift', 'product_name', 'packaging',
            'moisture_after_drying', 'alkali_content', 'flux',
            'dongtai_permeability_coefficient', 'dongtai_sample_weight', 'dongtai_filter_area',
            'permeability', 'permeability_long', 'filter_time', 'water_viscosity',
            'cake_thickness','wet_cake_density', 'yuantong_cake_density', 'changfu_cake_density', 'bulk_density',
            'brightness', 'swirl', 'odor', 'conductance', 'ph', 'moisture',
            'bags', 'tons', 'sieving_14m', 'sieving_30m',
            'sieving_40m', 'sieving_80m', 'sieving_100m', 'sieving_150m', 'sieving_200m',
            'sieving_325m', 'fe_ion', 'ca_ion', 'al_ion',
            'oil_absorption', 'water_absorption', 'remarks',
            'batch_number'  // ‰ΩøÁî®batch_numberÂ≠óÊÆµ
        ];

        for (let [key, value] of formData.entries()) {
            // Ë∑≥ËøáCSRF tokenÂíå‰∏çÂú®ÂÖÅËÆ∏ÂàóË°®‰∏≠ÁöÑÂ≠óÊÆµ
            if (key === 'csrfmiddlewaretoken' || !allowedFields.includes(key)) {
                continue;
            }

            if (value === '') continue;  // Ë∑≥ËøáÁ©∫ÂÄº

            // ÂØπÊï∞Â≠óÁ±ªÂûãÁöÑÂ≠óÊÆµËøõË°åËΩ¨Êç¢
            if ([
                'moisture_after_drying', 'alkali_content', 'permeability',
                'permeability_long', 'filter_time', 'water_viscosity',
                'cake_thickness','wet_cake_density', 'yuantong_cake_density', 'changfu_cake_density', 'bulk_density', 'brightness', 'conductance',
                'ph', 'moisture', 'bags', 'tons', 'sieving_14m', 'sieving_30m',
                'sieving_40m', 'sieving_80m',
                'fe_ion', 'ca_ion', 'al_ion', 'oil_absorption', 'water_absorption',
                'dongtai_permeability_coefficient', 'dongtai_sample_weight', 'dongtai_filter_area'
            ].includes(key)) {
                data[key] = parseFloat(value);
            } else {
                data[key] = value;
            }
        }

        try {
            const response = await fetch('/api/dongtai-report/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                alert('‰øùÂ≠òÊàêÂäü');

                // ÈáçÊñ∞Âä†ËΩΩË°®Ê†ºÊï∞ÊçÆÔºå‰ΩÜ‰∏çÈáçÁΩÆË°®Âçï
                await loadTableData();

                // ‰∏çÈáçÁΩÆË°®ÂçïÔºå‰øùÁïôÊâÄÊúâÂ≠óÊÆµ‰ø°ÊÅØ
                // Áî®Êà∑ÂèØ‰ª•ÁªßÁª≠Âü∫‰∫éÂΩìÂâçÊï∞ÊçÆËøõË°å‰øÆÊîπÂíå‰øùÂ≠ò

            } else {
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + result.message);
            }
        } catch (error) {
            alert('Êèê‰∫§Â§±Ë¥•: ' + error.message);
        }
    });

    // Âä†ËΩΩË°®Ê†ºÊï∞ÊçÆ
    async function loadTableData() {
        try {
            const response = await fetch('/api/dongtai-report/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.ok) {
                const data = await response.json();
                const tbody = document.querySelector('table tbody');
                if (!tbody) return; // Èò≤Ê≠¢Êä•Èîô
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.time}</td>
                        <td>${item.material_type || '-'}</td>
                        <td>${item.dongtai_permeability_coefficient || '-'}</td>
                        <td>${item.dongtai_sample_weight || '-'}</td>
                        <td>${item.dongtai_filter_area || '-'}</td>
                        <td>${item.moisture_after_drying || '-'}</td>
                        <td>${item.alkali_content || '-'}</td>
                        <td>${item.flux || '-'}</td>
                        <td>${item.product_name || '-'}</td>
                        <td>${item.permeability || '-'}</td>
                        <td>${item.permeability_long || '-'}</td>
                        <td>${item.filter_time}</td>
                        <td>${item.water_viscosity}</td>
                        <td>${item.cake_thickness}</td>
                        <td>${item.wet_cake_density || '-'}</td>
                        <td>${item.yuantong_cake_density || '-'}</td>
                        <td>${item.changfu_cake_density || '-'}</td>
                        <td>${item.bulk_density || '-'}</td>
                        <td>${item.brightness || '-'}</td>
                        <td>${item.swirl || '-'}</td>
                        <td>${item.odor || '-'}</td>
                        <td>${item.conductance || '-'}</td>
                        <td>${item.ph || '-'}</td>
                        <td>${item.moisture || '-'}</td>
                        <td>${item.bags || '-'}</td>
                        <td>${item.packaging || '-'}</td>
                        <td>${item.tons || '-'}</td>
                        <td>${item.fe_ion || '-'}</td>
                        <td>${item.ca_ion || '-'}</td>
                        <td>${item.al_ion || '-'}</td>
                        <td>${item.oil_absorption || '-'}</td>
                        <td>${item.water_absorption || '-'}</td>
                        <td>${item.remarks || '-'}</td>
                        <td>${item.batch_number || '-'}</td>
                        <td>${item.shift || '-'}</td>
                        <td>${item.sieving_14m || '-'}</td>
                        <td>${item.sieving_30m || '-'}</td>
                        <td>${item.sieving_40m || '-'}</td>
                        <td>${item.sieving_80m || '-'}</td>
                        <td>${item.sieving_150m || '-'}</td>
                        <td>${item.sieving_200m || '-'}</td>
                        <td>${item.sieving_325m || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                const result = await response.json();
                console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', result.message);
            }
        } catch (error) {
            console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
        }
    }



    // ‰ªéÊúçÂä°Âô®Âä†ËΩΩÁ≥ªÊï∞ÂèÇÊï∞
    async function loadCoefficients() {
        try {
            // Âä†ËΩΩ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response1 = await fetch('/api/report-parameters/dongtai_permeability_coefficient/');
            const result1 = await response1.json();
            if (result1.status === 'success') {
                coefficients.dongtai_permeability = parseFloat(result1.data.value);
                console.log('‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞Âä†ËΩΩÊàêÂäü:', coefficients.dongtai_permeability);
            } else {
                console.warn('‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞Âä†ËΩΩÂ§±Ë¥•:', result1.message);
            }
            
            // Âä†ËΩΩ‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáè - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response2 = await fetch('/api/report-parameters/dongtai_sample_weight/');
            const result2 = await response2.json();
            if (result2.status === 'success') {
                coefficients.dongtai_sample_weight = parseFloat(result2.data.value);
                console.log('‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáèÂä†ËΩΩÊàêÂäü:', coefficients.dongtai_sample_weight);
                console.log('‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáèÂä†ËΩΩÊàêÂäü:', coefficients.dongtai_sample_weight);
            } else {
                console.warn('‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáèÂä†ËΩΩÂ§±Ë¥•:', result2.message);
            }
            
            // Âä†ËΩΩ‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØ - ‰ΩøÁî®‰∏çÈúÄË¶ÅÊùÉÈôêÁöÑAPI
            const response3 = await fetch('/api/report-parameters/dongtai_filter_area/');
            const result3 = await response3.json();
            if (result3.status === 'success') {
                coefficients.dongtai_filter_area = parseFloat(result3.data.value);
                console.log('‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØÂä†ËΩΩÊàêÂäü:', coefficients.dongtai_filter_area);
            } else {
                console.warn('‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØÂä†ËΩΩÂ§±Ë¥•:', result3.message);
            }
            
            console.log('Á≥ªÊï∞ÂèÇÊï∞Âä†ËΩΩÂÆåÊàê:', coefficients);
        } catch (error) {
            console.error('Âä†ËΩΩÁ≥ªÊï∞ÂèÇÊï∞Â§±Ë¥•:', error);
        }
    }

    // Ê†πÊçÆÁâ©ÊñôÁ±ªÂûãËÆæÁΩÆÁ≥ªÊï∞ÂÄº
    function updateCoefficientsByMaterialType() {
        const materialType = document.getElementById('material_type')?.value;
        console.log('=== updateCoefficientsByMaterialType ÂºÄÂßã ===');
        console.log('ÂΩìÂâçÁâ©ÊñôÁ±ªÂûã:', materialType);
        
        if (!materialType) {
            console.log('Áâ©ÊñôÁ±ªÂûã‰∏∫Á©∫ÔºåÈÄÄÂá∫');
            return;
        }
        
        if (materialType === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ') {
            console.log('Â§ÑÁêÜÂä©ÁÜîÁÖÖÁÉßÂìÅÊ®°Âºè');
            // ‰ªéÂêéÂè∞ÂèÇÊï∞ÁÆ°ÁêÜËØªÂèñÂÄº
            const coefficientField = document.getElementById('dongtai_permeability_coefficient');
            const sampleWeightField = document.getElementById('dongtai_sample_weight');
            const filterAreaField = document.getElementById('dongtai_filter_area');
            
            if (coefficientField) coefficientField.value = coefficients.dongtai_permeability || '';
            if (sampleWeightField) sampleWeightField.value = coefficients.dongtai_sample_weight || '';
            if (filterAreaField) filterAreaField.value = coefficients.dongtai_filter_area || '';
            
            console.log('Âä©ÁÜîÁÖÖÁÉßÂìÅÁ≥ªÊï∞ËÆæÁΩÆÂÆåÊàê:', {
                coefficient: coefficients.dongtai_permeability,
                sampleWeight: coefficients.dongtai_sample_weight,
                filterArea: coefficients.dongtai_filter_area
            });
        } else if (materialType === 'ÁÖÖÁÉßÂìÅ') {
            console.log('Â§ÑÁêÜÁÖÖÁÉßÂìÅÊ®°Âºè');
            // ‰ΩøÁî®Âõ∫ÂÆöÂÄº
            const coefficientField = document.getElementById('dongtai_permeability_coefficient');
            const sampleWeightField = document.getElementById('dongtai_sample_weight');
            const filterAreaField = document.getElementById('dongtai_filter_area');
            const cakeThicknessField = document.getElementById('cake_thickness');
            
            if (coefficientField) coefficientField.value = '6.4'; // ÁÖÖÁÉßÂìÅÂõ∫ÂÆö‰ΩøÁî®6.4
            if (sampleWeightField) sampleWeightField.value = coefficients.dongtai_sample_weight || '5';
            if (filterAreaField) filterAreaField.value = coefficients.dongtai_filter_area || '3.14';
            // È•ºÂéöÂ≠óÊÆµ‰øùÊåÅ‰∏∫Á©∫Ôºå‰∏çËÆæÁΩÆÈªòËÆ§ÂÄº
            
            console.log('ÁÖÖÁÉßÂìÅÁ≥ªÊï∞ËÆæÁΩÆÂÆåÊàê:', {
                coefficient: '6.4',
                sampleWeight: '5',
                filterArea: '3.14',
                cakeThickness: 'Á©∫'
            });
        }
        
        console.log('=== updateCoefficientsByMaterialType ÂÆåÊàê ===');
    }

    // Ê†πÊçÆÁâ©ÊñôÁ±ªÂûãÊõ¥Êñ∞Â≠óÊÆµÂèØÁºñËæëÊÄß
    function updateFieldEditability() {
        const materialType = document.getElementById('material_type')?.value;
        if (!materialType) return;

        const yuantongCakeDensityField = document.getElementById('yuantong_cake_density');
        const changfuCakeDensityField = document.getElementById('changfu_cake_density');
        const wetCakeDensityField = document.getElementById('wet_cake_density');

        if (materialType === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ') {
            // Âä©ÁÜîÁÖÖÁÉßÂìÅÔºöËøúÈÄöÈ•ºÂØÜÂ∫¶ÔºåÈïøÂØåÈ•ºÂØÜÂ∫¶‰∏§‰∏™Â≠óÊÆµ‰∏çÂèØÁºñËæë
            if (yuantongCakeDensityField) {
                yuantongCakeDensityField.readOnly = true;
                yuantongCakeDensityField.style.backgroundColor = '#f5f5f5';
                yuantongCakeDensityField.title = 'Ê≠§Â≠óÊÆµÁî±Á≥ªÁªüËá™Âä®ËÆ°ÁÆó';
                // Ê∏ÖÁ©∫ËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶
                yuantongCakeDensityField.value = '';
            }
            if (changfuCakeDensityField) {
                changfuCakeDensityField.readOnly = true;
                changfuCakeDensityField.style.backgroundColor = '#f5f5f5';
                changfuCakeDensityField.title = 'Ê≠§Â≠óÊÆµÁî±Á≥ªÁªüËá™Âä®ËÆ°ÁÆó';
                // Ê∏ÖÁ©∫ÈïøÂØåÈ•ºÂØÜÂ∫¶
                changfuCakeDensityField.value = '';
            }
            if (wetCakeDensityField) {
                wetCakeDensityField.readOnly = false;
                wetCakeDensityField.style.backgroundColor = '';
                wetCakeDensityField.title = '';
            }
        } else if (materialType === 'ÁÖÖÁÉßÂìÅ') {
            // ÁÖÖÁÉßÂìÅÔºöÈ•ºÂØÜÂ∫¶Â≠óÊÆµ‰∏çÂèØÁºñËæë
            if (wetCakeDensityField) {
                wetCakeDensityField.readOnly = true;
                wetCakeDensityField.style.backgroundColor = '#f5f5f5';
                wetCakeDensityField.title = 'Ê≠§Â≠óÊÆµÁî±Á≥ªÁªüËá™Âä®ËÆ°ÁÆó';
                // Ê∏ÖÁ©∫È•ºÂØÜÂ∫¶
                wetCakeDensityField.value = '';
            }
            if (yuantongCakeDensityField) {
                yuantongCakeDensityField.readOnly = false;
                yuantongCakeDensityField.style.backgroundColor = '';
                yuantongCakeDensityField.title = '';
            }
            if (changfuCakeDensityField) {
                changfuCakeDensityField.readOnly = false;
                changfuCakeDensityField.style.backgroundColor = '';
                changfuCakeDensityField.title = '';
            }
        }
    }

    // ÊâßË°åÊâÄÊúâËÆ°ÁÆó
    function calculateAllValues(skipAutoFill = false) {
        console.log('=== calculateAllValues ÂºÄÂßã ===');
        console.log('skipAutoFillÂèÇÊï∞:', skipAutoFill);
        
        const materialType = document.getElementById('material_type')?.value;
        console.log('ÂΩìÂâçÁâ©ÊñôÁ±ªÂûã:', materialType);
        
        if (!materialType) {
            console.log('Áâ©ÊñôÁ±ªÂûã‰∏∫Á©∫ÔºåÈÄÄÂá∫ËÆ°ÁÆó');
            return;
        }

        if (materialType === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ') {
            console.log('Ë∞ÉÁî®Âä©ÁÜîÁÖÖÁÉßÂìÅËÆ°ÁÆóÂáΩÊï∞');
            calculateForFluxCalcined();
        } else if (materialType === 'ÁÖÖÁÉßÂìÅ') {
            console.log('Ë∞ÉÁî®ÁÖÖÁÉßÂìÅËÆ°ÁÆóÂáΩÊï∞');
            calculateForCalcined(skipAutoFill);
        }
        
        console.log('=== calculateAllValues ÂÆåÊàê ===');
    }

    // Âä©ÁÜîÁÖÖÁÉßÂìÅÁöÑËÆ°ÁÆóÈÄªËæë
    function calculateForFluxCalcined() {
        const dongtaiCoefficient = parseFloat(document.getElementById('dongtai_permeability_coefficient')?.value) || 0;
        const dongtaiSampleWeight = parseFloat(document.getElementById('dongtai_sample_weight')?.value) || 0;
        const dongtaiFilterArea = parseFloat(document.getElementById('dongtai_filter_area')?.value) || 0;
        const cakeThickness = parseFloat(document.getElementById('cake_thickness')?.value) || 0;
        const waterViscosity = parseFloat(document.getElementById('water_viscosity')?.value) || 0;
        const filterTime = parseFloat(document.getElementById('filter_time')?.value) || 0;

        // ËøúÈÄöÊ∏óÈÄèÁéá = ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ * È•ºÂéö * Ê∞¥ÈªèÂ∫¶ / ËøáÊª§Êó∂Èó¥
        let yuantongPermeability = null;
        if (dongtaiCoefficient && cakeThickness && waterViscosity && filterTime) {
            yuantongPermeability = (dongtaiCoefficient * cakeThickness * waterViscosity / filterTime);
            document.getElementById('permeability').value = yuantongPermeability.toFixed(4);
        } else {
            document.getElementById('permeability').value = '';
        }

        // ÈïøÂØåÊ∏óÈÄèÁéá = (ËøúÈÄöÊ∏óÈÄèÁéá - 0.366) / 1.23
        if (yuantongPermeability !== null) {
            const changfuPermeability = (yuantongPermeability - 0.366) / 1.23;
            document.getElementById('permeability_long').value = changfuPermeability.toFixed(4);
        } else {
            document.getElementById('permeability_long').value = '';
        }

        // È•ºÂØÜÂ∫¶ = ‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáè / ‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØ / È•ºÂéö
        if (dongtaiSampleWeight && dongtaiFilterArea && cakeThickness) {
            const cakeDensity = dongtaiSampleWeight / dongtaiFilterArea / cakeThickness;
            document.getElementById('wet_cake_density').value = cakeDensity.toFixed(3);
        } else {
            document.getElementById('wet_cake_density').value = '';
        }

        // ËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶‰∏çÂèØÁºñËæëÔºåÁî±Á≥ªÁªüËÆ°ÁÆó
        document.getElementById('yuantong_cake_density').value = '';
        document.getElementById('changfu_cake_density').value = '';
    }

    // ÁÖÖÁÉßÂìÅÁöÑÁâπÊÆäËÆ°ÁÆóÈÄªËæëÔºàÁî®‰∫éÁâ©ÊñôÁ±ªÂûãÂàáÊç¢Êó∂Ôºâ
    function calculateForCalcinedSpecial() {
        console.log('=== calculateForCalcinedSpecial ÂºÄÂßã ===');
        
        const dongtaiCoefficient = parseFloat(document.getElementById('dongtai_permeability_coefficient')?.value) || 0;
        const dongtaiSampleWeight = parseFloat(document.getElementById('dongtai_sample_weight')?.value) || 0;
        const dongtaiFilterArea = parseFloat(document.getElementById('dongtai_filter_area')?.value) || 0;
        const cakeThickness = parseFloat(document.getElementById('cake_thickness')?.value) || 0;
        const waterViscosity = parseFloat(document.getElementById('water_viscosity')?.value) || 0;
        const filterTime = parseFloat(document.getElementById('filter_time')?.value) || 0;

        console.log('ËÆ°ÁÆóÂèÇÊï∞:', {
            dongtaiCoefficient,
            dongtaiSampleWeight,
            dongtaiFilterArea,
            cakeThickness,
            waterViscosity,
            filterTime
        });

        // ËøúÈÄöÊ∏óÈÄèÁéá = ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ * È•ºÂéö * Ê∞¥Á≤òÂ∫¶ / ËøáÊª§Êó∂Èó¥
        let yuantongPermeability = null;
        if (dongtaiCoefficient && cakeThickness && waterViscosity && filterTime) {
            yuantongPermeability = (dongtaiCoefficient * cakeThickness * waterViscosity / filterTime);
            document.getElementById('permeability').value = yuantongPermeability.toFixed(4);
        } else {
            document.getElementById('permeability').value = '';
        }

        // ÈïøÂØåÊ∏óÈÄèÁéá = ËøúÈÄöÊ∏óÈÄèÁéá - 0.02
        if (yuantongPermeability !== null) {
            const changfuPermeability = yuantongPermeability - 0.02;
            document.getElementById('permeability_long').value = changfuPermeability.toFixed(4);
        } else {
            document.getElementById('permeability_long').value = '';
        }

        // È•ºÂØÜÂ∫¶Â≠óÊÆµ‰øùÊåÅ‰∏∫Á©∫ÔºàÂ∑≤Âú®updateFieldEditability‰∏≠Ê∏ÖÁ©∫Ôºâ
        document.getElementById('wet_cake_density').value = '';
        
        // Ëá™Âä®ËÆ°ÁÆóÂπ∂Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶
        // Âè™ÊúâÂú®È•ºÂéöÊúâÂÄºÊó∂ÊâçËøõË°åËÆ°ÁÆó
        if (dongtaiSampleWeight && dongtaiFilterArea && cakeThickness) {
            const yuantongCakeDensity = dongtaiSampleWeight / dongtaiFilterArea / cakeThickness;
            
            console.log('È•ºÂØÜÂ∫¶ËÆ°ÁÆó:', {
                dongtaiSampleWeight,
                dongtaiFilterArea,
                cakeThickness,
                yuantongCakeDensity
            });
            
            // Ëá™Âä®Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶
            const yuantongCakeDensityField = document.getElementById('yuantong_cake_density');
            if (yuantongCakeDensityField) {
                console.log('Ëá™Âä®Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                yuantongCakeDensityField.value = yuantongCakeDensity.toFixed(3);
            }
            
            // Ëá™Âä®Â°´ÂÖÖÈïøÂØåÈ•ºÂØÜÂ∫¶
            const changfuCakeDensityField = document.getElementById('changfu_cake_density');
            if (changfuCakeDensityField) {
                const changfuCakeDensity = yuantongCakeDensity - 0.02;
                console.log('Ëá™Âä®Â°´ÂÖÖÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                changfuCakeDensityField.value = changfuCakeDensity.toFixed(3);
            }
        } else {
            console.log('ËÆ°ÁÆóÂèÇÊï∞‰∏çÂÆåÊï¥ÊàñÈ•ºÂéö‰∏∫Á©∫ÔºåÊ∏ÖÁ©∫È•ºÂØÜÂ∫¶Â≠óÊÆµ');
            document.getElementById('yuantong_cake_density').value = '';
            document.getElementById('changfu_cake_density').value = '';
        }
        
        console.log('=== calculateForCalcinedSpecial ÂÆåÊàê ===');
    }

    // Âä©ÁÜîÁÖÖÁÉßÂìÅÁöÑÁâπÊÆäËÆ°ÁÆóÈÄªËæëÔºàÁî®‰∫éÁâ©ÊñôÁ±ªÂûãÂàáÊç¢Êó∂Ôºâ
    function calculateForFluxCalcinedSpecial() {
        const dongtaiCoefficient = parseFloat(document.getElementById('dongtai_permeability_coefficient')?.value) || 0;
        const dongtaiSampleWeight = parseFloat(document.getElementById('dongtai_sample_weight')?.value) || 0;
        const dongtaiFilterArea = parseFloat(document.getElementById('dongtai_filter_area')?.value) || 0;
        const cakeThickness = parseFloat(document.getElementById('cake_thickness')?.value) || 0;
        const waterViscosity = parseFloat(document.getElementById('water_viscosity')?.value) || 0;
        const filterTime = parseFloat(document.getElementById('filter_time')?.value) || 0;

        // ËøúÈÄöÊ∏óÈÄèÁéá = ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ * È•ºÂéö * Ê∞¥ÈªèÂ∫¶ / ËøáÊª§Êó∂Èó¥
        let yuantongPermeability = null;
        if (dongtaiCoefficient && cakeThickness && waterViscosity && filterTime) {
            yuantongPermeability = (dongtaiCoefficient * cakeThickness * waterViscosity / filterTime);
            document.getElementById('permeability').value = yuantongPermeability.toFixed(4);
        } else {
            document.getElementById('permeability').value = '';
        }

        // ÈïøÂØåÊ∏óÈÄèÁéá = (ËøúÈÄöÊ∏óÈÄèÁéá - 0.366) / 1.23
        if (yuantongPermeability !== null) {
            const changfuPermeability = (yuantongPermeability - 0.366) / 1.23;
            document.getElementById('permeability_long').value = changfuPermeability.toFixed(4);
        } else {
            document.getElementById('permeability_long').value = '';
        }

        // Ëá™Âä®ËÆ°ÁÆóÂπ∂Â°´ÂÖÖÈ•ºÂØÜÂ∫¶
        if (dongtaiSampleWeight && dongtaiFilterArea && cakeThickness) {
            const cakeDensity = dongtaiSampleWeight / dongtaiFilterArea / cakeThickness;
            document.getElementById('wet_cake_density').value = cakeDensity.toFixed(3);
        } else {
            document.getElementById('wet_cake_density').value = '';
        }

        // ËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµ‰øùÊåÅ‰∏∫Á©∫ÔºàÂ∑≤Âú®updateFieldEditability‰∏≠Ê∏ÖÁ©∫Ôºâ
        document.getElementById('yuantong_cake_density').value = '';
        document.getElementById('changfu_cake_density').value = '';
    }

    // ÁÖÖÁÉßÂìÅÁöÑËÆ°ÁÆóÈÄªËæë
    function calculateForCalcined(skipAutoFill = false) {
        console.log('=== calculateForCalcined ÂºÄÂßã ===');
        console.log('skipAutoFillÂèÇÊï∞:', skipAutoFill);
        
        const dongtaiCoefficient = parseFloat(document.getElementById('dongtai_permeability_coefficient')?.value) || 0;
        const dongtaiSampleWeight = parseFloat(document.getElementById('dongtai_sample_weight')?.value) || 0;
        const dongtaiFilterArea = parseFloat(document.getElementById('dongtai_filter_area')?.value) || 0;
        const cakeThickness = parseFloat(document.getElementById('cake_thickness')?.value) || 0;
        const waterViscosity = parseFloat(document.getElementById('water_viscosity')?.value) || 0;
        const filterTime = parseFloat(document.getElementById('filter_time')?.value) || 0;

        console.log('ËÆ°ÁÆóÂèÇÊï∞:', {
            dongtaiCoefficient,
            dongtaiSampleWeight,
            dongtaiFilterArea,
            cakeThickness,
            waterViscosity,
            filterTime
        });

        // ËøúÈÄöÊ∏óÈÄèÁéá = ‰∏úÊ≥∞Ê∏óÈÄèÁéáÁ≥ªÊï∞ * È•ºÂéö * Ê∞¥Á≤òÂ∫¶ / ËøáÊª§Êó∂Èó¥
        let yuantongPermeability = null;
        if (dongtaiCoefficient && cakeThickness && waterViscosity && filterTime) {
            yuantongPermeability = (dongtaiCoefficient * cakeThickness * waterViscosity / filterTime);
            document.getElementById('permeability').value = yuantongPermeability.toFixed(4);
        } else {
            document.getElementById('permeability').value = '';
        }

        // ÈïøÂØåÊ∏óÈÄèÁéá = ËøúÈÄöÊ∏óÈÄèÁéá - 0.02
        if (yuantongPermeability !== null) {
            const changfuPermeability = yuantongPermeability - 0.02;
            document.getElementById('permeability_long').value = changfuPermeability.toFixed(4);
        } else {
            document.getElementById('permeability_long').value = '';
        }

        // È•ºÂØÜÂ∫¶ËÆ°ÁÆó
        // ËøúÈÄöÈ•ºÂØÜÂ∫¶ = ‰∏úÊ≥∞Ê†∑ÂìÅÈáçÈáè / ‰∏úÊ≥∞ËøáÊª§Èù¢ÁßØ / È•ºÂéö
        // Âú®ÁÖÖÁÉßÂìÅÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûúÈ•ºÂéö‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®ÈªòËÆ§ÂÄº1ËøõË°åËÆ°ÁÆó
        if (dongtaiSampleWeight && dongtaiFilterArea) {
            const effectiveCakeThickness = cakeThickness || 1; // Â¶ÇÊûúÈ•ºÂéö‰∏∫Á©∫Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº1
            const yuantongCakeDensity = dongtaiSampleWeight / dongtaiFilterArea / effectiveCakeThickness;
            
            console.log('È•ºÂØÜÂ∫¶ËÆ°ÁÆó:', {
                dongtaiSampleWeight,
                dongtaiFilterArea,
                cakeThickness,
                effectiveCakeThickness,
                yuantongCakeDensity
            });
            
            // Âú®ÁÖÖÁÉßÂìÅÊ®°Âºè‰∏ãÔºåÈ•ºÂØÜÂ∫¶Â≠óÊÆµÊòØÂè™ËØªÁöÑÔºå‰∏çÂ∫îËØ•Ë¢´Ëá™Âä®Â°´ÂÖÖ
            // Âè™ÊúâÂú®Âä©ÁÜîÁÖÖÁÉßÂìÅÊ®°Âºè‰∏ãÊâçËá™Âä®Â°´ÂÖÖÈ•ºÂØÜÂ∫¶Â≠óÊÆµ
            const materialType = document.getElementById('material_type')?.value;
            if (materialType === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ' && !skipAutoFill) {
                console.log('Âä©ÁÜîÁÖÖÁÉßÂìÅÊ®°ÂºèÔºåËá™Âä®Â°´ÂÖÖÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                document.getElementById('wet_cake_density').value = yuantongCakeDensity.toFixed(3);
            } else {
                console.log('ÁÖÖÁÉßÂìÅÊ®°ÂºèÊàñÂÖ∂‰ªñÊÉÖÂÜµÔºåË∑≥ËøáÈ•ºÂØÜÂ∫¶Â≠óÊÆµËá™Âä®Â°´ÂÖÖ');
            }
            
            // Âú®ÁÖÖÁÉßÂìÅÊ®°Âºè‰∏ãÔºåËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµÊòØÂèØÁºñËæëÁöÑ
            // ÂΩìÂèÇÊï∞ÂèòÂåñÊó∂ÔºåËá™Âä®ÈáçÊñ∞ËÆ°ÁÆóËøô‰∫õÂ≠óÊÆµ
            const yuantongCakeDensityField = document.getElementById('yuantong_cake_density');
            const changfuCakeDensityField = document.getElementById('changfu_cake_density');
            
            // Â¶ÇÊûúskipAutoFill‰∏∫trueÔºåÂàô‰∏çËá™Âä®Â°´ÂÖÖ
            if (!skipAutoFill) {
                console.log('Â§ÑÁêÜËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                // Ëá™Âä®ËÆ°ÁÆóÂπ∂Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶
                if (yuantongCakeDensityField) {
                    console.log('Ëá™Âä®Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                    yuantongCakeDensityField.value = yuantongCakeDensity.toFixed(3);
                }
                if (changfuCakeDensityField) {
                    const changfuCakeDensity = yuantongCakeDensity - 0.02;
                    console.log('Ëá™Âä®Â°´ÂÖÖÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµ');
                    changfuCakeDensityField.value = changfuCakeDensity.toFixed(3);
                }
            } else {
                console.log('Ë∑≥ËøáËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶Â≠óÊÆµËá™Âä®Â°´ÂÖÖÔºàskipAutoFill=trueÔºâ');
            }
        } else {
            console.log('ËÆ°ÁÆóÂèÇÊï∞‰∏çÂÆåÊï¥ÔºåÊ∏ÖÁ©∫Áõ∏ÂÖ≥Â≠óÊÆµ');
            // Â¶ÇÊûúskipAutoFill‰∏∫trueÔºåÂàô‰∏çËá™Âä®Ê∏ÖÁ©∫È•ºÂØÜÂ∫¶Â≠óÊÆµ
            if (!skipAutoFill) {
                console.log('Ëá™Âä®Ê∏ÖÁ©∫È•ºÂØÜÂ∫¶Â≠óÊÆµ');
                document.getElementById('wet_cake_density').value = '';
            } else {
                console.log('Ë∑≥ËøáÈ•ºÂØÜÂ∫¶Â≠óÊÆµËá™Âä®Ê∏ÖÁ©∫ÔºàskipAutoFill=trueÔºâ');
            }
            // Ê∏ÖÁ©∫ËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶
            const yuantongCakeDensityField = document.getElementById('yuantong_cake_density');
            const changfuCakeDensityField = document.getElementById('changfu_cake_density');
            if (yuantongCakeDensityField) {
                yuantongCakeDensityField.value = '';
            }
            if (changfuCakeDensityField) {
                changfuCakeDensityField.value = '';
            }
        }
        
        console.log('=== calculateForCalcined ÂÆåÊàê ===');
    }

    // ÂàùÂßãÂåñËÆ°ÁÆóÈÄªËæë
    function initCalculationLogic() {
        console.log('=== initCalculationLogic ÂºÄÂßã ===');
        
        // Âä†ËΩΩÁ≥ªÊï∞ÂèÇÊï∞
        loadCoefficients().then(() => {
            console.log('Á≥ªÊï∞ÂèÇÊï∞Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ');
            // ÂàùÂßãÂåñÂÆåÊàêÂêéËÆæÁΩÆÁ≥ªÊï∞ÂÄº
            updateCoefficientsByMaterialType();
            // ËÆæÁΩÆÂ≠óÊÆµÂèØÁºñËæëÊÄß
            updateFieldEditability();
            // ÊâßË°åÂàùÂßãËÆ°ÁÆó
            console.log('ÊâßË°åÂàùÂßãËÆ°ÁÆó');
            calculateAllValues();
            console.log('ÂàùÂßãËÆ°ÁÆóÂÆåÊàê');
        });

        // ‰∏∫Áâ©ÊñôÁ±ªÂûãÊ∑ªÂä†ÂèòÂåñÁõëÂê¨Âô®
        const materialTypeSelect = document.getElementById('material_type');
        console.log('Áâ©ÊñôÁ±ªÂûãÈÄâÊã©Âô®:', materialTypeSelect);
        
        if (materialTypeSelect) {
            console.log('Ê∑ªÂä†Áâ©ÊñôÁ±ªÂûãÂèòÂåñÁõëÂê¨Âô®');
            materialTypeSelect.addEventListener('change', function() {
                console.log('=== Áâ©ÊñôÁ±ªÂûãÂàáÊç¢‰∫ã‰ª∂Ëß¶Âèë ===');
                console.log('ÂàáÊç¢Âà∞ÁöÑÁâ©ÊñôÁ±ªÂûã:', this.value);
                
                updateCoefficientsByMaterialType();
                updateFieldEditability();
                
                // Ê†πÊçÆÂàáÊç¢Âà∞ÁöÑÁâ©ÊñôÁ±ªÂûãÂÜ≥ÂÆöÊòØÂê¶Ëá™Âä®Â°´ÂÖÖ
                if (this.value === 'ÁÖÖÁÉßÂìÅ') {
                    console.log('ÂàáÊç¢Âà∞ÁÖÖÁÉßÂìÅÔºåË∞ÉÁî®calculateForCalcinedSpecial');
                    // ÂàáÊç¢Âà∞ÁÖÖÁÉßÂìÅÔºöÊ∏ÖÁ©∫È•ºÂØÜÂ∫¶Ôºå‰ΩÜËá™Âä®Â°´ÂÖÖËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶
                    calculateForCalcinedSpecial();
                } else if (this.value === 'Âä©ÁÜîÁÖÖÁÉßÂìÅ') {
                    console.log('ÂàáÊç¢Âà∞Âä©ÁÜîÁÖÖÁÉßÂìÅÔºåË∞ÉÁî®calculateForFluxCalcinedSpecial');
                    // ÂàáÊç¢Âà∞Âä©ÁÜîÁÖÖÁÉßÂìÅÔºöÊ∏ÖÁ©∫ËøúÈÄöÈ•ºÂØÜÂ∫¶ÂíåÈïøÂØåÈ•ºÂØÜÂ∫¶Ôºå‰ΩÜËá™Âä®Â°´ÂÖÖÈ•ºÂØÜÂ∫¶
                    calculateForFluxCalcinedSpecial();
                } else {
                    console.log('ÂÖ∂‰ªñÁâ©ÊñôÁ±ªÂûãÔºåË∞ÉÁî®calculateAllValues(true)');
                    // ÂÖ∂‰ªñÊÉÖÂÜµÔºåË∑≥ËøáËá™Âä®Â°´ÂÖÖ
                    calculateAllValues(true);
                }
            });
        } else {
            console.log('Êú™ÊâæÂà∞Áâ©ÊñôÁ±ªÂûãÈÄâÊã©Âô®');
        }

        // ‰∏∫Áõ∏ÂÖ≥Â≠óÊÆµÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        const calculationFields = ['dongtai_permeability_coefficient', 'dongtai_sample_weight', 'dongtai_filter_area', 'cake_thickness', 'water_viscosity', 'filter_time'];
        console.log('‰∏∫ËÆ°ÁÆóÂ≠óÊÆµÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®:', calculationFields);
        
        calculationFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                console.log(`‰∏∫Â≠óÊÆµ ${fieldId} Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®`);
                field.addEventListener('input', () => calculateAllValues(false));
                field.addEventListener('change', () => calculateAllValues(false));
            } else {
                console.log(`Êú™ÊâæÂà∞Â≠óÊÆµ ${fieldId}`);
            }
        });
        
        console.log('=== initCalculationLogic ÂÆåÊàê ===');
    }

    // ÂàùÂßãÂåñËÆ°ÁÆóÈÄªËæë
    initCalculationLogic();

    // ÂàùÂßãÂä†ËΩΩË°®Ê†ºÊï∞ÊçÆ
    loadTableData();

    // ‰∫ßÂìÅÂûãÂè∑Ëá™Âä®Ë°•ÂÖ®ÔºàËÑ±Á¶ªÁà∂ÂÆπÂô®Ôºåbody‰∏ãÁªùÂØπÂÆö‰ΩçÔºâ
    (function() {
        const input = document.getElementById('product_name');
        let suggestionsBox = document.getElementById('productNameSuggestions');
        if (!suggestionsBox) {
            suggestionsBox = document.createElement('div');
            suggestionsBox.id = 'productNameSuggestions';
            suggestionsBox.className = 'autocomplete-suggestions';
            suggestionsBox.style.display = 'none';
            document.body.appendChild(suggestionsBox);
        }
        let lastQuery = '';
        let activeIndex = -1;
        let suggestions = [];
        let debounceTimer = null;

        function positionBox() {
            const rect = input.getBoundingClientRect();
            suggestionsBox.style.position = 'fixed';
            suggestionsBox.style.left = rect.left + 'px';
            suggestionsBox.style.top = rect.bottom + 'px';
            suggestionsBox.style.width = rect.width + 'px';
            suggestionsBox.style.zIndex = 99999;
        }

        function fetchSuggestions(query) {
            fetch(`/api/product-models/suggest/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.data.length > 0) {
                        suggestions = data.data;
                        suggestionsBox.innerHTML = data.data.map((item, idx) =>
                            `<div class="autocomplete-suggestion${idx===0?' active':''}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestionsBox.style.display = 'block';
                        activeIndex = 0;
                        positionBox();
                    } else {
                        suggestions = [];
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }
                });
        }

        input.addEventListener('input', function() {
            const query = this.value.trim();
            lastQuery = query;
            if (debounceTimer) clearTimeout(debounceTimer);
            if (!query) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        input.addEventListener('focus', positionBox);
        window.addEventListener('resize', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        });
        window.addEventListener('scroll', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        }, true);

        suggestionsBox.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                input.value = e.target.getAttribute('data-name');
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });

        // ÈîÆÁõò‰∏ä‰∏ãÈîÆÈÄâÊã©
        input.addEventListener('keydown', function(e) {
            if (!suggestions.length || suggestionsBox.style.display === 'none') return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
                updateActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
                updateActive();
            } else if (e.key === 'Enter') {
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    input.value = suggestions[activeIndex].name;
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    e.preventDefault();
                }
            }
        });
        function updateActive() {
            const items = suggestionsBox.querySelectorAll('.autocomplete-suggestion');
            items.forEach((el, idx) => {
                if (idx === activeIndex) {
                    el.classList.add('active');
                    el.scrollIntoView({block:'nearest'});
                } else {
                    el.classList.remove('active');
                }
            });
        }
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Âª∫ËÆÆ
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });
    })();

    // ÂåÖË£ÖÁ±ªÂûãËá™Âä®Ë°•ÂÖ®ÔºàËÑ±Á¶ªÁà∂ÂÆπÂô®Ôºåbody‰∏ãÁªùÂØπÂÆö‰ΩçÔºâ
    (function() {
        const input = document.getElementById('packaging');
        let suggestionsBox = document.getElementById('packagingSuggestions');
        if (!suggestionsBox) {
            suggestionsBox = document.createElement('div');
            suggestionsBox.id = 'packagingSuggestions';
            suggestionsBox.className = 'autocomplete-suggestions';
            suggestionsBox.style.display = 'none';
            document.body.appendChild(suggestionsBox);
        }
        let lastQuery = '';
        let activeIndex = -1;
        let suggestions = [];
        let debounceTimer = null;

        function positionBox() {
            const rect = input.getBoundingClientRect();
            suggestionsBox.style.position = 'fixed';
            suggestionsBox.style.left = rect.left + 'px';
            suggestionsBox.style.top = rect.bottom + 'px';
            suggestionsBox.style.width = rect.width + 'px';
            suggestionsBox.style.zIndex = 99999;
        }

        function fetchSuggestions(query) {
            fetch(`/api/packagings/suggest/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.data.length > 0) {
                        suggestions = data.data;
                        suggestionsBox.innerHTML = data.data.map((item, idx) =>
                            `<div class="autocomplete-suggestion${idx===0?' active':''}" data-name="${item.name}">${item.name}</div>`
                        ).join('');
                        suggestionsBox.style.display = 'block';
                        activeIndex = 0;
                        positionBox();
                    } else {
                        suggestions = [];
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('ÂåÖË£ÖÁ±ªÂûãËá™Âä®ÂÆåÊàêÈîôËØØ:', error);
                    suggestions = [];
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                });
        }

        input.addEventListener('input', function() {
            const query = this.value.trim();
            lastQuery = query;
            if (debounceTimer) clearTimeout(debounceTimer);
            if (!query) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        input.addEventListener('focus', positionBox);
        window.addEventListener('resize', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        });
        window.addEventListener('scroll', function() {
            if (suggestionsBox.style.display === 'block') positionBox();
        }, true);

        suggestionsBox.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                input.value = e.target.getAttribute('data-name');
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });

        // ÈîÆÁõò‰∏ä‰∏ãÈîÆÈÄâÊã©
        input.addEventListener('keydown', function(e) {
            if (!suggestions.length || suggestionsBox.style.display === 'none') return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
                updateActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
                updateActive();
            } else if (e.key === 'Enter') {
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    input.value = suggestions[activeIndex].name;
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    e.preventDefault();
                }
            }
        });
        function updateActive() {
            const items = suggestionsBox.querySelectorAll('.autocomplete-suggestion');
            items.forEach((el, idx) => {
                if (idx === activeIndex) {
                    el.classList.add('active');
                    el.scrollIntoView({block:'nearest'});
                } else {
                    el.classList.remove('active');
                }
            });
        }
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Âª∫ËÆÆ
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            }
        });
    })();

    // Êî∂ËóèÂäüËÉΩÔºà‰∏éÂêéÁ´ØÂêåÊ≠•Ôºâ
    (function() {
        const btn = document.getElementById('favoriteBtn');
        const icon = document.getElementById('favoriteIcon');
        const text = document.getElementById('favoriteText');
        const pageKey = 'dongtai_report';
        let isFav = false;
        function setState(fav) {
            if (fav) {
                icon.textContent = 'star';
                text.textContent = 'ÂèñÊ∂àÊî∂Ëóè';
            } else {
                icon.textContent = 'star_border';
                text.textContent = 'Êî∂Ëóè';
            }
        }
        // ÂàùÂßãÂåñÁä∂ÊÄÅ
        fetch(`/api/user-favorite/?page=${pageKey}`)
            .then(res => res.json())
            .then(data => {
                isFav = !!data.favorite;
                setState(isFav);
            });
        btn.addEventListener('click', function() {
            if (isFav) {
                fetch(`/api/user-favorite/?page=${pageKey}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    credentials: 'same-origin'
                })
                    .then(res => res.json())
                    .then(data => {
                        isFav = false;
                        setState(false);
                        window.dispatchEvent(new Event('favoriteChanged'));
                    });
            } else {
                fetch(`/api/user-favorite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({page: pageKey}),
                    credentials: 'same-origin'
                })
                    .then(res => res.json())
                    .then(data => {
                        isFav = true;
                        setState(true);
                        window.dispatchEvent(new Event('favoriteChanged'));
                    });
            }
        });
    })();

    // ÊãñÊãΩ‰∏ä‰º†ÂíåÁÇπÂáª‰∏ä‰º†
    function bindFileUploadEvents() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const excelFileInput = document.getElementById('excelFileInput');
        
        if (!fileUploadArea || !excelFileInput) {
            return;
        }
        
        const newFileUploadArea = fileUploadArea.cloneNode(true);
        fileUploadArea.parentNode.replaceChild(newFileUploadArea, fileUploadArea);
        
        newFileUploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            excelFileInput.click();
        });
        
        newFileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.add('dragover');
        });

        newFileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.remove('dragover');
        });

        newFileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            newFileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    excelFileInput.files = dataTransfer.files;
                    
                    const fileNameDiv = document.getElementById('fileName');
                    if (fileNameDiv) {
                        fileNameDiv.textContent = 'Â∑≤ÈÄâÊã©: ' + file.name;
                        fileNameDiv.classList.add('show');
                    }
                } else {
                    alert('ËØ∑ÈÄâÊã©ExcelÊñá‰ª∂Ê†ºÂºè(.xlsx Êàñ .xls)');
                }
            }
        });
    }

    // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
    const excelFileInput = document.getElementById('excelFileInput');
    if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
            const fileNameDiv = document.getElementById('fileName');
            if (this.files && this.files.length > 0) {
                fileNameDiv.textContent = 'Â∑≤ÈÄâÊã©: ' + this.files[0].name;
                fileNameDiv.classList.add('show');
            } else {
                fileNameDiv.classList.remove('show');
            }
        });
    }
    bindFileUploadEvents();

    // Ê≥®ÊÑèÔºödownloadDongtaiTemplate ÂáΩÊï∞Â∑≤Âú®È°µÈù¢ÂºÄÂ§¥ÂÆö‰πâ
    // ËøôÈáå‰∏çÈúÄË¶ÅÈáçÂ§çÂÆö‰πâÔºåÂáΩÊï∞Â∑≤ÁªèÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂèØÁî®

    // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
    const importForm = document.getElementById('importForm');
    if (importForm) {
        importForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('excelFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑExcelÊñá‰ª∂');
                return;
            }

            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', getCSRFToken());

            document.getElementById('importProgress').classList.add('show');
            document.getElementById('importSubmitBtn').disabled = true;
            document.getElementById('errorMessages').classList.remove('show');
            document.getElementById('errorMessages').innerHTML = '';

            try {
                const response = await fetch('{% url "dongtai_report_import_excel" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const result = await response.json();
                
                document.getElementById('importProgress').classList.remove('show');
                document.getElementById('importSubmitBtn').disabled = false;

                if (result.status === 'success') {
                    alert(`ÂØºÂÖ•ÊàêÂäüÔºÅ\nÊàêÂäüÂØºÂÖ•: ${result.imported_count} Êù°Êï∞ÊçÆ${result.error_count > 0 ? '\nÂ§±Ë¥•: ' + result.error_count + ' Êù°' : ''}`);
                    
                    if (result.error_messages && result.error_messages.length > 0) {
                        const errorDiv = document.getElementById('errorMessages');
                        errorDiv.innerHTML = '<strong>ÈÉ®ÂàÜÊï∞ÊçÆÂØºÂÖ•Â§±Ë¥•Ôºö</strong><br>' + 
                            result.error_messages.map(msg => `<div class="error-message">${msg}</div>`).join('');
                        errorDiv.classList.add('show');
                    } else {
                        closeImportModal();
                        window.location.reload();
                    }
                } else {
                    alert('ÂØºÂÖ•Â§±Ë¥•: ' + result.message);
                    if (result.error_messages && result.error_messages.length > 0) {
                        const errorDiv = document.getElementById('errorMessages');
                        errorDiv.innerHTML = '<strong>ÈîôËØØ‰ø°ÊÅØÔºö</strong><br>' + 
                            result.error_messages.map(msg => `<div class="error-message">${msg}</div>`).join('');
                        errorDiv.classList.add('show');
                    }
                }
            } catch (error) {
                document.getElementById('importProgress').classList.remove('show');
                document.getElementById('importSubmitBtn').disabled = false;
                alert('ÂØºÂÖ•Â§±Ë¥•: ' + error.message);
            }
        });
    }

    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    window.onclick = function(event) {
        const modal = document.getElementById('importModal');
        if (event.target === modal) {
            closeImportModal();
        }
    };
});
</script>

<!-- ÊÇ¨ÊµÆÂØºÂÖ•ÊåâÈíÆ -->
<button class="floating-import-btn" onclick="showImportModal()" title="ÂØºÂÖ•Excel">
    <span class="material-icons">upload_file</span>
</button>

<!-- ÂØºÂÖ•ExcelÊ®°ÊÄÅÊ°Ü -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ÂØºÂÖ•ExcelÊä•Ë°®</h2>
            <span class="close" onclick="closeImportModal(); return false;">&times;</span>
        </div>
        <div class="import-tip-section">
            <div class="tip-header">
                <div class="tip-icon-wrapper">
                    <span class="material-icons tip-icon">lightbulb</span>
                </div>
                <div class="tip-content">
                    <h3 class="tip-title">ÈáçË¶ÅÊèêÁ§∫</h3>
                    <p class="tip-text">
                        ËØ∑ÂÖà‰∏ãËΩΩÊ®°ÊùøÊñá‰ª∂ÔºåÊåâÁÖßÊ®°ÊùøÊ†ºÂºèÂ°´ÂÜôÊï∞ÊçÆ„ÄÇË°®Â§¥ÂøÖÈ°ª‰∏éÊ®°ÊùøÂÆåÂÖ®‰∏ÄËá¥Ôºå‰∏çËÉΩ‰øÆÊîπÊàñÂà†Èô§‰ªª‰ΩïÂàó„ÄÇ
                    </p>
                </div>
            </div>
            <div class="download-button-wrapper">
                <button type="button" id="downloadTemplateBtn" class="download-template-btn" onclick="downloadDongtaiTemplate()">
                    <span class="material-icons" id="downloadIcon">download</span>
                    <span id="downloadBtnText">‰∏ãËΩΩÂØºÂÖ•Ê®°Êùø</span>
                </button>
                <!-- ‰∏ãËΩΩËøõÂ∫¶ÊèêÁ§∫ -->
                <div id="downloadProgress" class="download-progress-tooltip">
                    <span class="material-icons progress-icon">hourglass_empty</span>
                    <span class="progress-text">Ê≠£Âú®‰∏ãËΩΩÊ®°ÊùøÔºåËØ∑Á®çÂÄô...</span>
                </div>
            </div>
        </div>
        <form id="importForm" enctype="multipart/form-data" class="import-form">
            {% csrf_token %}
            <div style="flex: 1; overflow-y: auto; padding: 0 32px;">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="file-upload-icon">
                        <span class="material-icons">cloud_upload</span>
                    </div>
                    <div class="file-upload-text">ÁÇπÂáªÈÄâÊã©ExcelÊñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                    <div class="file-upload-hint">ÊîØÊåÅÊ†ºÂºè: .xlsx, .xlsÔºàÂøÖÈ°ª‰ΩøÁî®Ê®°ÊùøÊñá‰ª∂Ôºâ</div>
                    <div class="file-name" id="fileName"></div>
                </div>
                <input type="file" id="excelFileInput" name="excel_file" accept=".xlsx,.xls" style="display: none;">
                <div class="import-progress" id="importProgress">
                    <div class="progress-spinner"></div>
                    <div class="progress-text">Ê≠£Âú®ÂØºÂÖ•ÔºåËØ∑Á®çÂÄô...</div>
                </div>
                <div class="error-messages" id="errorMessages"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeImportModal()">
                    <span>ÂèñÊ∂à</span>
                </button>
                <button type="submit" class="btn-submit" id="importSubmitBtn">
                    <span class="material-icons">upload</span>
                    <span>ÂºÄÂßãÂØºÂÖ•</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
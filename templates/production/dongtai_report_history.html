{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/icon-alignment-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/qc_report_buttons.css' %}">
<link rel="stylesheet" href="{% static 'css/sticky_table_header.css' %}">
<link rel="stylesheet" href="{% static 'css/wechat-pc-table-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/qc_button_layout.css' %}">
<link rel="stylesheet" href="/static/libs/flatpickr/flatpickr.min.css">
<script src="/static/libs/flatpickr/flatpickr.min.js"></script>
<script src="/static/libs/flatpickr/zh.js"></script>
<script src="/static/libs/jquery/jquery-3.6.0.min.js"></script>
<script src="/static/libs/bootstrap/bootstrap.bundle.min.js"></script>
<script src="/static/js/production/qc_report_common.js"></script>
<script src="/static/js/production/dongtai_report.js"></script>
<script src="/static/js/wechat-pc-table-fix.js"></script>

<!-- è°ƒè¯•ä¿¡æ¯å·²æ¸…ç† -->
<style>
    .page-container {
        padding: 20px;
        width: 100%;
        margin: 0 auto;
    }
    
    /* PCç«¯æ ·å¼ - å……æ»¡æ•´ä¸ªå±å¹• */
    @media (min-width: 1024px) {
        .page-container {
            max-width: none;
            padding: 20px 40px;
        }
        .filter-row {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }
        .table-container {
            margin-left: 0;
            margin-right: 0;
        }
        /* PCç«¯è¡¨æ ¼ä¼˜åŒ– */
        table {
            min-width: 100%;
            font-size: 15px;
        }
        th, td {
            padding: 14px 18px;
            font-size: 15px;
        }
        th {
            font-size: 16px;
            font-weight: 600;
        }
        /* è®©è¡¨æ ¼åˆ—å®½æ›´åˆç†åˆ†å¸ƒ */
        th:nth-child(1), td:nth-child(1) { width: 6%; } /* æ“ä½œäºº */
        th:nth-child(2), td:nth-child(2) { width: 5%; } /* æ—¥æœŸ */
        th:nth-child(3), td:nth-child(3) { width: 4%; } /* æ—¶é—´ */
        th:nth-child(7), td:nth-child(7) { width: 6%; } /* äº§å“å‹å· */
        th:nth-child(29), td:nth-child(29) { width: 4%; } /* æ°´åˆ†(%) */
        th:nth-child(30), td:nth-child(30) { width: 4%; } /* è¢‹æ•° */
        th:nth-child(31), td:nth-child(31) { width: 5%; } /* åŒ…è£…ç±»å‹ */
        th:nth-child(35), td:nth-child(35) { width: 4%; } /* ç­ç»„ */
        th:nth-child(36), td:nth-child(36) { width: 6%; } /* æ“ä½œ */
    }
    
    /* å¹³æ¿ç«¯æ ·å¼ */
    @media (min-width: 769px) and (max-width: 1023px) {
        .page-container {
            max-width: 1200px;
            padding: 20px 30px;
        }
    }
    
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .page-title h1 {
        margin: 0;
        font-size: 24px;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .filter-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .filter-group {
        margin-bottom: 15px;
    }
    
    /* åªä¿ç•™æœ€åŸºæœ¬çš„æ ·å¼ï¼Œåˆ é™¤æ‰€æœ‰å¯èƒ½å†²çªçš„CSS */
    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        -webkit-appearance: none;
        appearance: none;
    }
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        min-height: 44px;
        white-space: nowrap;
    }
    .btn-primary {
        background: linear-gradient(90deg, #81d4fa 0%, #a5d6a7 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #4fc3f7 0%, #66bb6a 100%);
        transform: translateY(-1px);
    }
    .btn-secondary {
        background: #e3f2fd;
        color: #1976d2;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-secondary:hover {
        background: #b3e5fc;
        transform: translateY(-1px);
    }
    .material-icons {
        vertical-align: middle;
        font-size: 20px;
        margin-right: 8px;
    }
    .table-container {
        margin-top: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
        font-size: 14px;
    }
    th {
        background: #f5f5f5;
        font-weight: 500;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    tr:hover {
        background: #fafafa;
    }
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 10px;
    }
    .pagination button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .pagination button:hover {
        background: #f0f0f0;
    }
    .pagination button.current-page {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .action-buttons-cell {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        min-height: auto;
    }
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    .btn-danger:hover {
        background-color: #c82333;
    }
    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin: 20px 0 15px 0;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }
    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px;
    }
    .form-group {
        padding: 0 15px;
        margin-bottom: 20px;
    }
    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
    .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
    }
    .col-md-12 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .clear-btn .material-icons {
        font-size: 16px;
        margin: 0;
    }
    .input-clear-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-clear-wrapper input.form-control {
        padding-right: 28px;
    }
    .input-clear-btn {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border: none;
        background: transparent;
        color: #bbb;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        cursor: pointer;
        border-radius: 50%;
        transition: background 0.2s, color 0.2s;
    }
    .input-clear-btn:hover {
        background: #e0e0e0;
        color: #333;
    }
    .input-clear-btn svg {
        width: 14px;
        height: 14px;
        display: block;
    }
    @media (max-width: 768px) {
        .col-md-6, .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-title">
        <h1>ä¸œæ³°QCæŠ¥è¡¨å†å²è®°å½•</h1>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='{% url 'dongtai_report' %}'">
                <span class="material-icons">arrow_back</span> è¿”å›
            </button>
            <button class="btn btn-primary" onclick="exportToExcel()">
                <span class="material-icons">file_download</span> å¯¼å‡ºExcel
            </button>
        </div>
    </div>

    <div class="filter-container">
        <form id="filterForm">
            {% csrf_token %}
            <div class="filter-row">
                <div class="filter-group">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                    <div class="input-clear-wrapper">
                        <input type="text" id="startDate" name="start_date" class="form-control">
                        <button type="button" class="input-clear-btn" onclick="clearInput('startDate')" title="æ¸…ç©º">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" fill="#f5f5f5"/><path d="M7 7l6 6M13 7l-6 6" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                    <div class="input-clear-wrapper">
                        <input type="text" id="endDate" name="end_date" class="form-control">
                        <button type="button" class="input-clear-btn" onclick="clearInput('endDate')" title="æ¸…ç©º">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" fill="#f5f5f5"/><path d="M7 7l6 6M13 7l-6 6" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="startTime">å¼€å§‹æ—¶é—´</label>
                    <div class="input-clear-wrapper">
                        <input type="text" id="startTime" name="start_time" class="form-control" placeholder="HH:MM">
                        <button type="button" class="input-clear-btn" onclick="clearInput('startTime')" title="æ¸…ç©º">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" fill="#f5f5f5"/><path d="M7 7l6 6M13 7l-6 6" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="endTime">ç»“æŸæ—¶é—´</label>
                    <div class="input-clear-wrapper">
                        <input type="text" id="endTime" name="end_time" class="form-control" placeholder="HH:MM">
                        <button type="button" class="input-clear-btn" onclick="clearInput('endTime')" title="æ¸…ç©º">
                            <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="9" fill="#f5f5f5"/><path d="M7 7l6 6M13 7l-6 6" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="product_name">äº§å“å‹å·</label>
                    <input type="text" id="product_name" name="product_name" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="packaging">åŒ…è£…ç±»å‹</label>
                    <input type="text" id="packaging" name="packaging" class="form-control" list="packaging_list">
                    <datalist id="packaging_list"></datalist>
                </div>
                <div class="filter-group">
                    <label for="squad">ç­ç»„</label>
                    <input type="text" id="squad" name="squad" class="form-control">
                </div>
            </div>
            <div class="filter-group button-group" id="buttonGroup">
                <button class="btn btn-primary" type="submit">
                    <i class="material-icons">search</i>
                    æœç´¢
                </button>
                <button class="btn btn-secondary" type="button" onclick="resetFilters()">
                    <i class="material-icons">refresh</i>
                    é‡ç½®
                </button>
                <button class="btn btn-secondary" type="button" onclick="exportToExcel()">
                    <i class="material-icons">download</i>
                    å¯¼å‡ºExcel
                </button>
                <button class="btn btn-secondary" type="button" onclick="calculateYesterdayProduction()">
                    <i class="material-icons">analytics</i>
                    ç»Ÿè®¡æ˜¨æ—¥äº§é‡
                </button>
                <button class="btn btn-secondary" type="button" onclick="calculateTodayProduction()">
                    <i class="material-icons">analytics</i>
                    ç»Ÿè®¡ä»Šæ—¥äº§é‡
                </button>


            </div>
            

            
            <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸå·²æ¸…ç† -->
        </form>
    </div>

    <div class="sticky-table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>æ“ä½œäºº</th>
                    <th>æ—¥æœŸ</th>
                    <th>æ—¶é—´</th>
                    <th>å¹²ç‡¥ååŸåœŸæ°´åˆ†(%)</th>
                    <th>å…¥çª‘å‰ç¢±å«é‡(%)</th>
                    <th>åŠ©æº¶å‰‚æ·»åŠ æ¯”ä¾‹</th>
                    <th>äº§å“å‹å·</th>
                    <th>è¿œé€šæ¸—é€ç‡(Darcy)</th>
                    <th>é•¿å¯Œæ¸—é€ç‡(Darcy)</th>
                    <th>è¿‡æ»¤æ—¶é—´(ç§’)</th>
                    <th>æ°´é»åº¦(mPa.s)</th>
                    <th>é¥¼åš(mm)</th>
                    <th>é¥¼å¯†åº¦(g/cm3)</th>
                    <th>è¿œé€šé¥¼å¯†åº¦(g/cm3)</th>
                    <th>é•¿å¯Œé¥¼å¯†åº¦(g/cm3)</th>
                    <th>æŒ¯å®å¯†åº¦(g/cm3)</th>
                    <th>+14M</th>
                    <th>+30M</th>
                    <th>+40M</th>
                    <th>+80M</th>
                    <th>+100M</th>
                    <th>+150M</th>
                    <th>+200M</th>
                    <th>+325M</th>
                    <th>Feç¦»å­</th>
                    <th>Caç¦»å­</th>
                    <th>Alç¦»å­</th>
                    <th>ç™½åº¦</th>
                    <th>æ¶¡å€¼(cm)</th>
                    <th>æ°”å‘³</th>
                    <th>ç”µå¯¼å€¼(ms/cm)</th>
                    <th>pH</th>
                    <th>å¸æ²¹ç‡(%)</th>
                    <th>å¸æ°´ç‡(%)</th>
                    <th>æ°´åˆ†(%)</th>
                    <th>è¢‹æ•°</th>
                    <th>åŒ…è£…ç±»å‹</th>
                    <th>å¨æ•°</th>
                    <th>LOTæ‰¹å·</th>
                    <th>å¤‡æ³¨</th>
                    <th>ç­ç»„</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="reportTableBody">
                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>

    <div class="pagination" id="pagination">
        <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
    

</div>

{% block scripts %}
<script>
function clearInput(id) {
    const el = document.getElementById(id);
    if (el && el._flatpickr) {
        el._flatpickr.clear();
    } else if (el) {
        el.value = '';
    }
}
// ç‹¬ç«‹jså·²è‡ªåŠ¨åˆå§‹åŒ–ï¼Œæ— éœ€initQCReport





// ç¡®ä¿calculateYesterdayProductionå‡½æ•°æ€»æ˜¯å¯ç”¨çš„
window.calculateYesterdayProduction = async function() {
    try {
                        // æ­£åœ¨ç»Ÿè®¡æ˜¨æ—¥äº§é‡æ•°æ®...
        const response = await fetch('/api/dongtai-report/?action=yesterday_production', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success') {
                displayYesterdayProductionTable(result);
            } else {
                alert('ç»Ÿè®¡å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } else {
            alert('è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
        }
    } catch (error) {
        // ç»Ÿè®¡å¼‚å¸¸ï¼šerror
        alert('ç»Ÿè®¡å¼‚å¸¸ï¼š' + error.message);
    }
};

// ç¡®ä¿calculateTodayProductionå‡½æ•°æ€»æ˜¯å¯ç”¨çš„
window.calculateTodayProduction = async function() {
    try {
                        // æ­£åœ¨ç»Ÿè®¡ä»Šæ—¥äº§é‡æ•°æ®...
        const response = await fetch('/api/dongtai-report/?action=today_production', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'success') {
                displayTodayProductionTable(result);
            } else {
                alert('ç»Ÿè®¡å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } else {
            alert('è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
        }
    } catch (error) {
        // ç»Ÿè®¡å¼‚å¸¸ï¼šerror
        alert('ç»Ÿè®¡å¼‚å¸¸ï¼š' + error.message);
    }
};

// æ˜¾ç¤ºæ˜¨æ—¥äº§é‡ç»Ÿè®¡è¡¨æ ¼
function displayYesterdayProductionTable(result) {
    const { data, date, total_groups } = result;

    if (!data || data.length === 0) {
        alert(`${date} æ²¡æœ‰æ‰¾åˆ°äº§é‡æ•°æ®`);
        return;
    }

    // æŒ‰ç­ç»„åˆ†ç»„æ•°æ®
    const groupedData = {};
    data.forEach(item => {
        const shift = item.shift || 'æœªè®¾ç½®';
        if (!groupedData[shift]) {
            groupedData[shift] = [];
        }
        groupedData[shift].push(item);
    });

    // åˆ›å»ºè¡¨æ ¼HTML
    let html = `
        <div style="max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                <h2 style="color: #1976d2; margin: 0; font-size: 24px;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                    ${date} æ˜¨æ—¥äº§é‡ç»Ÿè®¡
                </h2>
                <div>
                    <button onclick="exportYesterdayProductionToExcel()" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
                        å¯¼å‡ºExcel
                    </button>
                    <button onclick="closeProductionModal()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">close</span>
                        å…³é—­
                    </button>
                </div>
            </div>

            <p style="color: #666; margin-bottom: 20px; text-align: center; flex-shrink: 0;">
                å…±æ‰¾åˆ° ${total_groups} ä¸ªç­ç»„äº§å“ç»„åˆ
            </p>

            <div style="overflow: auto; flex: 1; min-height: 0;">
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px; font-family: Arial, sans-serif;">
                    <thead>
                        <tr style="background: #1976d2; color: white; border: 1px solid #1565c0;">
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 80px; background: #1976d2;">ç­ç»„</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">äº§å“</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">åŒ…è£…</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">æ‰¹å·</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">å¤‡æ³¨</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">äº§é‡(å¨)</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">ç­ç»„äº§é‡(å¨)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    let totalTons = 0;
    let rowCount = 0;

    // éå†æ¯ä¸ªç­ç»„
    Object.keys(groupedData).forEach(shift => {
        const shiftData = groupedData[shift];
        let shiftTotal = 0;

        // è®¡ç®—ç­ç»„æ€»äº§é‡
        shiftData.forEach(item => {
            shiftTotal += parseFloat(item.total_tons) || 0;
        });

        // ä¸ºç­ç»„ä¸­çš„æ¯ä¸ªäº§å“åˆ›å»ºè¡Œ
        shiftData.forEach((item, index) => {
            const tons = parseFloat(item.total_tons) || 0;
            totalTons += tons;
            rowCount++;

            const isFirstRow = index === 0;
            const rowStyle = rowCount % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';

            if (isFirstRow) {
                // ç¬¬ä¸€è¡Œï¼šåŒ…å«åˆå¹¶çš„ç­ç»„å’Œç­ç»„äº§é‡å•å…ƒæ ¼
                html += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #1976d2; vertical-align: middle;" rowspan="${shiftData.length}">
                            ${shift}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.product_name || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.packaging || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.batch_number || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.remarks && item.remarks !== '' ? item.remarks : 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #4caf50;">${tons.toFixed(3)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #1976d2; background: #e3f2fd; vertical-align: middle;" rowspan="${shiftData.length}">
                            ${shiftTotal.toFixed(3)}
                        </td>
                    </tr>
                `;
            } else {
                // åç»­è¡Œï¼šä¸åŒ…å«åˆå¹¶çš„å•å…ƒæ ¼
                html += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.product_name || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.packaging || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.batch_number || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.remarks && item.remarks !== '' ? item.remarks : 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #4caf50;">${tons.toFixed(3)}</td>
                    </tr>
                `;
            }
        });
    });

    // æ·»åŠ æ€»è®¡è¡Œ
    html += `
                        <tr style="background: linear-gradient(135deg, #4caf50, #45a049); color: white; font-weight: 600;">
                            <td colspan="5" style="padding: 12px; border: 1px solid #45a049; text-align: center;">æ€»è®¡</td>
                            <td style="padding: 12px; border: 1px solid #45a049; text-align: center; font-size: 16px;">${totalTons.toFixed(3)}</td>
                            <td style="padding: 12px; border: 1px solid #45a049; text-align: center; font-size: 16px;">${totalTons.toFixed(3)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºç»“æœ
    const modal = document.createElement('div');
    modal.id = 'productionModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
        box-sizing: border-box;
    `;
    modal.innerHTML = html;

    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(modal);

    // ä¿å­˜æ•°æ®ç”¨äºå¯¼å‡º
    window.yesterdayProductionData = {
        date: date,
        data: data,
        groupedData: groupedData,
        totalTons: totalTons,
        totalGroups: total_groups
    };
};

// å¯¼å‡ºæ˜¨æ—¥äº§é‡åˆ°Excel
async function exportYesterdayProductionToExcel() {
    try {
        console.log('å¼€å§‹å¯¼å‡ºä¸œæ³°æ˜¨æ—¥äº§é‡Excel...');
        const exportUrl = '/dongtai_report/export_yesterday_production/';
        
        // ä½¿ç”¨ä¸ä»Šæ—¥äº§é‡ç›¸åŒçš„ä¸‹è½½æ–¹å¼ï¼ˆå·²éªŒè¯å¯ä»¥å·¥ä½œï¼‰
        console.log('ä½¿ç”¨ä¸ä»Šæ—¥äº§é‡ç›¸åŒçš„ä¸‹è½½æ–¹å¼');
        
        const response = await fetch(exportUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // æ£€æŸ¥å“åº”å¤´
        const contentType = response.headers.get('content-type');
        console.log('å“åº”Content-Type:', contentType);
        
        // è·å–æ–‡ä»¶å†…å®¹
        const blob = await response.blob();
        console.log('æ–‡ä»¶å¤§å°:', blob.size, 'å­—èŠ‚');
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (blob.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
            console.warn('æ–‡ä»¶MIMEç±»å‹ä¸åŒ¹é…:', blob.type);
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = 'ä¸œæ³°æ˜¨æ—¥äº§é‡ç»Ÿè®¡_' + new Date().toISOString().split('T')[0] + '.xlsx';
        downloadLink.style.display = 'none';
        
        // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ä¸‹è½½
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // æ¸…ç†URLå¯¹è±¡
        setTimeout(() => {
            URL.revokeObjectURL(downloadUrl);
        }, 1000);
        
        console.log('Excelå¯¼å‡ºå®Œæˆ');
        
    } catch (error) {
        console.error('å¯¼å‡ºæ˜¨æ—¥äº§é‡å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
}

// æ˜¾ç¤ºä»Šæ—¥äº§é‡ç»Ÿè®¡è¡¨æ ¼
function displayTodayProductionTable(result) {
    const { data, date, total_groups } = result;

    if (!data || data.length === 0) {
        alert(`${date} æ²¡æœ‰æ‰¾åˆ°äº§é‡æ•°æ®`);
        return;
    }

    // æŒ‰ç­ç»„åˆ†ç»„æ•°æ®
    const groupedData = {};
    data.forEach(item => {
        const shift = item.shift || 'æœªè®¾ç½®';
        if (!groupedData[shift]) {
            groupedData[shift] = [];
        }
        groupedData[shift].push(item);
    });

    // åˆ›å»ºè¡¨æ ¼HTML
    let html = `
        <div style="max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                <h2 style="color: #1976d2; margin: 0; font-size: 24px;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                    ${date} ä»Šæ—¥äº§é‡ç»Ÿè®¡
                </h2>
                <div>
                    <button onclick="exportTodayProductionToExcel()" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">download</span>
                        å¯¼å‡ºExcel
                    </button>
                    <button onclick="closeProductionModal()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">close</span>
                        å…³é—­
                    </button>
                </div>
            </div>

            <p style="color: #666; margin-bottom: 20px; text-align: center; flex-shrink: 0;">
                å…±æ‰¾åˆ° ${total_groups} ä¸ªç­ç»„äº§å“ç»„åˆ
            </p>

            <div style="overflow: auto; flex: 1; min-height: 0;">
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px; font-family: Arial, sans-serif;">
                    <thead>
                        <tr style="background: #1976d2; color: white; border: 1px solid #1565c0;">
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 80px; background: #1976d2;">ç­ç»„</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">äº§å“</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">åŒ…è£…</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">æ‰¹å·</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 120px; background: #1976d2;">å¤‡æ³¨</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">äº§é‡(å¨)</th>
                            <th style="padding: 12px; border: 1px solid #1565c0; text-align: center; font-weight: 600; min-width: 100px; background: #1976d2;">ç­ç»„äº§é‡(å¨)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    let totalTons = 0;
    let rowCount = 0;

    // éå†æ¯ä¸ªç­ç»„
    Object.keys(groupedData).forEach(shift => {
        const shiftData = groupedData[shift];
        let shiftTotal = 0;
        shiftData.forEach(item => { shiftTotal += parseFloat(item.total_tons) || 0; });

        shiftData.forEach((item, index) => {
            const tons = parseFloat(item.total_tons) || 0;
            const isFirstRow = index === 0;
            const rowStyle = rowCount % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';

            if (isFirstRow) {
                html += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #1976d2; vertical-align: middle;" rowspan="${shiftData.length}">
                            ${shift}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.product_name || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.packaging || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.batch_number || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.remarks && item.remarks !== '' ? item.remarks : 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #4caf50;">${tons.toFixed(3)}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #1976d2; background: #e3f2fd; vertical-align: middle;" rowspan="${shiftData.length}">
                            ${shiftTotal.toFixed(3)}
                        </td>
                    </tr>
                `;
            } else {
                html += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.product_name || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.packaging || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.batch_number || 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.remarks && item.remarks !== '' ? item.remarks : 'æœªè®¾ç½®'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: 600; color: #4caf50;">${tons.toFixed(3)}</td>
                    </tr>
                `;
            }
            totalTons += tons;
            rowCount++;
        });
    });

    // æ·»åŠ æ€»è®¡è¡Œ
    html += `
        <tr style="background: #4caf50; color: white; font-weight: bold;">
            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;" colspan="5">æ€»è®¡</td>
            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${totalTons.toFixed(3)}</td>
            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${totalTons.toFixed(3)}</td>
        </tr>
    `;

    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;

    // åˆ›å»ºæ¨¡æ€æ¡†å¹¶æ˜¾ç¤º
    const modal = document.createElement('div');
    modal.id = 'productionModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
    `;
    modal.innerHTML = html;
    document.body.appendChild(modal);

    // ä¿å­˜æ•°æ®ä¾›å¯¼å‡ºä½¿ç”¨
    window.todayProductionData = { date, groupedData, totalTons };
};

// å¯¼å‡ºä»Šæ—¥äº§é‡ç»Ÿè®¡åˆ°Excel
async function exportTodayProductionToExcel() {
    try {
        console.log('å¼€å§‹å¯¼å‡ºä¸œæ³°ä»Šæ—¥äº§é‡Excel...');
        const exportUrl = '/dongtai_report/export_today_production/';
        
        // ä½¿ç”¨ä¸æµ‹è¯•é¡µé¢ç›¸åŒçš„ä¸‹è½½æ–¹å¼ï¼ˆå·²éªŒè¯å¯ä»¥å·¥ä½œï¼‰
        console.log('ä½¿ç”¨æµ‹è¯•é¡µé¢ç›¸åŒçš„ä¸‹è½½æ–¹å¼');
        
        const response = await fetch(exportUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // æ£€æŸ¥å“åº”å¤´
        const contentType = response.headers.get('content-type');
        console.log('å“åº”Content-Type:', contentType);
        
        // è·å–æ–‡ä»¶å†…å®¹
        const blob = await response.blob();
        console.log('æ–‡ä»¶å¤§å°:', blob.size, 'å­—èŠ‚');
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (blob.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
            console.warn('æ–‡ä»¶MIMEç±»å‹ä¸åŒ¹é…:', blob.type);
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = 'ä¸œæ³°ä»Šæ—¥äº§é‡ç»Ÿè®¡_' + new Date().toISOString().split('T')[0] + '.xlsx';
        downloadLink.style.display = 'none';
        
        // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ä¸‹è½½
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // æ¸…ç†URLå¯¹è±¡
        setTimeout(() => {
            URL.revokeObjectURL(downloadUrl);
        }, 1000);
        
        console.log('Excelå¯¼å‡ºå®Œæˆ');
        
    } catch (error) {
        console.error('å¯¼å‡ºä»Šæ—¥äº§é‡å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
};

// æ˜¾ç¤ºç§»åŠ¨ç«¯ä¸‹è½½é“¾æ¥
function showMobileDownloadLink(exportUrl) {
    const modalHTML = `
        <div id="downloadModal" style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,0.5);display: flex;justify-content: center;align-items: center;z-index: 10000;">
            <div style="background: white;padding: 20px;border-radius: 8px;max-width: 90%;width: 400px;text-align: center;box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="margin-top: 0; color: #333;">Excelå¯¼å‡º</h3>
                <p style="color: #666; margin: 15px 0;">ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ä¸‹è½½Excelæ–‡ä»¶ï¼š</p>
                <a href="${exportUrl}" target="_blank" style="display: inline-block;background: #4CAF50;color: white;padding: 12px 24px;text-decoration: none;border-radius: 4px;margin: 10px 0;font-weight: bold;">ğŸ“¥ ä¸‹è½½Excelæ–‡ä»¶</a>
                <div style="margin-top: 15px;"><button onclick="closeMobileDownloadModal()" style="background: #f5f5f5;border: 1px solid #ddd;padding: 8px 16px;border-radius: 4px;cursor: pointer;">å…³é—­</button></div>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">ğŸ’¡ æç¤ºï¼šæ–‡ä»¶å°†ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡ä¸‹è½½æ–‡ä»¶å¤¹</p>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// å…³é—­ç§»åŠ¨ç«¯ä¸‹è½½æ¨¡æ€æ¡†
function closeMobileDownloadModal() {
    const modal = document.getElementById('downloadModal');
    if (modal) modal.remove();
}

// åŸæœ‰çš„å¯¼å‡ºæ–¹å¼ï¼ˆä½œä¸ºå›é€€ï¼‰
function performLegacyExport(exportUrl) {
    console.log('ä½¿ç”¨å›é€€å¯¼å‡ºæ–¹å¼ï¼ŒURL:', exportUrl);
    
    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        showMobileDownloadLink(exportUrl);
    } else {
        // å°è¯•ä½¿ç”¨å¢å¼ºç‰ˆä¿å­˜å¯¹è¯æ¡†
        if (typeof window.enhancedExportWithSaveDialog === 'function') {
            console.log('ä½¿ç”¨å¢å¼ºç‰ˆä¿å­˜å¯¹è¯æ¡†');
            // å…ˆè·å–æ–‡ä»¶å†…å®¹ï¼Œç„¶åä½¿ç”¨ä¿å­˜å¯¹è¯æ¡†
            fetch(exportUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const fileName = 'ä¸œæ³°QCæŠ¥è¡¨_' + new Date().toISOString().split('T')[0] + '.xlsx';
                    window.enhancedExportWithSaveDialog(blob, fileName);
                })
                .catch(error => {
                    console.error('è·å–æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼:', error);
                    // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
                    const link = document.createElement('a');
                    link.href = exportUrl;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert('Excelå¯¼å‡ºå·²å¼€å§‹ï¼Œè¯·ç¨å€™...');
                });
        } else {
            // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
            const link = document.createElement('a');
            link.href = exportUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Excelå¯¼å‡ºå·²å¼€å§‹ï¼Œè¯·ç¨å€™...');
        }
    }
}

// å…³é—­äº§é‡ç»Ÿè®¡æ¨¡æ€æ¡†
function closeProductionModal() {
    // æŸ¥æ‰¾æ¨¡æ€æ¡†å¹¶å…³é—­
    const modal = document.getElementById('productionModal');
    if (modal) {
        modal.remove();
    }
}

// åŠ è½½SheetJSåº“
function loadSheetJS() {
    return new Promise((resolve, reject) => {
        if (typeof XLSX !== 'undefined') {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // æµ‹è¯•JavaScriptå‡½æ•°æ˜¯å¦åŠ è½½
    // é¡µé¢è„šæœ¬åŠ è½½å®Œæˆ
    if (typeof calculateYesterdayProduction === 'function') {
        // calculateYesterdayProduction å‡½æ•°å·²åŠ è½½
    } else {
        // calculateYesterdayProduction å‡½æ•°æœªåŠ è½½
    }

    // ç»‘å®šç­›é€‰è¡¨å•æäº¤äº‹ä»¶ï¼Œç­›é€‰æ—¶åŠ è½½ç¬¬ä¸€é¡µ
    bindFilterFormSubmit('filterForm', function(page) {
        loadDongtaiHistoryData(page);
    });
    // åˆå§‹åŒ–ç¬¬ä¸€é¡µå†å²æ•°æ®
    loadDongtaiHistoryData(1);
});




</script>
{% endblock %}
{% endblock %}
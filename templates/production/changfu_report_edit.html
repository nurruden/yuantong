{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/icon-alignment-fix.css' %}">
<link rel="stylesheet" href="/static/libs/flatpickr/flatpickr.min.css">
<link rel="stylesheet" href="/static/libs/flatpickr/material_blue.css">
<script src="/static/libs/flatpickr/flatpickr.min.js"></script>
<script src="/static/libs/flatpickr/zh.js"></script>
<script src="/static/libs/autocomplete/autoComplete.min.js"></script>
<style>
    .page-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .page-title h1 {
        margin: 0;
        font-size: 24px;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .form-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        -webkit-appearance: none;
        appearance: none;
    }
    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    input[type="number"].form-control {
        -moz-appearance: textfield;
    }
    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        min-height: 44px;
        white-space: nowrap;
    }
    .btn-primary {
        background: linear-gradient(90deg, #81d4fa 0%, #a5d6a7 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-primary:hover {
        background: linear-gradient(90deg, #4fc3f7 0%, #66bb6a 100%);
        transform: translateY(-1px);
    }
    .btn-secondary {
        background: #e3f2fd;
        color: #1976d2;
        box-shadow: 0 2px 8px rgba(129,212,250,0.08);
    }
    .btn-secondary:hover {
        background: #b3e5fc;
        transform: translateY(-1px);
    }
    .material-icons {
        vertical-align: middle;
        font-size: 20px;
        margin-right: 8px;
    }
    .section-title {
        margin: 20px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
        color: #1976d2;
        font-size: 18px;
    }
    .error-message {
        color: #d32f2f;
        margin-top: 5px;
        font-size: 14px;
    }
    /* 自动完成样式 */
    .autoComplete_wrapper {
        width: 100%;
    }
    .autoComplete_wrapper > input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    .autoComplete_wrapper > ul {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
    }
    .autoComplete_wrapper > ul > li {
        padding: 8px 12px;
        cursor: pointer;
    }
    .autoComplete_wrapper > ul > li:hover {
        background: #f5f5f5;
    }
    .autoComplete_wrapper > ul > li mark {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0;
    }
    /* 暗色模式支持 */
    @media (prefers-color-scheme: dark) {
        body {
            background: #121212;
            color: #fff;
        }
        .form-container {
            background: #1e1e1e;
        }
        .form-control {
            background: #2d2d2d;
            border-color: #404040;
            color: #fff;
        }
        .form-group label {
            color: #e0e0e0;
        }
        .section-title {
            color: #81d4fa;
            border-bottom-color: #404040;
        }
    }
    /* 移动端适配 */
    @media (max-width: 768px) {
        .page-container {
            padding: 10px;
        }
        .page-title {
            flex-direction: column;
            align-items: stretch;
        }
        .page-title h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        .action-buttons {
            justify-content: center;
        }
        .form-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .form-group label {
            font-size: 16px;
        }
        .form-control {
            font-size: 16px;
            padding: 12px;
        }
        .btn {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-title">
        <h1>编辑长富QC报表</h1>
        <div class="action-buttons">
            <a class="btn btn-secondary" href="{% url 'changfu_report_history' %}">
                <span class="material-icons">arrow_back</span> 返回
            </a>
        </div>
    </div>

    <div class="form-container">
        <form id="editForm" action="" method="post">
            {% csrf_token %}
            <input type="hidden" id="reportId" value="{{ report.id }}">

            <!-- 基本信息 -->
            <h3 class="section-title">基本信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="date">日期<span style="color:red">*</span></label>
                    <input type="text" id="date" name="date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="time">时间<span style="color:red">*</span></label>
                    <input type="text" id="time" name="time" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="moisture_after_drying">烘干后原土水分(%)</label>
                    <input type="number" id="moisture_after_drying" name="moisture_after_drying" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="alkali_content">入窑前碱含量(%)</label>
                    <input type="number" id="alkali_content" name="alkali_content" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="flux">助熔剂添加比例</label>
                    <input type="text" id="flux" name="flux" class="form-control">
                </div>
                <div class="form-group">
                    <label for="product_name">产品型号<span style="color:red">*</span></label>
                    <div class="autoComplete_wrapper">
                        <input type="text" id="product_name" name="product_name" class="form-control" required autocomplete="off">
                    </div>
                </div>
            </div>

            <!-- 渗透测试 -->
            <h3 class="section-title">渗透测试</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="permeability">远通渗透率(Darcy)</label>
                    <input type="number" id="permeability" name="permeability" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="permeability_long">长富渗透率(Darcy)</label>
                    <input type="number" id="permeability_long" name="permeability_long" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="wet_cake_density">饼密度(g/cm3)</label>
                    <input type="number" id="wet_cake_density" name="wet_cake_density" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label for="bulk_density">振实密度(g/cm3)</label>
                    <input type="number" id="bulk_density" name="bulk_density" class="form-control" step="0.001">
                </div>
            </div>

            <!-- 筛分数据 -->
            <h3 class="section-title">筛分数据</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_14m">+14M (%)</label>
                    <input type="number" id="sieving_14m" name="sieving_14m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_30m">+30M (%)</label>
                    <input type="number" id="sieving_30m" name="sieving_30m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_40m">+40M</label>
                    <input type="number" id="sieving_40m" name="sieving_40m" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="sieving_80m">+80M</label>
                    <input type="number" id="sieving_80m" name="sieving_80m" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sieving_100m">+100M</label>
                    <input type="text" id="sieving_100m" name="sieving_100m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_150m">+150M</label>
                    <input type="text" id="sieving_150m" name="sieving_150m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_200m">+200M</label>
                    <input type="text" id="sieving_200m" name="sieving_200m" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sieving_325m">+325M</label>
                    <input type="text" id="sieving_325m" name="sieving_325m" class="form-control">
                </div>
            </div>

            <!-- 可溶性金属 -->
            <h3 class="section-title">可溶性金属</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="fe_ion">铁离子(mg/kg)</label>
                    <input type="number" id="fe_ion" name="fe_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="ca_ion">钙离子(mg/kg)</label>
                    <input type="number" id="ca_ion" name="ca_ion" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="al_ion">铝离子(mg/kg)</label>
                    <input type="number" id="al_ion" name="al_ion" class="form-control" step="0.01">
                </div>
            </div>

            <!-- 其他信息 -->
            <h3 class="section-title">其他信息</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="brightness">白度</label>
                    <input type="number" id="brightness" name="brightness" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="swirl">涡值(cm)</label>
                    <input type="number" id="swirl" name="swirl" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="odor">气味</label>
                    <input type="number" id="odor" name="odor" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="conductance">⚡电导值(ms/cm)</label>
                    <input type="number" id="conductance" name="conductance" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="ph">pH</label>
                    <input type="number" id="ph" name="ph" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="oil_absorption">吸油率(%)</label>
                    <input type="number" id="oil_absorption" name="oil_absorption" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="water_absorption">吸水率(%)</label>
                    <input type="number" id="water_absorption" name="water_absorption" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="moisture">水分(%)</label>
                    <input type="number" id="moisture" name="moisture" class="form-control" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bags">袋数<span style="color:red">*</span></label>
                    <input type="number" id="bags" name="bags" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="packaging">包装类型<span style="color:red">*</span></label>
                    <div class="autoComplete_wrapper">
                        <input type="text" id="packaging" name="packaging" class="form-control" required autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label for="tons">吨</label>
                    <input type="number" id="tons" name="tons" class="form-control" step="0.0001">
                </div>
                <div class="form-group">
                    <label for="batch_number">LOT批号</label>
                    <input type="text" id="batch_number" name="batch_number" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="grid-column: span 2;">
                    <label for="remarks">备注</label>
                    <input type="text" id="remarks" name="remarks" class="form-control">
                </div>
                <div class="form-group">
                    <label for="shift">班组<span style="color:red">*</span></label>
                    <select id="shift" name="shift" class="form-control" required>
                        <option value="1" {% if report.shift == '1' %}selected{% endif %}>1</option>
                        <option value="2" {% if report.shift == '2' %}selected{% endif %}>2</option>
                        <option value="3" {% if report.shift == '3' %}selected{% endif %}>3</option>
                    </select>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons">save</span> 保存数据
                </button>
            </div>
        </form>
    </div>
</div>

<script>
console.log('=== 长富编辑页面 Script 标签开始执行 ===');

// 页面和数据分离：页面加载后通过API获取数据并填充表单

document.addEventListener('DOMContentLoaded', function() {
    const reportIdElement = document.getElementById('reportId');
    const reportId = reportIdElement ? reportIdElement.value : null;
    if (!reportId) {
        alert('无法获取报告ID，请返回重试');
        window.location.href = '{% url "changfu_report_history" %}';
        return;
    }
    // 通过API获取报表详情
    fetch(`/api/changfu-report/${reportId}/`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const d = data.data;
                document.getElementById('date').value = d.date || '';
                document.getElementById('time').value = d.time || '';
                document.getElementById('moisture_after_drying').value = d.moisture_after_drying || '';
                document.getElementById('alkali_content').value = d.alkali_content || '';
                document.getElementById('flux').value = d.flux || '';
                document.getElementById('product_name').value = d.product_name || '';
                document.getElementById('permeability').value = d.permeability || '';
                document.getElementById('permeability_long').value = d.permeability_long || '';
                document.getElementById('wet_cake_density').value = d.wet_cake_density || '';
                document.getElementById('bulk_density').value = d.bulk_density || '';
                document.getElementById('sieving_14m').value = d.sieving_14m || '';
                document.getElementById('sieving_30m').value = d.sieving_30m || '';
                document.getElementById('sieving_40m').value = d.sieving_40m || '';
                document.getElementById('sieving_80m').value = d.sieving_80m || '';
                document.getElementById('sieving_100m').value = d.sieving_100m || '';
                document.getElementById('sieving_150m').value = d.sieving_150m || '';
                document.getElementById('sieving_200m').value = d.sieving_200m || '';
                document.getElementById('sieving_325m').value = d.sieving_325m || '';
                document.getElementById('fe_ion').value = d.fe_ion || '';
                document.getElementById('ca_ion').value = d.ca_ion || '';
                document.getElementById('al_ion').value = d.al_ion || '';
                document.getElementById('brightness').value = d.brightness || '';
                document.getElementById('swirl').value = d.swirl || '';
                document.getElementById('odor').value = d.odor || '';
                document.getElementById('conductance').value = d.conductance || '';
                document.getElementById('ph').value = d.ph || '';
                document.getElementById('oil_absorption').value = d.oil_absorption || '';
                document.getElementById('water_absorption').value = d.water_absorption || '';
                document.getElementById('moisture').value = d.moisture || '';
                document.getElementById('bags').value = d.bags || '';
                document.getElementById('packaging').value = d.packaging || '';
                document.getElementById('tons').value = d.tons || '';
                document.getElementById('batch_number').value = d.batch_number || '';
                document.getElementById('remarks').value = d.remarks || '';
                document.getElementById('shift').value = d.shift || '';
                // 重新初始化flatpickr，显示历史数据
                if (typeof flatpickr !== 'undefined') {
                    // 销毁原有实例
                    if (document.getElementById('date')._flatpickr) {
                        document.getElementById('date')._flatpickr.destroy();
                    }
                    if (document.getElementById('time')._flatpickr) {
                        document.getElementById('time')._flatpickr.destroy();
                    }
                    flatpickr('#date', {
                        dateFormat: 'Y-m-d',
                        locale: 'zh',
                        defaultDate: d.date || ''
                    });
                    flatpickr('#time', {
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: 'H:i',
                        time_24hr: true,
                        locale: 'zh',
                        defaultDate: d.time || ''
                    });
                }
            } else {
                alert('加载报表数据失败：' + (data.message || '未知错误'));
            }
        })
        .catch(err => {
            alert('加载报表数据出错：' + err);
        });

    // 获取CSRF token
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 初始化自动完成功能（简化版）
    if (typeof autoComplete !== 'undefined') {
        try {
            // 初始化产品型号自动完成（简化版，仅设置占位符）
            new autoComplete({
                selector: "#product_name",
                placeHolder: "请输入产品型号"
            });

            // 初始化包装类型自动完成（简化版，仅设置占位符）
            new autoComplete({
                selector: "#packaging",
                placeHolder: "请输入包装类型"
            });

            console.log('简化版自动完成功能初始化成功');
        } catch (error) {
            console.error('自动完成初始化失败:', error);
        }
    } else {
        console.warn('autoComplete库未加载');
    }

    // 数据已通过Django模板渲染，无需AJAX加载
    console.log('页面数据已通过Django模板加载');

    // 表单提交处理
    const editFormElement = document.getElementById('editForm');
    console.log('editForm元素:', editFormElement);

    if (!editFormElement) {
        console.error('未找到editForm表单元素！');
        return;
    }

    const fields = [
        'date', 'time', 'moisture_after_drying', 'alkali_content', 'flux', 'product_name',
        'permeability', 'permeability_long', 'wet_cake_density', 'bulk_density',
        'sieving_14m', 'sieving_30m', 'sieving_40m', 'sieving_80m', 'sieving_100m', 'sieving_150m',
        'sieving_200m', 'sieving_325m', 'fe_ion', 'ca_ion', 'al_ion', 'brightness',
        'swirl', 'odor', 'conductance', 'ph', 'oil_absorption', 'water_absorption',
        'moisture', 'bags', 'packaging', 'tons', 'batch_number', 'remarks', 'shift'
    ];

    editFormElement.addEventListener('submit', async function(e) {
        console.log('=== 表单提交事件触发 ===');
        e.preventDefault();

        const data = {};
        fields.forEach(field => {
            const el = document.getElementById(field);
            if (el) {
                data[field] = el.value; // 不跳过空字符串
            }
        });

        // 验证必填字段 - 只检查真正必需的字段
        const requiredFields = ['date', 'product_name', 'shift'];

        const missingFields = requiredFields.filter(field => {
            const element = document.getElementById(field);
            return !element || !element.value.trim();
        });

        if (missingFields.length > 0) {
            alert('请填写必填字段: ' + missingFields.join(', '));
            return;
        }

        // 验证数据对象不为空
        if (Object.keys(data).length === 0) {
            alert('没有收集到有效数据，请检查表单');
            return;
        }

        // 调试：打印收集到的数据
        console.log('收集到的数据:', data);
        console.log('数据字段数量:', Object.keys(data).length);
        console.log('JSON字符串:', JSON.stringify(data));

        // 如果没有收集到数据，发送一个最小的测试数据
        if (Object.keys(data).length === 0) {
            console.warn('没有收集到数据，使用测试数据');
            data = {
                date: document.getElementById('date')?.value || '2023-01-01',
                product_name: document.getElementById('product_name')?.value || 'TEST',
                shift: document.getElementById('shift')?.value || '1'
            };
            console.log('测试数据:', data);
        }

        try {
            const url = `/changfu-report-edit/${reportId}/`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Referer': window.location.href
                },
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            const result = await response.json();

            if (response.ok) {
                alert('保存成功');
                window.location.href = '{% url "changfu_report_history" %}';
            } else {
                alert('保存失败: ' + (result.message || '未知错误'));
            }
        } catch (error) {
            alert('保存失败，请稍后重试');
        }
    });

    // flatpickr日期和时间控件初始化
    if (typeof flatpickr !== 'undefined') {
        flatpickr('#date', {
            dateFormat: 'Y-m-d',
            locale: 'zh'
        });
        flatpickr('#time', {
            enableTime: true,
            noCalendar: true,
            dateFormat: 'H:i',
            time_24hr: true,
            locale: 'zh'
        });
    }
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    button { padding: 10px 15px; margin: 5px; }
    .error { color: red; }
    .success { color: green; }
    .info { color: blue; }
</style>
{% endblock %}

{% block content %}
<h1>远通二线调试页面</h1>

<div class="test-section">
    <h3>1. 测试API调用（无筛选条件）</h3>
    <button onclick="testAPI1()">测试所有数据</button>
    <div id="result1" class="result"></div>
</div>

<div class="test-section">
    <h3>2. 测试API调用（12:50-15:30时间筛选）</h3>
    <button onclick="testAPI2()">测试时间筛选</button>
    <div id="result2" class="result"></div>
</div>

<div class="test-section">
    <h3>3. 检查CSRF Token</h3>
    <button onclick="checkCSRF()">检查CSRF Token</button>
    <div id="result3" class="result"></div>
</div>

<div class="test-section">
    <h3>4. 检查用户信息</h3>
    <button onclick="checkUser()">检查当前用户</button>
    <div id="result4" class="result"></div>
</div>

<div class="test-section">
    <h3>5. 检查浏览器控制台错误</h3>
    <p>请打开浏览器开发者工具（F12），查看Console标签页是否有错误信息</p>
    <button onclick="checkConsole()">检查控制台</button>
    <div id="result5" class="result"></div>
</div>

<div class="test-section">
    <h3>6. 模拟前端筛选表单</h3>
    <form id="testFilterForm">
        <label>开始时间: <input type="text" name="start_time" value="12:50"></label><br>
        <label>结束时间: <input type="text" name="end_time" value="15:30"></label><br>
        <button type="button" onclick="testFilterForm()">测试筛选表单</button>
    </form>
    <div id="result6" class="result"></div>
</div>

<script>
    // 获取CSRF Token
    function getCSRFToken() {
        // 优先从表单隐藏字段获取
        const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (tokenElement) {
            return tokenElement.value;
        }
        // 再从cookie获取
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // 测试1: 无筛选条件
    async function testAPI1() {
        const resultDiv = document.getElementById('result1');
        resultDiv.innerHTML = '正在测试...';
        
        try {
            const response = await fetch('/api/yuantong2-report/?page=1&page_size=5', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                resultDiv.innerHTML = `
                    <div class="success"><strong>成功！</strong></div>
                    状态: ${result.status}<br>
                    总记录数: ${result.total_count}<br>
                    返回记录数: ${result.data ? result.data.length : 0}<br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } else {
                const errorText = await response.text();
                resultDiv.innerHTML = `<div class="error">失败: ${response.status} - ${response.statusText}<br>错误内容: ${errorText}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
        }
    }
    
    // 测试2: 时间筛选
    async function testAPI2() {
        const resultDiv = document.getElementById('result2');
        resultDiv.innerHTML = '正在测试...';
        
        try {
            const response = await fetch('/api/yuantong2-report/?start_time=12:50&end_time=15:30&page=1&page_size=5', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                resultDiv.innerHTML = `
                    <div class="success"><strong>成功！</strong></div>
                    状态: ${result.status}<br>
                    总记录数: ${result.total_count}<br>
                    返回记录数: ${result.data ? result.data.length : 0}<br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } else {
                const errorText = await response.text();
                resultDiv.innerHTML = `<div class="error">失败: ${response.status} - ${response.statusText}<br>错误内容: ${errorText}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
        }
    }
    
    // 检查CSRF Token
    function checkCSRF() {
        const resultDiv = document.getElementById('result3');
        const token = getCSRFToken();
        
        if (token) {
            resultDiv.innerHTML = `<div class="success">CSRF Token: ${token}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="error">未找到CSRF Token</div>`;
        }
    }
    
    // 检查用户信息
    function checkUser() {
        const resultDiv = document.getElementById('result4');
        resultDiv.innerHTML = `
            <div class="info">
                当前页面URL: ${window.location.href}<br>
                用户代理: ${navigator.userAgent}<br>
                Cookie: ${document.cookie}<br>
                当前时间: ${new Date().toLocaleString()}
            </div>
        `;
    }
    
    // 检查控制台
    function checkConsole() {
        const resultDiv = document.getElementById('result5');
        resultDiv.innerHTML = '请查看浏览器控制台（F12 -> Console）是否有错误信息';
    }
    
    // 测试筛选表单
    async function testFilterForm() {
        const resultDiv = document.getElementById('result6');
        resultDiv.innerHTML = '正在测试...';
        
        const form = document.getElementById('testFilterForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        for (const [key, value] of formData.entries()) {
            if (value.trim() !== '') {
                params.append(key, value);
            }
        }
        params.set('page', 1);
        params.set('page_size', 5);
        
        const apiUrl = `/api/yuantong2-report/?${params.toString()}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                resultDiv.innerHTML = `
                    <div class="success"><strong>成功！</strong></div>
                    API URL: ${apiUrl}<br>
                    状态: ${result.status}<br>
                    总记录数: ${result.total_count}<br>
                    返回记录数: ${result.data ? result.data.length : 0}<br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } else {
                const errorText = await response.text();
                resultDiv.innerHTML = `<div class="error">失败: ${response.status} - ${response.statusText}<br>错误内容: ${errorText}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">错误: ${error.message}</div>`;
        }
    }
    
    // 页面加载时自动检查
    window.onload = function() {
        checkCSRF();
        checkUser();
    };
</script>
{% endblock %}
